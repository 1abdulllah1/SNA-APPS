<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registration | CBT System</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* styles.css should contain base styles */
    /* Specific enhancements for registration page */
    .auth-container {
      max-width: 600px; /* Increased width for better layout */
      margin: 2rem auto;
      padding: 2.5rem; /* Increased padding */
      background: #ffffff;
      border-radius: 12px; /* Softer corners */
      box-shadow: 0 8px 25px rgba(0,0,0,0.1); /* Softer shadow */
      border: 1px solid #e0e0e0;
    }
    
    .form-header {
      text-align: center;
      margin-bottom: 2rem; /* Increased margin */
    }

    .form-header h1 {
        font-size: 2rem;
        color: var(--primary-blue);
        margin-bottom: 0.5rem;
    }

    .form-header p {
        font-size: 1rem;
        color: var(--text-medium);
    }
    
    .form-group {
      margin-bottom: 1.5rem; /* Increased spacing */
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px; /* Increased gap */
    }

    /* Make single column on smaller screens */
    @media (max-width: 600px) {
        .form-grid {
            grid-template-columns: 1fr;
        }
    }
    
    .error-message, .success-message-inline {
      font-size: 0.9rem;
      margin-top: 6px;
      display: block;
      padding: 8px;
      border-radius: 4px;
    }

    .error-message {
      color: var(--danger-red);
      background-color: #ffebee; /* Light red background */
      border: 1px solid var(--danger-red);
    }

    .success-message-inline {
        color: var(--success-green);
        background-color: #e8f5e9; /* Light green background */
        border: 1px solid var(--success-green);
        text-align: center;
    }
    
    .alternate-link {
      text-align: center;
      margin-top: 2rem;
      font-size: 0.95rem;
    }
    .alternate-link a {
        color: var(--primary-blue);
        font-weight: 500;
    }

    /* Profile Picture Upload Styling */
    .profile-picture-group {
        margin-bottom: 1.5rem;
        padding: 15px;
        border: 1px dashed #ccc;
        border-radius: 8px;
        background-color: #f9f9f9;
    }
    .profile-picture-group label {
        font-weight: 600;
        display: block;
        margin-bottom: 8px;
    }
    #profile_picture_preview_container {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-top: 10px;
    }
    #profile_picture_preview {
        width: 100px;
        height: 100px;
        border-radius: 50%; /* Circular preview */
        object-fit: cover;
        border: 2px solid #ddd;
        background-color: #e9ecef;
    }
    #profile_picture_preview.hidden {
        display: none;
    }
    #profile_picture_filename {
        font-size: 0.9em;
        color: #555;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }
    input[type="file"] {
        border: 1px solid #ccc;
        padding: 8px;
        border-radius: 4px;
        background-color: white;
        cursor: pointer;
    }
    input[type="file"]:hover {
        border-color: var(--primary-blue);
    }

    /* Password Strength Indicator */
    .password-strength {
        margin-top: 8px;
        height: 8px;
        background-color: #e0e0e0;
        border-radius: 4px;
        overflow: hidden;
    }
    .strength-bar {
        height: 100%;
        width: 0%;
        background-color: #e74c3c; /* Default weak */
        transition: width 0.3s ease-in-out, background-color 0.3s ease-in-out;
    }
    #passwordCriteria {
        display: block;
        font-size: 0.85em;
        color: var(--text-color-medium);
        margin-top: 5px;
    }

    /* Global success message styling (from dashboard.html, for consistency) */
    .success-message-modal {
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background-color: var(--success-green);
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        z-index: 1001;
        display: flex;
        align-items: center;
        gap: 10px;
        opacity: 0;
        transition: opacity 0.5s ease, top 0.5s ease;
    }
    .success-message-modal.show {
        opacity: 1;
        top: 50px;
    }
    .success-message-modal svg.checkmark {
        width: 24px;
        height: 24px;
        stroke-width: 3;
        stroke: white;
    }
    /* checkmark animation styles, ensure they are defined in your styles.css or here */
    @keyframes stroke { 100% { stroke-dashoffset: 0; } }
    @keyframes scale { 0%, 100% { transform: none; } 50% { transform: scale3d(1.1, 1.1, 1); } }
    @keyframes fill { 100% { box-shadow: inset 0px 0px 0px 30px #7ac142; } }

    /* New styles for error/status messages */
    .error-message.show, .success-message-inline.show {
        opacity: 1;
        transform: translateY(0);
    }
    .error-message {
        transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out;
        opacity: 0;
        transform: translateY(-10px);
    }

    #classLevelStatusMessage {
        font-size: 0.85rem;
        margin-top: 5px;
        padding: 5px 8px;
        border-radius: 4px;
        display: block;
        text-align: center;
        opacity: 0; /* Initially hidden */
        transition: opacity 0.3s ease-in-out;
    }
    #classLevelStatusMessage.loading {
        background-color: #e0f2f7; /* Light blue */
        color: #01579b; /* Darker blue */
        opacity: 1;
    }
    #classLevelStatusMessage.error {
        background-color: #ffebee; /* Light red */
        color: var(--danger-red);
        opacity: 1;
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="dashboard.html" class="logo">SNA CBT System</a>
      <ul class="nav-links" id="navLinksContainer">
         <!-- Navigation links will be dynamically inserted here by JS -->
      </ul>
    </nav>
  </header>
  <main>
    <div class="auth-container">
      <div class="form-header"> <h1 id="formTitle">Create Account</h1> <p id="formSubtitle">For authorized administrators only.</p> </div>
      <div id="globalFormError" class="error-message hidden" style="margin-bottom:1rem; text-align:left;"></div>
      <form id="registrationForm" enctype="multipart/form-data">
        <div class="form-group">
          <label for="role">Register As *</label>
          <select id="role" name="role" required onchange="toggleStudentFields()">
            <option value="teacher">Teacher</option>
            <option value="student">Student</option>
            <option value="admin">Admin</option>
          </select>
        </div>
        <div class="form-grid">
          <div class="form-group"> <label for="username">Username *</label> <input type="text" id="username" name="username" required> </div>
          <div class="form-group"> <label for="email">Email *</label> <input type="email" id="email" name="email" required> <span id="emailError" class="error-message hidden"></span> </div>
        </div>
        
        <div id="studentFields" class="hidden">
          <div class="form-group">
            <label for="admission_number">Admission Number *</label>
            <input type="text" id="admission_number" name="admission_number" placeholder="SNA/YY/001 (e.g. SNA/23/001)">
            <span id="admissionError" class="error-message hidden"></span>
          </div>
          <div class="form-group">
            <label for="class_level_id">Class Level *</label>
            <select id="class_level_id" name="class_level_id" required>
              <option value="">Loading Class Levels...</option>
              <!-- Class levels will be dynamically loaded here -->
            </select>
            <span id="classLevelError" class="error-message hidden"></span>
            <span id="classLevelStatusMessage"></span> <!-- New element for status -->
          </div>
          <div class="form-group profile-picture-group">
            <label for="profile_picture">Student Profile Picture (Optional)</label>
            <input type="file" id="profile_picture" name="profile_picture" accept="image/jpeg, image/png, image/gif">
            <div id="profile_picture_preview_container">
              <img id="profile_picture_preview" alt="Profile Preview" class="hidden">
              <span id="profile_picture_filename"></span>
            </div>
            <span id="pictureError" class="error-message hidden"></span>
          </div>
           <div class="form-grid">
              <div class="form-group"> <label for="dob">Date of Birth (Optional)</label> <input type="date" id="dob" name="dob"> </div>
              <div class="form-group"> <label for="gender">Gender (Optional)</label> <select id="gender" name="gender"> <option value="">Select Gender...</option> <option value="Male">Male</option> <option value="Female">Female</option> <option value="Other">Other</option></select> </div>
           </div>
        </div>
        
        <div class="form-group">
          <label for="password">Password *</label>
          <input type="password" id="password" name="password" placeholder="Create password" required oninput="checkPasswordStrength(this.value)">
          <div class="password-strength"> <div class="strength-bar"></div> <small id="passwordCriteria" class="text-muted">Min. 8 chars, 1 uppercase, 1 number, 1 symbol.</small> </div>
        </div>
        <div class="form-group"> <label for="password_confirm">Confirm Password *</label> <input type="password" id="password_confirm" name="password_confirm" placeholder="Confirm password" required> <span id="passwordConfirmError" class="error-message hidden"></span> </div>
        <div class="form-group"> <label class="checkbox-label"> <input type="checkbox" name="terms" required> I acknowledge this registration is performed by an authorized admin. </label> </div>
        
        <button type="submit" class="btn primary-btn" style="width: 100%;">Create Account</button>
        <div class="alternate-link"> Already have an account? <a href="login.html">Login</a> </div>
      </form>
    </div>
  </main>
  <footer> <p>&copy; 2025 SNA CBT System. All rights reserved.</p> </footer>

  <script>
    let currentUser; // Stores current user data, needed for buildNavigation
    const studentFieldsDiv = document.getElementById('studentFields');
    const admissionNumberInput = document.getElementById('admission_number');
    const classLevelSelect = document.getElementById('class_level_id'); // Changed ID to match backend
    const profilePictureInput = document.getElementById('profile_picture');
    const profilePicturePreview = document.getElementById('profile_picture_preview');
    const profilePictureFilename = document.getElementById('profile_picture_filename');
    const pictureError = document.getElementById('pictureError');
    const globalFormError = document.getElementById('globalFormError');
    const classLevelStatusMessage = document.getElementById('classLevelStatusMessage'); // Get the new element
    let classLevelsLoaded = false; // Flag to track if class levels have been loaded

    /**
     * Toggles the visibility and 'required' attribute of student-specific fields
     * based on the selected role.
     */
    function toggleStudentFields() {
      const role = document.getElementById('role').value;
      const isStudent = role === 'student';
      studentFieldsDiv.classList.toggle('hidden', !isStudent);
      
      admissionNumberInput.required = isStudent;
      classLevelSelect.required = isStudent;
      // Note: profile_picture is optional, so its 'required' state doesn't change

      const formTitle = document.getElementById('formTitle');
      const formSubtitle = document.getElementById('formSubtitle');
      if (isStudent) {
        formTitle.textContent = 'Register New Student';
        formSubtitle.textContent = 'Enter student details below.';
      } else {
        formTitle.textContent = `Register New ${role.charAt(0).toUpperCase() + role.slice(1)}`;
        formSubtitle.textContent = `Enter ${role} details below.`;
        // Clear student-specific fields when not registering a student
        admissionNumberInput.value = '';
        classLevelSelect.value = ''; // Clear selected value
        if(profilePictureInput) profilePictureInput.value = ''; // Clear file input
        profilePicturePreview.classList.add('hidden');
        profilePictureFilename.textContent = '';
      }
    }

    /**
     * Checks password strength and updates the strength indicator.
     * @param {string} password - The password string.
     */
    function checkPasswordStrength(password) {
      const strengthBar = document.querySelector('.strength-bar');
      let strength = 0;
      if (password.length >= 8) strength++;
      if (/[A-Z]/.test(password)) strength++; // Uppercase
      if (/[0-9]/.test(password)) strength++; // Number
      if (/[^A-Za-z0-9]/.test(password)) strength++; // Special character
      
      const width = strength * 25; // Each criterion adds 25% width
      strengthBar.style.width = `${width}%`;
      
      if (strength <= 1) strengthBar.style.background = '#e74c3c'; // Weak (red)
      else if (strength === 2) strengthBar.style.background = '#f39c12'; // Medium (orange)
      else if (strength === 3) strengthBar.style.background = '#f1c40f'; // Good (yellow)
      else strengthBar.style.background = '#2ecc71'; // Strong (green)
    }

    /**
     * Handles previewing the selected profile picture.
     */
    profilePictureInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        pictureError.classList.add('hidden');
        pictureError.textContent = '';

        if (file) {
            // Validate file size (5MB limit)
            if (file.size > 5 * 1024 * 1024) {
                pictureError.textContent = 'File is too large. Maximum 5MB allowed.';
                pictureError.classList.remove('hidden');
                profilePicturePreview.classList.add('hidden');
                profilePictureFilename.textContent = '';
                this.value = ''; // Clear the input
                return;
            }
            // Validate file type
            if (!['image/jpeg', 'image/png', 'image/gif'].includes(file.type)) {
                pictureError.textContent = 'Invalid file type. Only JPG, PNG, GIF allowed.';
                pictureError.classList.remove('hidden');
                profilePicturePreview.classList.add('hidden');
                this.value = ''; // Clear the input
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                profilePicturePreview.src = e.target.result;
                profilePicturePreview.classList.remove('hidden');
            }
            reader.readAsDataURL(file);
            profilePictureFilename.textContent = file.name;
        } else {
            profilePicturePreview.removeAttribute('src'); // Clear src
            profilePicturePreview.classList.add('hidden');
            profilePictureFilename.textContent = '';
        }
    });

    /**
     * Shows a global success message with a checkmark animation.
     * @param {string} message - The success message to display.
     */
    function showGlobalSuccessMessage(message) {
        let successModal = document.getElementById('globalSuccessModal');
        if (!successModal) {
            successModal = document.createElement('div');
            successModal.id = 'globalSuccessModal';
            successModal.className = 'success-message-modal';
            successModal.innerHTML = `
                <svg class="checkmark" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 52 52">
                    <circle class="checkmark-circle" cx="26" cy="26" r="25" fill="none" stroke="#fff" stroke-width="2"/>
                    <path class="checkmark-check" fill="none" stroke="#fff" stroke-width="2" d="M14.1 27.2l7.1 7.2 16.7-16.8"/>
                </svg>
                <span id="globalSuccessText"></span>`;
            document.body.appendChild(successModal);
        }
        document.getElementById('globalSuccessText').textContent = message;
        successModal.classList.add('show');
        setTimeout(() => {
            successModal.classList.remove('show');
            // Remove the modal from DOM after it's hidden to clean up
            if (successModal.parentNode) {
                successModal.parentNode.removeChild(successModal);
            }
        }, 4000); // Hide after 4 seconds
    }

    /**
     * Dynamically builds navigation links for the header based on user roles.
     * This function is crucial for displaying correct menu items.
     * @param {object} user - The current authenticated user object.
     */
    function buildNavigation(user) {
        const navLinksContainer = document.getElementById('navLinksContainer');
        // Clear existing links to avoid duplicates on re-render if any
        navLinksContainer.innerHTML = '';

        // Define all possible links
        const links = [
            { text: 'Dashboard', href: '/dashboard.html', roles: ['student', 'teacher', 'admin'] },
            { text: 'Create Exam', href: '/create-exam.html', roles: ['teacher', 'admin'] },
            { text: 'Manage Users', href: '/manage-users.html', roles: ['admin'] },
            { text: 'Register User', href: '/registration.html', roles: ['admin'] },
            { text: 'Manage Subjects', href: '/manage-subjects.html', roles: ['admin'] },
            { text: 'Manage Class Levels', href: '/manage-class-levels.html', roles: ['admin'] },
            { text: 'Manage Classes', href: '/manage-classes.html', roles: ['admin'] },
            { text: 'Admin Reports', href: '/admin-reports.html', roles: ['admin'] }
        ];

        links.forEach(link => {
            // Check if the user has the required role OR is an admin if the link is for an admin-specific role
            const isAuthorized = link.roles.includes(user.role) || (link.roles.includes('admin') && user.is_admin);

            if (isAuthorized) {
                const li = document.createElement('li');
                const a = document.createElement('a');
                a.href = link.href;
                a.textContent = link.text;
                li.appendChild(a);
                navLinksContainer.appendChild(li);
            }
        });

        // Add logout button
        const logoutLi = document.createElement('li');
        const logoutBtn = document.createElement('button');
        logoutBtn.textContent = 'Logout';
        logoutBtn.className = 'btn'; // Apply a class for styling
        logoutBtn.onclick = async () => {
            try {
                const response = await fetch('/api/users/logout', { method: 'POST', credentials: 'include' });
                if (response.ok) {
                    localStorage.clear();
                    sessionStorage.clear();
                    window.location.href = '/login.html';
                } else {
                    const errorMsg = ((await response.json().catch(()=>({}))).error || 'Please try again.');
                    console.error('Logout failed:', errorMsg);
                    alert('Logout failed: ' + errorMsg); // Fallback alert
                }
            } catch (error) {
                console.error('Logout error:', error);
                alert('Logout failed due to a network error.'); // Fallback alert
            }
        };
        logoutLi.appendChild(logoutBtn);
        navLinksContainer.appendChild(logoutLi);
    }


    /**
     * Fetches authenticated user data and builds navigation.
     * This function is also used by other pages like dashboard to get user info.
     */
    async function fetchUserDataAndBuildNav() {
        try {
            const response = await fetch('/api/users/me', {credentials: 'include'});
            if (!response.ok) {
                 // If not authorized or any other error, redirect to login
                 window.location.href = '/login.html';
                 return;
            }
            currentUser = await response.json();
            // Call the now-local buildNavigation function
            buildNavigation(currentUser);
            // Check if admin, otherwise redirect
            if (!currentUser.is_admin) {
                document.querySelector('main').innerHTML = '<h1>Access Denied</h1><p>You do not have administrative privileges to access this page.</p>';
            }
        } catch(e) {
            console.error("Error fetching user data or building navigation:", e);
            // On network error or other client-side issue, default to Login link
            const navLinksContainer = document.getElementById('navLinksContainer');
            navLinksContainer.innerHTML = '<li><a href="/login.html">Login</a></li>';
            document.querySelector('main').innerHTML = '<h1 style="color:red;">Error: Failed to load page content. Please try again.</h1>';
        }
    }

    /**
     * Fetches class levels from the backend and populates the dropdown.
     * Sets classLevelsLoaded flag to true on success.
     */
    async function populateClassLevels() {
        classLevelStatusMessage.textContent = 'Loading class levels...';
        classLevelStatusMessage.classList.add('loading');
        classLevelSelect.disabled = true; // Disable until loaded

        try {
            const response = await fetch('/api/class-levels', { credentials: 'include' });
            if (!response.ok) {
                throw new Error('Failed to fetch class levels.');
            }
            const classLevels = await response.json();
            // Clear current options and add default
            classLevelSelect.innerHTML = '<option value="">Select Class Level...</option>'; 
            if (classLevels.length === 0) {
                classLevelStatusMessage.textContent = 'No class levels found. Please add them in "Manage Class Levels".';
                classLevelStatusMessage.classList.remove('loading');
                classLevelStatusMessage.classList.add('error');
                classLevelsLoaded = false;
            } else {
                classLevels.forEach(level => {
                    const option = document.createElement('option');
                    option.value = level.level_id; // IMPORTANT: Use level_id for backend
                    option.textContent = level.level_name;
                    classLevelSelect.appendChild(option);
                });
                classLevelsLoaded = true;
                classLevelStatusMessage.classList.remove('loading', 'error');
                classLevelStatusMessage.textContent = ''; // Clear status on successful load
            }
        } catch (error) {
            console.error("Error populating class levels:", error);
            displayError(classLevelError, "Failed to load class levels. Please ensure class levels are configured.");
            classLevelStatusMessage.textContent = 'Failed to load class levels.';
            classLevelStatusMessage.classList.remove('loading');
            classLevelStatusMessage.classList.add('error');
            classLevelsLoaded = false;
        } finally {
            classLevelSelect.disabled = false; // Re-enable select whether success or failure
        }
    }

    // --- Main DOMContentLoaded Listener ---
    document.addEventListener('DOMContentLoaded', async () => {
      // Initialize toggling of student fields
      toggleStudentFields();
      
      // Load user data and build navigation (also checks admin access)
      await fetchUserDataAndBuildNav();

      // Populate class levels dropdown only after user data and nav are handled
      // and it's confirmed this user is an admin who needs to register students.
      if (currentUser && currentUser.is_admin) {
        // Await populateClassLevels to ensure dropdown is ready before form submission
        await populateClassLevels(); 
      }

      const form = document.getElementById('registrationForm');
      const emailError = document.getElementById('emailError');
      const admissionError = document.getElementById('admissionError');
      const classLevelError = document.getElementById('classLevelError');
      const passwordInput = document.getElementById('password');
      const passwordConfirmInput = document.getElementById('password_confirm');
      const passwordConfirmError = document.getElementById('passwordConfirmError');
      const roleSelect = document.getElementById('role'); // Get role select element

      // Helper functions for error display
      function clearErrors() {
          globalFormError.classList.add('hidden'); globalFormError.textContent = '';
          emailError.classList.add('hidden'); emailError.textContent = '';
          admissionError.classList.add('hidden'); admissionError.textContent = '';
          classLevelError.classList.add('hidden'); classLevelError.textContent = '';
          pictureError.classList.add('hidden'); pictureError.textContent = '';
          passwordConfirmError.classList.add('hidden'); passwordConfirmError.textContent = '';
          classLevelSelect.style.border = ''; // Clear border from class level select
      }
      function displayError(element, message) {
          element.textContent = message;
          element.classList.remove('hidden');
      }

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        clearErrors();

        // Client-side validation
        if (passwordInput.value !== passwordConfirmInput.value) {
            displayError(passwordConfirmError, "Passwords do not match.");
            return;
        }
        if (passwordInput.value.length < 8 || !(/[A-Z]/.test(passwordInput.value)) || !(/[0-9]/.test(passwordInput.value)) || !(/[^A-Za-z0-9]/.test(passwordInput.value))) {
            displayError(globalFormError, "Password must be at least 8 characters long and contain at least one uppercase letter, one number, and one symbol.");
            return;
        }

        const formData = new FormData(form);
        const role = roleSelect.value; // Get the selected role

        // Conditional validation and formData manipulation for students
        if (role === 'student') {
            if (!admissionNumberInput.value.trim()) { displayError(admissionError, 'Admission number required.'); return; }
            const admissionRegex = /^SNA\/\d{2}\/\d{3}$/i; 
            if (!admissionRegex.test(admissionNumberInput.value.trim())) {
                displayError(admissionError, 'Invalid admission number format. Use SNA/YY/001 (e.g. SNA/23/001)'); return;
            }
            
            // --- START of added logging and final check ---
            console.log('--- Submitting Student Form ---');
            console.log('classLevelSelect.value (raw):', classLevelSelect.value);
            console.log('classLevelsLoaded:', classLevelsLoaded);

            // Explicitly check classLevelSelect.value for an empty string
            if (classLevelSelect.value === "") { 
                console.error('Validation Error: Class level is empty at submission.');
                displayError(classLevelError, 'Class level is required for students. Please select one.'); 
                // Add a visual highlight for the dropdown to draw attention
                classLevelSelect.style.border = '2px solid var(--danger-red)';
                classLevelSelect.focus();
                setTimeout(() => classLevelSelect.style.border = '', 2000); // Remove highlight after 2s
                return;
            }
            // If class levels haven't loaded and the value is still empty, show an error.
            if (!classLevelsLoaded && classLevelSelect.value === "") { 
                 console.error('Validation Error: Class levels not loaded and value is empty.');
                 displayError(classLevelError, "Class levels are not loaded. Please try refreshing the page or contact support.");
                 return;
            }
            // Additional check for invalid numeric value (e.g., if option.value was corrupted)
            const parsedClassLevelId = parseInt(classLevelSelect.value);
            console.log('classLevelSelect.value (parsed int):', parsedClassLevelId);

            if (classLevelSelect.value !== "" && isNaN(parsedClassLevelId)) {
                console.error('Validation Error: Class level is not a valid number.');
                displayError(classLevelError, 'Invalid class level selected. Please choose a valid class level from the list.');
                classLevelSelect.style.border = '2px solid var(--danger-red)';
                classLevelSelect.focus();
                setTimeout(() => classLevelSelect.style.border = '', 2000);
                return;
            }
            // --- END of added logging and final check ---

        } else {
            // For non-student roles, remove student-specific fields from formData
            formData.delete('admission_number'); 
            formData.delete('class_level_id'); 
            formData.delete('dob');
            formData.delete('gender');
            formData.delete('profile_picture'); // Also remove profile picture if not a student
        }

        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true; submitButton.textContent = 'Creating Account...';

        try {
          const response = await fetch('/api/users/register', { method: 'POST', body: formData, credentials: 'include' });
          const responseData = await response.json();

          if (response.ok) {
            form.reset(); // Clear all form fields
            toggleStudentFields(); // Reset student fields visibility and requirements
            checkPasswordStrength(''); // Reset password strength indicator
            // Clear profile picture preview
            if(profilePicturePreview) { profilePicturePreview.removeAttribute('src'); profilePicturePreview.classList.add('hidden');}
            if(profilePictureFilename) profilePictureFilename.textContent = '';

            showGlobalSuccessMessage(`${role.charAt(0).toUpperCase() + role.slice(1)} account created successfully!`);
          } else {
            const errField = responseData.field; // Assuming backend sends a 'field' for specific errors
            const errMsg = responseData.error || 'Registration failed.';
            if (errField === 'email') displayError(emailError, errMsg);
            else if (errField === 'admission_number') displayError(admissionError, errMsg);
            else if (errField === 'class_level_id') displayError(classLevelError, errMsg); // Adjusted for class_level_id
            else if (errField === 'profile_picture') displayError(pictureError, errMsg);
            else { 
                globalFormError.textContent = errMsg; 
                globalFormError.classList.remove('hidden');
            }
          }
        } catch (error) {
          console.error("Registration fetch error:", error);
          globalFormError.textContent = 'A network error occurred. Please try again.'; 
          globalFormError.classList.remove('hidden');
        } finally {
            submitButton.disabled = false; 
            submitButton.textContent = 'Create Account';
        }
      });
    });
    // Removed <script src="/js/xxx.js"><script> as buildNavigation is now inline
  </script>
</body>
</html>
