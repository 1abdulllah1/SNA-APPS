<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Take Exam | CBT System</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* General body styling for better centering and background */
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f4f7f6; /* Light grey background */
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh; /* Ensure full viewport height */
    }

    main {
      flex-grow: 1; /* Allows main content to take available space */
      display: flex;
      flex-direction: column;
      align-items: center; /* Center horizontally */
      justify-content: flex-start; /* Align content to the top */
      padding-top: 2rem; /* Add some space from the header */
      padding-bottom: 2rem;
    }

    /* Header Styling */
    header nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem 2.5rem; /* Increased padding for more space */
      background-color: #007bff; /* Primary blue */
      color: white;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      flex-wrap: wrap; /* Allow wrapping on smaller screens */
    }

    .nav-links {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      gap: 20px; /* Space between links */
      flex-wrap: wrap;
    }

    .nav-links a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      padding: 5px 10px;
      border-radius: 5px;
      transition: background-color 0.2s ease;
    }

    .nav-links a:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }

    .logo {
      font-size: 1.8rem; /* Larger logo */
      font-weight: 700;
      color: white;
    }

    /* Exam Container Styling */
    .exam-container {
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      padding: 2.5rem; /* Increased padding */
      width: 100%;
      max-width: 850px; /* Max width for content */
      margin-top: 2rem;
      border: 1px solid #e0e0e0;
    }

    .exam-header {
      text-align: center;
      margin-bottom: 2rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 1.5rem;
    }

    .exam-header h1 {
      color: var(--primary-blue);
      font-size: 2.2rem;
      margin-bottom: 0.5rem;
    }

    .exam-header p {
      color: var(--text-medium);
      font-size: 1.1em;
      margin: 0.3em 0;
    }

    .question-navigation {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 2rem;
      justify-content: center;
      padding: 1rem 0;
      border-bottom: 1px solid #eee;
    }

    .question-nav-btn {
      background-color: #e9ecef;
      border: 1px solid #ced4da;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
    }

    .question-nav-btn:hover:not(.active) {
      background-color: #d1d8df;
    }

    .question-nav-btn.active {
      background-color: var(--primary-blue);
      color: white;
      border-color: var(--primary-blue);
    }

    .question-card {
      background-color: #f8f9fa;
      border: 1px solid #dee2e6;
      border-radius: 10px;
      padding: 2rem;
      margin-bottom: 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }

    .question-card h3 {
      color: var(--text-dark);
      margin-top: 0;
      margin-bottom: 1.5rem;
      font-size: 1.4em;
    }

    .options-list {
      list-style: none;
      padding: 0;
    }

    .options-list li {
      margin-bottom: 1rem;
    }

    .options-list label {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      border: 1px solid #ced4da;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: #fff;
    }

    .options-list label:hover {
      background-color: #e9f0f6;
      border-color: var(--primary-blue);
    }

    .options-list input[type="radio"] {
      margin-right: 15px;
      transform: scale(1.2); /* Slightly larger radio buttons */
    }

    .timer-display {
      font-size: 1.5em;
      font-weight: 700;
      color: var(--primary-blue);
      text-align: center;
      margin-bottom: 1.5rem;
      background-color: #eaf3ff;
      padding: 10px 20px;
      border-radius: 8px;
      border: 1px solid #cce0ff;
    }
    .timer-display.warning {
        color: var(--danger-red);
        background-color: #ffebeb;
        border-color: #f5c6cb;
    }


    .exam-actions-bottom {
      display: flex;
      justify-content: space-between;
      margin-top: 2rem;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: var(--border-radius-sm);
      cursor: pointer;
      font-size: 1em;
      transition: background-color 0.2s ease;
    }

    .btn-primary {
      background-color: var(--primary-blue);
      color: white;
    }

    .btn-primary:hover {
      background-color: #0056b3;
    }

    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background-color: #5a6268;
    }

    .btn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
    }

    #examMessage {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        text-align: center;
        font-weight: 500;
    }
    #examMessage.info {
        background-color: #e0f7fa;
        color: #00796b;
        border: 1px solid #00796b;
    }
    #examMessage.error {
        background-color: #ffebee;
        color: #d32f2f;
        border: 1px solid #d32f2f;
    }

    footer {
      margin-top: auto; /* Pushes footer to the bottom */
      padding: 1.5rem;
      background-color: #343a40;
      color: white;
      text-align: center;
      width: 100%;
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <div class="logo">CBT System</div>
      <ul class="nav-links">
        <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
        <li><a href="#" id="logoutLink" class="nav-link">Logout</a></li>
      </ul>
    </nav>
  </header>

  <main>
    <div class="exam-container">
        <div id="examMessage" class="hidden"></div>
        <div id="loadingIndicator" style="text-align: center; padding: 20px;">Loading exam...</div>
        
        <div id="examContent" class="hidden">
            <div class="exam-header">
                <h1 id="examTitle"></h1>
                <p>Subject: <span id="examSubject"></span></p>
                <p>Total Questions: <span id="totalQuestions"></span></p>
                <p>Duration: <span id="examDuration"></span> minutes</p>
            </div>

            <div id="timerDisplay" class="timer-display"></div>

            <div id="questionNavigation" class="question-navigation">
                </div>

            <div id="questionsContainer">
                </div>

            <div class="exam-actions-bottom">
                <button id="prevQuestionBtn" class="btn btn-secondary">Previous</button>
                <button id="nextQuestionBtn" class="btn btn-primary">Next</button>
                <button id="submitExamBtn" class="btn btn-primary hidden">Submit Exam</button>
            </div>
        </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 CBT System</p>
  </footer>

  <script>
    let currentExam = null;
    let userAnswers = {};
    let currentQuestionIndex = 0;
    let timerInterval;
    let timeRemaining; // in seconds

    const examMessageElement = document.getElementById('examMessage');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const examContent = document.getElementById('examContent');
    const examTitle = document.getElementById('examTitle');
    const examSubject = document.getElementById('examSubject');
    const totalQuestions = document.getElementById('totalQuestions');
    const examDuration = document.getElementById('examDuration');
    const timerDisplay = document.getElementById('timerDisplay');
    const questionNavigation = document.getElementById('questionNavigation');
    const questionsContainer = document.getElementById('questionsContainer');
    const prevQuestionBtn = document.getElementById('prevQuestionBtn');
    const nextQuestionBtn = document.getElementById('nextQuestionBtn');
    const submitExamBtn = document.getElementById('submitExamBtn');

    function displayMessage(type, message) {
        examMessageElement.textContent = message;
        examMessageElement.className = `exam-message ${type}`;
        examMessageElement.classList.remove('hidden');
    }

    async function loadUserData() {
        try {
            const response = await fetch('/api/users/me', { credentials: 'include' });
            if (!response.ok) {
                window.location.href = '/login.html';
                return null;
            }
            const user = await response.json();
            // Assuming you have a navUsername element in your layout
            document.getElementById('navUsername').textContent = user.username;
            createNavigationLinks(user); // If you have this function for dynamic nav
            return user;
        } catch (error) {
            console.error("Error loading user data:", error);
            window.location.href = '/login.html';
            return null;
        }
    }


    async function loadExam() {
        loadingIndicator.classList.remove('hidden');
        examContent.classList.add('hidden');
        examMessageElement.classList.add('hidden');

        const urlParams = new URLSearchParams(window.location.search);
        const examId = urlParams.get('examId');

        if (!examId) {
            displayMessage('error', 'No exam ID provided.');
            loadingIndicator.classList.add('hidden');
            return;
        }

        try {
            const response = await fetch(`/api/exams/${examId}`, { credentials: 'include' });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to fetch exam data.');
            }
            currentExam = await response.json();

            examTitle.textContent = currentExam.title;
            examSubject.textContent = currentExam.subject_name;
            totalQuestions.textContent = currentExam.questions.length;
            examDuration.textContent = currentExam.duration_minutes;

            // Initialize user answers
            currentExam.questions.forEach(q => {
                userAnswers[q.id] = null;
            });

            renderQuestionNavigation();
            showQuestion(0);
            startTimer(currentExam.duration_minutes * 60); // Convert minutes to seconds

            loadingIndicator.classList.add('hidden');
            examContent.classList.remove('hidden');

        } catch (error) {
            displayMessage('error', `Error loading exam: ${error.message}`);
            loadingIndicator.classList.add('hidden');
            console.error("Load exam error:", error);
        }
    }

    function renderQuestionNavigation() {
        questionNavigation.innerHTML = '';
        currentExam.questions.forEach((q, index) => {
            const button = document.createElement('button');
            button.classList.add('question-nav-btn');
            button.textContent = index + 1;
            button.addEventListener('click', () => showQuestion(index));
            questionNavigation.appendChild(button);
        });
    }

    function showQuestion(index) {
        if (!currentExam || !currentExam.questions || index < 0 || index >= currentExam.questions.length) {
            return;
        }

        currentQuestionIndex = index;
        const question = currentExam.questions[currentQuestionIndex];
        questionsContainer.innerHTML = ''; // Clear previous question

        const questionCard = document.createElement('div');
        questionCard.classList.add('question-card');
        questionCard.innerHTML = `
            <h3>Question ${currentQuestionIndex + 1} of ${currentExam.questions.length}:</h3>
            <p>${question.question_text}</p>
            <ul class="options-list" id="optionsList-${question.id}">
                ${question.options.map(option => `
                    <li>
                        <label>
                            <input type="radio" name="question-${question.id}" value="${option.id}"
                                ${userAnswers[question.id] === option.id ? 'checked' : ''}>
                            ${option.option_text}
                        </label>
                    </li>
                `).join('')}
            </ul>
        `;
        questionsContainer.appendChild(questionCard);

        // Add event listener for option changes
        const optionsList = document.getElementById(`optionsList-${question.id}`);
        optionsList.addEventListener('change', (event) => {
            if (event.target.type === 'radio') {
                userAnswers[question.id] = parseInt(event.target.value);
                updateQuestionNavButton(currentQuestionIndex, true); // Mark as answered
            }
        });

        // Update navigation buttons styling
        document.querySelectorAll('.question-nav-btn').forEach((btn, idx) => {
            btn.classList.remove('active');
            if (idx === currentQuestionIndex) {
                btn.classList.add('active');
            }
        });

        // Update Prev/Next/Submit buttons
        prevQuestionBtn.disabled = currentQuestionIndex === 0;
        nextQuestionBtn.disabled = currentQuestionIndex === currentExam.questions.length - 1;

        if (currentQuestionIndex === currentExam.questions.length - 1) {
            submitExamBtn.classList.remove('hidden');
        } else {
            submitExamBtn.classList.add('hidden');
        }
    }

    function updateQuestionNavButton(index, answered) {
        const button = questionNavigation.children[index];
        if (button) {
            if (answered) {
                button.classList.add('answered'); // Add a class for answered questions
                // You might want to style 'answered' differently in your CSS
            } else {
                button.classList.remove('answered');
            }
        }
    }

    prevQuestionBtn.addEventListener('click', () => {
        if (currentQuestionIndex > 0) {
            showQuestion(currentQuestionIndex - 1);
        }
    });

    nextQuestionBtn.addEventListener('click', () => {
        if (currentQuestionIndex < currentExam.questions.length - 1) {
            showQuestion(currentQuestionIndex + 1);
        }
    });

    submitExamBtn.addEventListener('click', async () => {
        if (confirm('Are you sure you want to submit the exam? You cannot change answers after submission.')) {
            await submitExam();
        }
    });

    function startTimer(durationInSeconds) {
        timeRemaining = durationInSeconds;
        timerInterval = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay();

            if (timeRemaining <= 300 && !timerDisplay.classList.contains('warning')) { // 5 minutes warning
                timerDisplay.classList.add('warning');
            }

            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                displayMessage('info', 'Time is up! Submitting your exam automatically.');
                submitExam();
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        timerDisplay.textContent = `Time Left: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    async function submitExam() {
        clearInterval(timerInterval); // Stop the timer
        submitExamBtn.disabled = true;
        submitExamBtn.textContent = 'Submitting...';

        const submissionData = {
            exam_id: currentExam.id,
            answers: Object.entries(userAnswers).map(([questionId, optionId]) => ({
                question_id: parseInt(questionId),
                selected_option_id: optionId
            }))
        };

        try {
            const response = await fetch('/api/exam-sessions/submit', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(submissionData),
                credentials: 'include'
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || 'Unknown error occurred during submission.');
            }

            // **FIX**: Based on previous snippets, handle redirect based on result.
            if (result.message === 'Exam submitted successfully but no score calculated for non-graded exam.') {
                displayMessage('info', `Exam submitted successfully! You will be redirected to the dashboard shortly.`);
                setTimeout(() => window.location.href = 'dashboard.html', 3000);
            } else {
                displayMessage('info', `Test submitted successfully! Your score is ${result.score.toFixed(1)}%. Redirecting to results...`);
                // **FIX**: Redirect to the specific result page.
                setTimeout(() => window.location.href = `results.html?resultId=${result.resultId}`, 3000);
            }

        } catch (error) {
            if(submitExamBtn) { // Re-enable button on failure to allow retry
               submitExamBtn.disabled = false;
               submitExamBtn.textContent = 'Yes, Submit';
            }
            displayMessage('error', `Could not submit exam: ${error.message}. Please check your connection and try again.`);
        }
    }

    document.getElementById('logoutLink').addEventListener('click', async (e) => {
        e.preventDefault();
        try {
            await fetch(`/api/users/logout`, { method: 'POST', credentials: 'include' });
        } catch(err) {
            console.error("Logout failed:", err);
        } finally {
            window.location.href = '/login.html';
        }
    });

    window.addEventListener('DOMContentLoaded', async () => {
        const user = await loadUserData();
        if (user) {
            loadExam();
        }
    });
  </script>
      <script src="/js/xxx.js"></script>
</body>
</html>