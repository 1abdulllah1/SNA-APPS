<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Take Exam | CBT System</title>
  <!-- Tailwind CSS for modern styling -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts for a clean, modern look -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Feather Icons for a clean icon set -->
  <script src="https://unpkg.com/feather-icons"></script>
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f4f7f6; /* Light grey background */
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh; /* Ensure full viewport height */
    }

    /* Main content area styling */
    main {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      padding: 2rem 1rem; /* Added horizontal padding for small screens */
      width: 100%;
    }

    /* Header Styling */
    header {
      background-color: #1a237e; /* Deep blue, primary color */
      padding: 1rem 0;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
    }
    nav {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0 2.5rem; /* Consistent padding */
      max-width: 1200px; /* Max width for nav content */
      margin: 0 auto;
    }
    .logo {
      font-size: 1.8rem;
      font-weight: 700;
      color: white;
    }
    .nav-links {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      gap: 20px;
    }
    .nav-links a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      padding: 5px 10px;
      border-radius: 5px;
      transition: background-color 0.2s ease;
    }
    .nav-links a:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }
    /* Mobile menu button */
    .mobile-menu-button {
      display: none; /* Hidden by default, shown on small screens */
    }
    @media (max-width: 768px) {
      .nav-links {
        display: none; /* Hide desktop nav links on small screens */
      }
      .mobile-menu-button {
        display: block; /* Show mobile menu button */
      }
    }
    /* Mobile menu dropdown */
    .mobile-menu {
      display: none; /* Hidden by default */
      padding: 1rem;
      background-color: #283593; /* Slightly lighter blue for mobile dropdown */
      width: 100%;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .mobile-menu a {
      display: block;
      color: white;
      padding: 0.75rem 1rem;
      border-radius: 5px;
      transition: background-color 0.2s ease;
    }
    .mobile-menu a:hover {
      background-color: rgba(255, 255, 255, 0.2);
    }


    /* Exam Container Styling */
    .exam-container {
      background-color: #ffffff;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.08);
      padding: 2.5rem;
      width: 100%;
      max-width: 1000px; /* Increased max-width for a more spacious feel */
      margin-top: 2rem;
      border: 1px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      gap: 1.5rem;
    }

    .exam-header {
      text-align: center;
      margin-bottom: 2rem;
      border-bottom: 1px solid #eee;
      padding-bottom: 1.5rem;
    }

    .exam-header h1 {
      color: #1a237e; /* Using deep blue */
      font-size: 2.2rem;
      margin-bottom: 0.5rem;
      font-weight: 700;
    }

    .exam-header p {
      color: #555;
      font-size: 1.1em;
      margin: 0.3em 0;
    }

    /* Question Navigation */
    .question-navigation {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 2rem;
      justify-content: center;
      padding: 1rem 0;
      border-bottom: 1px solid #eee;
      border-top: 1px solid #eee; /* Added top border for separation */
    }

    .question-nav-btn {
      background-color: #e9ecef;
      border: 1px solid #ced4da;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s ease;
      min-width: 40px; /* Ensure buttons are not too small */
      text-align: center;
    }

    .question-nav-btn:hover:not(.active) {
      background-color: #d1d8df;
      transform: translateY(-1px);
    }

    .question-nav-btn.active {
      background-color: #1a237e; /* Deep blue */
      color: white;
      border-color: #1a237e;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    /* Style for answered questions */
    .question-nav-btn.answered {
        background-color: #d4edda; /* Light green */
        border-color: #28a745; /* Green border */
        color: #28a745;
    }
    .question-nav-btn.answered.active {
        background-color: #28a745; /* Darker green when active and answered */
        color: white;
    }


    /* Question Card */
    .question-card {
      background-color: #fdfdff; /* Slightly off-white */
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 2.5rem; /* Increased padding */
      margin-bottom: 2rem;
      box-shadow: 0 2px 10px rgba(0,0,0,0.03);
    }

    .question-card h3 {
      color: #283593; /* Indigo shade */
      margin-top: 0;
      margin-bottom: 1.5rem;
      font-size: 1.4em;
      font-weight: 600;
    }

    .options-list {
      list-style: none;
      padding: 0;
    }

    .options-list li {
      margin-bottom: 1rem;
    }

    .options-list label {
      display: flex;
      align-items: center;
      padding: 15px 20px; /* Increased padding */
      border: 1px solid #ced4da;
      border-radius: 10px; /* More rounded corners */
      cursor: pointer;
      transition: all 0.2s ease;
      background-color: #fff;
      font-size: 1.05em;
      color: #333;
    }

    .options-list label:hover {
      background-color: #eaf3ff; /* Light blue hover */
      border-color: #1a237e; /* Deep blue border on hover */
      transform: translateY(-2px); /* Slight lift on hover */
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .options-list input[type="radio"]:checked + span {
        font-weight: 600;
        color: #1a237e; /* Highlight text of selected option */
    }

    .options-list input[type="radio"] {
      margin-right: 15px;
      transform: scale(1.2); /* Slightly larger radio buttons */
      accent-color: #1a237e; /* Custom accent color for radio button */
    }

    /* Timer Display */
    .timer-display {
      font-size: 1.8em; /* Larger font */
      font-weight: 700;
      color: #1a237e; /* Deep blue */
      text-align: center;
      margin-bottom: 1.5rem;
      background-color: #eaf3ff; /* Light blue background */
      padding: 15px 25px; /* More padding */
      border-radius: 10px;
      border: 1px solid #cce0ff;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .timer-display.warning {
        color: #dc3545; /* Red for warning */
        background-color: #ffebeb;
        border-color: #f5c6cb;
    }
    .timer-display.critical {
        color: white;
        background-color: #dc3545; /* Darker red for critical */
        border-color: #c82333;
        animation: pulse 1s infinite alternate; /* Pulsing animation */
    }
    @keyframes pulse {
        from { transform: scale(1); opacity: 1; }
        to { transform: scale(1.02); opacity: 0.9; }
    }


    .exam-actions-bottom {
      display: flex;
      justify-content: space-between;
      gap: 1rem; /* Space between buttons */
      margin-top: 2rem;
      flex-wrap: wrap; /* Allow wrapping on smaller screens */
    }

    .btn {
      padding: 12px 25px; /* Larger buttons */
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.05em;
      font-weight: 600;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      display: inline-flex; /* For icon alignment */
      align-items: center;
      justify-content: center;
    }

    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .btn-primary {
      background-color: #1a237e;
      color: white;
    }
    .btn-primary:hover {
      background-color: #283593;
    }
    .btn-secondary {
      background-color: #6c757d;
      color: white;
    }
    .btn-secondary:hover {
      background-color: #5a6268;
    }
    .btn-danger {
        background-color: #dc3545;
        color: white;
    }
    .btn-danger:hover {
        background-color: #c82333;
    }

    .btn:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
        box-shadow: none;
        transform: none;
    }

    /* Message styles */
    #examMessage {
        padding: 15px;
        margin-bottom: 20px;
        border-radius: 8px;
        text-align: center;
        font-weight: 500;
        width: 100%;
        max-width: 1000px;
    }
    #examMessage.info {
        background-color: #e0f7fa;
        color: #00796b;
        border: 1px solid #00796b;
    }
    #examMessage.error {
        background-color: #ffebee;
        color: #d32f2f;
        border: 1px solid #d32f2f;
    }
    #examMessage.success {
        background-color: #e8f5e9;
        color: #388e3c;
        border: 1px solid #388e3c;
    }

    /* Section instructions styling */
    .section-instructions-display {
        background-color: #f0f8ff;
        border-left: 5px solid #1a237e; /* Deep blue border */
        padding: 15px;
        margin-bottom: 1.5rem;
        border-radius: 5px;
        font-style: italic;
        color: #333;
        font-size: 0.95em;
    }

    footer {
      margin-top: auto; /* Pushes footer to the bottom */
      padding: 1.5rem;
      background-color: #343a40;
      color: white;
      text-align: center;
      width: 100%;
    }

    /* Modals for alerts and confirmations */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        display: flex; /* Use flexbox for centering */
        align-items: center; /* Center vertically */
        justify-content: center; /* Center horizontally */
    }
    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 0;
        border: 1px solid #888;
        width: 80%; /* Could be responsive */
        max-width: 500px;
        border-radius: 10px; /* Rounded corners */
        box-shadow: 0 8px 30px rgba(0,0,0,0.25);
        overflow: hidden; /* Ensures rounded corners on content */
    }
    .modal-header {
        padding: 15px 20px;
        background-color: #1a237e; /* Deep blue */
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 10px 10px 0 0;
    }
    .modal-header h2 {
        margin: 0;
        font-size: 1.2rem;
    }
    .modal-body {
        padding: 20px;
        text-align: center;
    }
    .modal-footer {
        padding: 15px 20px;
        background-color: #f1f1f1;
        text-align: right;
        border-top: 1px solid #e0e0e0;
        border-radius: 0 0 10px 10px;
    }
    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
    }
    .close-button:hover,
    .close-button:focus {
        color: #ddd;
        text-decoration: none;
        cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <div class="logo">SNA CBT System</div>
      <ul class="nav-links" id="navLinks">
        <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
        <li><a href="#" id="logoutLink" class="nav-link">Logout</a></li>
      </ul>
      <button id="mobile-menu-button" class="mobile-menu-button text-white focus:outline-none">
        <i data-feather="menu" class="w-6 h-6"></i>
      </button>
    </nav>
    <div id="mobile-menu" class="mobile-menu">
      <a href="dashboard.html">Dashboard</a>
      <a href="#" id="mobileLogoutLink">Logout</a>
    </div>
  </header>

  <main>
    <div id="examMessage" class="hidden"></div>
    <div id="loadingIndicator" class="text-center py-8 text-lg text-gray-600">
        <svg class="animate-spin h-8 w-8 text-indigo-600 mx-auto mb-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Loading exam...
    </div>
        
    <div id="examContent" class="exam-container hidden">
        <div class="exam-header">
            <h1 id="examTitle" class="text-3xl font-extrabold text-gray-900"></h1>
            <p class="text-gray-600 text-lg">Subject: <span id="examSubject" class="font-semibold"></span></p>
            <p class="text-gray-600 text-lg">Total Questions: <span id="totalQuestions" class="font-semibold"></span></p>
            <p class="text-gray-600 text-lg">Duration: <span id="examDuration" class="font-semibold"></span> minutes</p>
            <p id="examInstructions" class="text-sm text-gray-500 mt-2 italic"></p>
        </div>

        <div id="timerDisplay" class="timer-display"></div>

        <div id="questionNavigation" class="question-navigation">
            <!-- Question navigation buttons will be rendered here -->
        </div>

        <div id="sectionsContainer">
            <!-- Sections and questions will be rendered here -->
        </div>

        <div class="exam-actions-bottom">
            <button id="prevQuestionBtn" class="btn btn-secondary flex-1 sm:flex-none">
                <i data-feather="arrow-left" class="w-5 h-5 mr-2"></i> Previous
            </button>
            <button id="nextQuestionBtn" class="btn btn-primary flex-1 sm:flex-none">
                Next <i data-feather="arrow-right" class="w-5 h-5 ml-2"></i>
            </button>
            <button id="submitExamBtn" class="btn btn-danger flex-1 sm:flex-none hidden">
                Submit Exam <i data-feather="check-circle" class="w-5 h-5 ml-2"></i>
            </button>
        </div>
    </div>
  </main>

  <footer class="bg-gray-800 text-white py-4 text-center">
    <p>&copy; 2025 SNA CBT System. All rights reserved.</p>
  </footer>

  <script>
    let currentExam = null;
    let userAnswers = {}; // Stores answers: { questionId: selectedOptionId }
    let allQuestions = []; // Flattened list of all questions for easy indexing
    let currentQuestionIndex = 0;
    let timerInterval;
    let timeRemaining; // in seconds
    let examStartTime; // To track when the exam actually started for timeTakenSeconds calculation
    let autoSaveInterval; // Declare autoSaveInterval variable

    // Modals for alerts and confirmations
    let currentConfirmationCallback = null; 

    function showConfirmation(message) {
        return new Promise(resolve => {
            document.getElementById('confirmationMessage').textContent = message;
            document.getElementById('confirmationModal').style.display = 'flex'; 
            currentConfirmationCallback = resolve;
        });
    }

    function confirmAction(result) {
        if (currentConfirmationCallback) {
            currentConfirmationCallback(result);
            currentConfirmationCallback = null; 
        }
        closeModal('confirmationModal');
    }

    function showAlert(message, title = "Alert") {
        document.getElementById('alertTitle').textContent = title;
        document.getElementById('alertMessage').textContent = message;
        document.getElementById('alertDialog').style.display = 'flex'; 
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    // End Modals

    const examMessageElement = document.getElementById('examMessage');
    const loadingIndicator = document.getElementById('loadingIndicator');
    const examContent = document.getElementById('examContent');
    const examTitle = document.getElementById('examTitle');
    const examSubject = document.getElementById('examSubject');
    const totalQuestionsDisplay = document.getElementById('totalQuestions');
    const examDurationDisplay = document.getElementById('examDuration');
    const examInstructionsDisplay = document.getElementById('examInstructions');
    const timerDisplay = document.getElementById('timerDisplay');
    const questionNavigation = document.getElementById('questionNavigation');
    const sectionsContainer = document.getElementById('sectionsContainer');
    const prevQuestionBtn = document.getElementById('prevQuestionBtn');
    const nextQuestionBtn = document.getElementById('nextQuestionBtn');
    const submitExamBtn = document.getElementById('submitExamBtn');

    function displayMessage(type, message) {
        examMessageElement.textContent = message;
        examMessageElement.className = `exam-message ${type}`;
        examMessageElement.classList.remove('hidden');
        // Hide after 5 seconds, unless it's an error that needs user action
        if (type !== 'error') {
            setTimeout(() => {
                examMessageElement.classList.add('hidden');
            }, 5000);
        }
    }

    async function loadUserData() {
        try {
            const response = await fetch('/api/users/me', { credentials: 'include' });
            if (!response.ok) {
                window.location.href = '/login.html';
                return null;
            }
            return await response.json();
        } catch (error) {
            console.error("Error loading user data:", error);
            window.location.href = '/login.html';
            return null;
        }
    }

    async function loadExam() {
        loadingIndicator.classList.remove('hidden');
        examContent.classList.add('hidden');
        examMessageElement.classList.add('hidden');

        const urlParams = new URLSearchParams(window.location.search);
        const examId = urlParams.get('examId');

        if (!examId) {
            displayMessage('error', 'No exam ID provided. Please go back to the dashboard and select an exam.');
            loadingIndicator.classList.add('hidden');
            return;
        }

        try {
            const startSessionResponse = await fetch(`/api/exam-sessions/${examId}/start`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                credentials: 'include'
            });

            if (!startSessionResponse.ok) {
                let errorData;
                let errorMessage = 'Failed to start exam session.';
                try {
                    errorData = await startSessionResponse.json();
                    errorMessage = errorData.error || errorMessage;
                } catch (jsonError) {
                    const textResponse = await startSessionResponse.text();
                    errorMessage = `Server responded with non-JSON: ${textResponse.substring(0, 100)}... (Status: ${startSessionResponse.status})`;
                }
                throw new Error(errorMessage);
            }
            const sessionData = await startSessionResponse.json();
            
            currentExam = sessionData.exam;
            allQuestions = [];
            // Flatten all questions from sections for easy indexing, maintaining section info
            sessionData.sections.forEach(section => {
                section.questions.forEach(q => {
                    allQuestions.push({
                        ...q,
                        section_id: section.section_id,
                        section_name: section.section_name,
                        section_instructions: section.section_instructions
                    });
                });
            });

            // Initialize user answers from session progress if available
            if (sessionData.session && sessionData.session.progress) {
                try {
                    userAnswers = JSON.parse(sessionData.session.progress);
                } catch (e) {
                    console.error("Error parsing saved progress JSON:", e);
                    userAnswers = {}; // Reset if parsing fails
                }
            } else {
                allQuestions.forEach(q => {
                    // Initialize with null if no progress, but only if not already set (e.g., from a previous session)
                    if (userAnswers[q.question_id] === undefined) {
                        userAnswers[q.question_id] = null;
                    }
                });
            }

            examTitle.textContent = currentExam.title;
            examSubject.textContent = currentExam.subject_name;
            totalQuestionsDisplay.textContent = allQuestions.length;
            examDurationDisplay.textContent = currentExam.duration_minutes;
            examInstructionsDisplay.textContent = currentExam.exam_instructions || 'No general instructions provided for this exam.';

            renderQuestionNavigation();
            showQuestion(0); // Show the first question
            
            // Resume timer from saved time or start new
            timeRemaining = sessionData.session.timeRemaining || (currentExam.duration_minutes * 60);
            // Calculate examStartTime based on current time and timeRemaining
            examStartTime = Date.now() - (currentExam.duration_minutes * 60 - timeRemaining) * 1000;
            startTimer(timeRemaining);

            // Clear any existing auto-save interval before setting a new one
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
            }
            autoSaveInterval = setInterval(saveProgress, 30000); // Save every 30 seconds

            loadingIndicator.classList.add('hidden');
            examContent.classList.remove('hidden');

        } catch (error) {
            displayMessage('error', `Error loading exam: ${error.message}. Please try again or contact support.`);
            loadingIndicator.classList.add('hidden');
            console.error("Load exam error:", error);
        }
    }

    function renderQuestionNavigation() {
        questionNavigation.innerHTML = '';
        allQuestions.forEach((q, index) => {
            const button = document.createElement('button');
            button.classList.add('question-nav-btn');
            button.textContent = index + 1;
            button.dataset.questionId = q.question_id; // Store question ID
            button.addEventListener('click', () => showQuestion(index));
            
            // Mark as answered if an answer exists
            if (userAnswers[q.question_id] !== null && userAnswers[q.question_id] !== undefined) {
                button.classList.add('answered');
            }
            questionNavigation.appendChild(button);
        });
        if (typeof feather !== 'undefined') { // Check if feather is loaded
            feather.replace();
        }
    }

    function showQuestion(index) {
        if (!currentExam || !allQuestions || index < 0 || index >= allQuestions.length) {
            return;
        }

        // Before moving to a new question, save the current question's answer if any radio is selected
        const currentQuestion = allQuestions[currentQuestionIndex];
        // Only attempt to get radio buttons if currentQuestion is valid
        if (currentQuestion) {
            const currentQuestionRadios = document.querySelectorAll(`input[name="question-${currentQuestion.question_id}"]`);
            let currentAnswerSelected = false;
            currentQuestionRadios.forEach(radio => {
                if (radio.checked) {
                    userAnswers[currentQuestion.question_id] = radio.value;
                    currentAnswerSelected = true;
                }
            });
            updateQuestionNavButton(currentQuestionIndex, currentAnswerSelected);
        }


        currentQuestionIndex = index;
        const question = allQuestions[currentQuestionIndex];
        sectionsContainer.innerHTML = ''; // Clear previous content

        // Display section title and instructions if applicable
        const sectionCard = document.createElement('div');
        sectionCard.classList.add('section-card-display', 'mb-6');
        sectionCard.innerHTML = `
            <h2 class="text-2xl font-bold text-gray-800 mb-2">${question.section_name}</h2>
            ${question.section_instructions ? `<p class="section-instructions-display">${question.section_instructions}</p>` : ''}
        `;
        sectionsContainer.appendChild(sectionCard);


        const questionCard = document.createElement('div');
        questionCard.classList.add('question-card');
        questionCard.innerHTML = `
            <h3 class="text-xl font-semibold text-gray-700 mb-4">Question ${currentQuestionIndex + 1} of ${allQuestions.length}:</h3>
            <p class="text-lg text-gray-800 mb-6">${question.question_text}</p>
            <ul class="options-list" id="optionsList-${question.question_id}">
                ${question.options.map(option => `
                    <li>
                        <label class="flex items-center">
                            <input type="radio" name="question-${question.question_id}" value="${option.id}"
                                class="h-5 w-5 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded-full"
                                ${userAnswers[question.question_id] === option.id ? 'checked' : ''}>
                            <span class="ml-3 text-gray-700">${option.text}</span>
                        </label>
                    </li>
                `).join('')}
            </ul>
        `;
        sectionsContainer.appendChild(questionCard);

        // Add event listener for option changes
        const optionsList = document.getElementById(`optionsList-${question.question_id}`);
        optionsList.addEventListener('change', (event) => {
            if (event.target.type === 'radio') {
                userAnswers[question.question_id] = event.target.value; // Store the selected option ID (A, B, C, D)
                updateQuestionNavButton(currentQuestionIndex, true); // Mark as answered
            }
        });

        // Update navigation buttons styling
        document.querySelectorAll('.question-nav-btn').forEach((btn, idx) => {
            btn.classList.remove('active');
            if (idx === currentQuestionIndex) {
                btn.classList.add('active');
            }
        });

        // Update Prev/Next/Submit buttons
        prevQuestionBtn.disabled = currentQuestionIndex === 0;
        nextQuestionBtn.disabled = currentQuestionIndex === allQuestions.length - 1;

        if (currentQuestionIndex === allQuestions.length - 1) {
            submitExamBtn.classList.remove('hidden');
            nextQuestionBtn.classList.add('hidden'); // Hide next button on last question
        } else {
            submitExamBtn.classList.add('hidden');
            nextQuestionBtn.classList.remove('hidden');
        }
    }

    function updateQuestionNavButton(index, answered) {
        const button = questionNavigation.children[index];
        if (button) {
            if (answered) {
                button.classList.add('answered'); // Add a class for answered questions
            } else {
                button.classList.remove('answered');
            }
        }
    }

    prevQuestionBtn.addEventListener('click', () => {
        if (currentQuestionIndex > 0) {
            showQuestion(currentQuestionIndex - 1);
        }
    });

    nextQuestionBtn.addEventListener('click', () => {
        if (currentQuestionIndex < allQuestions.length - 1) {
            showQuestion(currentQuestionIndex + 1);
        }
    });

    submitExamBtn.addEventListener('click', async () => {
        const confirmed = await showConfirmation('Are you sure you want to submit the exam? You cannot change answers after submission.');
        if (confirmed) {
            await submitExam();
        }
    });

    function startTimer(durationInSeconds) {
        timeRemaining = durationInSeconds;
        updateTimerDisplay(); // Initial display

        timerInterval = setInterval(() => {
            timeRemaining--;
            updateTimerDisplay();

            if (timeRemaining <= 300 && timeRemaining > 60) { // 5 minutes warning
                timerDisplay.classList.add('warning');
                timerDisplay.classList.remove('critical');
            } else if (timeRemaining <= 60) { // 1 minute critical warning
                timerDisplay.classList.add('critical');
                timerDisplay.classList.remove('warning');
            } else {
                timerDisplay.classList.remove('warning', 'critical');
            }

            if (timeRemaining <= 0) {
                clearInterval(timerInterval);
                displayMessage('info', 'Time is up! Submitting your exam automatically.');
                submitExam(); // Auto-submit when time runs out
            }
        }, 1000);
    }

    function updateTimerDisplay() {
        const minutes = Math.floor(timeRemaining / 60);
        const seconds = timeRemaining % 60;
        timerDisplay.textContent = `Time Left: ${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    async function saveProgress() {
        // Ensure currentQuestion's answer is saved before auto-saving
        const currentQuestion = allQuestions[currentQuestionIndex];
        if (currentQuestion) {
            const currentQuestionRadios = document.querySelectorAll(`input[name="question-${currentQuestion.question_id}"]`);
            let currentAnswerSelected = false;
            currentQuestionRadios.forEach(radio => {
                if (radio.checked) {
                    userAnswers[currentQuestion.question_id] = radio.value;
                    currentAnswerSelected = true;
                }
            });
            updateQuestionNavButton(currentQuestionIndex, currentAnswerSelected);
        }

        if (!currentExam || Object.keys(userAnswers).length === 0) {
            return; // Don't save if exam not loaded or no answers
        }
        try {
            const response = await fetch(`/api/exam-sessions/${currentExam.exam_id}/progress`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                credentials: 'include',
                body: JSON.stringify({
                    answers: userAnswers,
                    timeRemaining: timeRemaining
                }),
            });
            if (!response.ok) {
                console.warn('Failed to auto-save progress:', await response.json());
            } else {
                console.log('Progress auto-saved.');
            }
        } catch (error) {
            console.error('Error during auto-save:', error);
        }
    }

    async function submitExam() {
        clearInterval(timerInterval); // Stop the timer
        if (autoSaveInterval) { // Stop auto-save interval
            clearInterval(autoSaveInterval);
        }
        if (submitExamBtn) { // Check if element exists before accessing
            submitExamBtn.disabled = true;
            submitExamBtn.textContent = 'Submitting...';
        }

        // Ensure the last question's answer is captured before submission
        const currentQuestion = allQuestions[currentQuestionIndex];
        if (currentQuestion) {
            const currentQuestionRadios = document.querySelectorAll(`input[name="question-${currentQuestion.question_id}"]`);
            currentQuestionRadios.forEach(radio => {
                if (radio.checked) {
                    userAnswers[currentQuestion.question_id] = radio.value;
                }
            });
        }


        const timeTakenSeconds = Math.floor((Date.now() - examStartTime) / 1000);

        // Ensure userAnswers is an object with questionId as keys and selectedOptionId as values
        const submissionAnswers = {};
        allQuestions.forEach(q => {
            if (userAnswers[q.question_id]) {
                submissionAnswers[q.question_id] = userAnswers[q.question_id];
            }
        });


        try {
            const response = await fetch(`/api/exam-sessions/${currentExam.exam_id}/submit`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    answers: submissionAnswers,
                    timeTakenSeconds: timeTakenSeconds
                }),
                credentials: 'include'
            });

            const result = await response.json();

            if (!response.ok) {
                throw new Error(result.error || 'Unknown error occurred.');
            }

            if (result.examType === 'MAIN_EXAM') {
                displayMessage('success', `Exam submitted successfully! You will be redirected to the dashboard shortly.`);
                setTimeout(() => window.location.href = 'dashboard.html', 3000);
            } else {
                displayMessage('success', `Test submitted successfully! Your score is ${result.score.toFixed(1)}%. Redirecting to results...`);
                setTimeout(() => window.location.href = `results.html?resultId=${result.resultId}`, 3000);
            }

        } catch (error) {
            if(submitExamBtn) {
               submitExamBtn.disabled = false;
               submitExamBtn.textContent = 'Submit Exam';
            }
            displayMessage('error', `Could not submit exam: ${error.message}. Please check your connection and try again.`);
        }
    }

    // Handle logout for both desktop and mobile nav
    document.getElementById('logoutLink').addEventListener('click', async (e) => {
        e.preventDefault();
        try {
            await fetch(`/api/users/logout`, { method: 'POST', credentials: 'include' });
        } catch(err) {
            console.error("Logout failed:", err);
        } finally {
            window.location.href = '/login.html';
        }
    });

    document.getElementById('mobileLogoutLink').addEventListener('click', async (e) => {
        e.preventDefault();
        try {
            await fetch(`/api/users/logout`, { method: 'POST', credentials: 'include' });
        } catch(err) {
            console.error("Logout failed:", err);
        } finally {
            window.location.href = '/login.html';
        }
    });

    // Mobile menu toggle
    document.getElementById('mobile-menu-button').addEventListener('click', () => {
        document.getElementById('mobile-menu').classList.toggle('hidden');
    });


    window.addEventListener('DOMContentLoaded', async () => {
        const user = await loadUserData();
        if (user) {
            loadExam();
        }
        // Ensure feather.replace() is called after all static and initial dynamic content is in place.
        // For dynamically added question navigation buttons, it's called in renderQuestionNavigation.
        if (typeof feather !== 'undefined') {
            feather.replace();
        }
    });
  </script>
  <!-- Modals HTML (add these to the end of your body tag) -->
<div id="confirmationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Confirm Action</h2>
            <span class="close-button" onclick="closeModal('confirmationModal')">&times;</span>
        </div>
        <div class="modal-body">
            <p id="confirmationMessage"></p>
        </div>
        <div class="modal-footer">
            <button class="btn bg-gray-200 text-gray-800 px-4 py-2 rounded-md hover:bg-gray-300" onclick="confirmAction(false)">Cancel</button>
            <button class="btn bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700" onclick="confirmAction(true)">Confirm</button>
        </div>
    </div>
</div>

<div id="alertDialog" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="alertTitle">Alert</h2>
            <span class="close-button" onclick="closeModal('alertDialog')">&times;</span>
        </div>
        <div class="modal-body">
            <p id="alertMessage"></p>
        </div>
        <div class="modal-footer">
            <button class="btn bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700" onclick="closeModal('alertDialog')">OK</button>
        </div>
    </div>
</div>
</body>
</html>
