<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Exam | CBT System</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* General Styles */
    body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.6; }
    main { max-width: 900px; margin: 30px auto; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
    h1, h2, h3 { color: var(--primary-blue); margin-bottom: 1.5rem; }
    hr { border: none; border-top: 1px solid #e0e0e0; margin: 2rem 0; }
    
    /* Form Specifics */
    .app-form { display: flex; flex-direction: column; gap: 1.5rem; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555; }
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select,
    .form-group textarea,
    .form-group input[type="datetime-local"] { /* Added datetime-local */
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 8px; /* Slightly more rounded */
      font-size: 1rem;
      box-sizing: border-box; /* Include padding in width */
    }
    .form-group input[type="checkbox"] { width: auto; margin-right: 10px; }

    .form-grid-col-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }

    /* Buttons */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
    }
    .btn-primary { background-color: #1a237e; color: white; } /* Dark blue */
    .btn-secondary { background-color: #6c757d; color: white; } /* Gray */
    .btn-danger { background-color: #dc3545; color: white; } /* Red */
    .btn-success { background-color: #28a745; color: white; } /* Green */
    .btn-info { background-color: #17a2b8; color: white; } /* Blue-green */

    /* Section & Question Styling */
    .section-card, .question-card {
      background: #fdfdff;
      border: 1px solid #e0e0e0;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .section-card h3, .question-card h4 {
      color: #283593; /* Slightly lighter blue for subheadings */
      margin-top: 0;
      margin-bottom: 1rem;
    }
    .question-options label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: normal;
      color: #333;
    }
    .question-options input[type="radio"] {
      margin-right: 8px;
    }

    .add-button-group {
        display: flex;
        gap: 1rem;
        margin-top: 1.5rem;
    }

    /* Message styles */
    .message {
        padding: 10px 15px;
        border-radius: 8px;
        margin-bottom: 1rem;
        font-weight: 500;
        text-align: center;
    }
    .success-message {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }
    .error-message {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }
    .info-message {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
    }
    .hidden {
        display: none;
    }

    /* Modal styles */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        justify-content: center; /* Center horizontally */
        align-items: center; /* Center vertically */
    }

    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 0;
        border: 1px solid #888;
        width: 80%;
        max-width: 500px;
        border-radius: 10px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.25);
        overflow: hidden;
    }

    .modal-header {
        padding: 15px 20px;
        background-color: #1a237e;
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 10px 10px 0 0;
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.2rem;
    }

    .modal-body {
        padding: 20px;
        text-align: center;
    }

    .modal-footer {
        padding: 15px 20px;
        background-color: #f1f1f1;
        text-align: right;
        border-top: 1px solid #e0e0e0;
        border-radius: 0 0 10px 10px;
    }

    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
    }

    .close-button:hover,
    .close-button:focus {
        color: #ddd;
        text-decoration: none;
        cursor: pointer;
    }

    .loading-message {
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 20px;
        text-align: center;
        font-weight: 500;
        background-color: #e0f7fa;
        color: #007bb5;
        border: 1px solid #00acc1;
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="/dashboard.html" class="logo">SNA CBT System</a>
      <ul class="nav-links" id="navLinks">
        <!-- Navigation links will be dynamically inserted here by JS -->
      </ul>
    </nav>
  </header>

  <main>
    <div class="message-container">
        <div id="pageMessage" class="message hidden"></div>
        <div id="loadingMessage" class="loading-message">Loading exam data...</div>
    </div>
    <h1>Edit Exam</h1>
    <form id="examForm" class="app-form hidden">
      <div class="form-group">
        <label for="examTitle">Exam Title:</label>
        <input type="text" id="examTitle" required>
      </div>

      <div class="form-grid-col-3">
        <div class="form-group">
          <label for="subject">Subject:</label>
          <select id="subject" required></select>
        </div>
        <div class="form-group">
          <label for="classLevel">Class Level:</label>
          <select id="classLevel" required></select>
        </div>
        <div class="form-group">
            <label for="examType">Exam Type:</label>
            <select id="examType" required>
                <option value="">Select Type</option>
                <option value="MAIN_EXAM">Main Exam</option>
                <option value="CA1">CA 1</option>
                <option value="CA2">CA 2</option>
                <option value="CA3">CA 3</option>
                <option value="CA4">CA 4</option>
                <option value="MID_TERM">Mid Term</option>
                <option value="OTHER">Other</option>
            </select>
        </div>
      </div>

      <div class="form-grid-col-3">
        <div class="form-group">
          <label for="duration">Duration (minutes):</label>
          <input type="number" id="duration" min="1" required>
        </div>
        <div class="form-group">
          <label for="passMark">Pass Mark (%):</label>
          <input type="number" id="passMark" min="0" max="100" required>
        </div>
        <div class="form-group">
            <label for="maxScore">Max Score:</label>
            <input type="number" id="maxScore" min="1" required>
        </div>
      </div>

      <div class="form-grid-col-3">
        <div class="form-group">
            <label for="term">Term:</label>
            <select id="term" required>
                <option value="">Select Term</option>
                <option value="FIRST">First Term</option>
                <option value="SECOND">Second Term</option>
                <option value="THIRD">Third Term</option>
            </select>
        </div>
        <div class="form-group">
            <label for="session">Academic Session (e.g., 2023/2024):</label>
            <input type="text" id="session" pattern="^\d{4}\/\d{4}$" placeholder="YYYY/YYYY" required>
        </div>
        <div class="form-group">
            <label for="scheduledTime">Scheduled Time (Optional):</label>
            <input type="datetime-local" id="scheduledTime">
        </div>
      </div>

      <div class="form-group">
        <input type="checkbox" id="isLocked">
        <label for="isLocked">Lock Exam (Prevent students from taking it)</label>
      </div>

      <hr>
      <h2>Exam Sections & Questions</h2>
      <div id="sectionsContainer">
        <!-- Sections will be dynamically added here -->
      </div>
      <button type="button" class="btn btn-secondary" id="addSectionBtn">Add Section</button>

      <button type="submit" class="btn btn-primary" style="margin-top: 2rem;">Save Changes</button>
    </form>
  </main>

  <footer>
    <p>&copy; 2025 SNA CBT System. All rights reserved.</p>
  </footer>

  <!-- Modals HTML (add these to the end of your body tag) -->
<div id="confirmationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Confirm Action</h2>
            <span class="close-button" onclick="closeModal('confirmationModal')">&times;</span>
        </div>
        <div class="modal-body">
            <p id="confirmationMessage"></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="confirmAction(false)">Cancel</button>
            <button class="btn btn-danger" onclick="confirmAction(true)">Confirm</button>
        </div>
    </div>
</div>

<div id="alertDialog" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="alertTitle">Alert</h2>
            <span class="close-button" onclick="closeModal('alertDialog')">&times;</span>
        </div>
        <div class="modal-body">
            <p id="alertMessage"></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeModal('alertDialog')">OK</button>
        </div>
    </div>
</div>

  <script>
    let currentUser = null;
    let confirmCallback = null; // Callback for confirmation modal
    let examIdToEdit = null; // Store the exam ID being edited

    // --- Modal Functions ---
    function showModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    function showAlert(title, message) {
        document.getElementById('alertTitle').textContent = title;
        document.getElementById('alertMessage').textContent = message;
        showModal('alertDialog');
    }

    function showConfirmation(message) {
        return new Promise((resolve) => {
            document.getElementById('confirmationMessage').textContent = message;
            showModal('confirmationModal');
            confirmCallback = resolve; // Store resolve function
        });
    }

    function confirmAction(result) {
        closeModal('confirmationModal');
        if (confirmCallback) {
            confirmCallback(result); // Call the stored resolve function
            confirmCallback = null; // Clear the callback
        }
    }

    // Utility function to display messages on the page
    function showPageMessage(message, type = 'info') {
        const msgDiv = document.getElementById('pageMessage');
        msgDiv.textContent = message;
        msgDiv.className = `message ${type}-message`; // Apply styling classes
        msgDiv.classList.remove('hidden');
        document.getElementById('loadingMessage').classList.add('hidden'); // Hide loading if message appears
        document.getElementById('examForm').classList.add('hidden'); // Hide form if message appears
    }

    async function loadUserData() {
        try {
            const response = await fetch('/api/users/me', { credentials: 'include' });
            if (!response.ok) {
                window.location.href = '/login.html'; // Redirect if not authenticated
                return null;
            }
            currentUser = await response.json();
            createNavigationLinks(currentUser); // Populate navbar
            return currentUser;
        } catch (error) {
            console.error("Error loading user data:", error);
            window.location.href = '/login.html'; // Redirect on error
            return null;
        }
    }

    function createNavigationLinks(user) {
        const navLinksContainer = document.getElementById('navLinks');
        navLinksContainer.innerHTML = ''; // Clear existing links

        const links = [
            { href: "/dashboard.html", text: "Dashboard" },
            { href: "/create-exam.html", text: "Create Exam", roles: ['admin', 'teacher'] },
            { href: "/manage-users.html", text: "Manage Users", roles: ['admin'] },
            { href: "/admin-reports.html", text: "Student Reports", roles: ['admin', 'teacher'] },
            { href: "/manage-subjects.html", text: "Manage Subjects", roles: ['admin'] },
            { href: "/manage-class-levels.html", text: "Manage Levels", roles: ['admin'] },
            { href: "/manage-classes.html", text: "Manage Classes", roles: ['admin'] }
        ];

        links.forEach(linkInfo => {
            const shouldDisplay = !linkInfo.roles || linkInfo.roles.some(role => {
                if (role === 'admin') return user.is_admin;
                return user.role === role;
            });

            if (shouldDisplay) {
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.href = linkInfo.href;
                link.textContent = linkInfo.text;
                link.classList.add('nav-link');
                // Add active class if current page
                if (window.location.pathname === linkInfo.href) {
                    link.classList.add('active');
                }
                listItem.appendChild(link);
                navLinksContainer.appendChild(listItem);
            }
        });

        const logoutLinkItem = document.createElement('li');
        const logoutBtn = document.createElement('button');
        logoutBtn.textContent = "Logout";
        logoutBtn.className = 'btn logout-btn';
        logoutBtn.style.background = '#f44336';
        logoutBtn.style.color = 'white';
        logoutBtn.style.border = 'none';
        logoutBtn.style.padding = '8px 15px';
        logoutBtn.style.borderRadius = '5px';
        logoutBtn.style.cursor = 'pointer';
        logoutLinkItem.appendChild(logoutBtn);
        navLinksContainer.appendChild(logoutLinkItem);

        logoutBtn.addEventListener('click', handleLogout);
    }

    async function handleLogout() {
        try {
            const response = await fetch('/api/users/logout', { method: 'POST', credentials: 'include' });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.warn('Logout API call failed:', errorData.error || 'Server responded with an error.');
            }
        } catch (error) {
            console.error('Network error during logout:', error);
        } finally {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = '/login.html';
        }
    }

    let sectionCounter = 0;
    let questionCounter = 0;

    async function fetchSubjects(classLevelId = null) {
        try {
            let url = '/api/exams/config/subjects';
            if (classLevelId) {
                url += `?class_level_id=${classLevelId}`;
            }
            const response = await fetch(url, { credentials: 'include' });
            if (!response.ok) {
                throw new Error('Failed to fetch subjects.');
            }
            const subjects = await response.json();
            const subjectSelect = document.getElementById('subject');
            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.subject_id;
                option.textContent = subject.name;
                subjectSelect.appendChild(option);
            });
        } catch (error) {
            console.error("Error fetching subjects:", error);
            showPageMessage(`Error loading subjects: ${error.message}`, 'error');
            return [];
        }
    }

    async function fetchClassLevels() {
        try {
            const response = await fetch('/api/exams/config/class-levels', { credentials: 'include' });
            if (!response.ok) {
                throw new Error('Failed to fetch class levels.');
            }
            const classLevels = await response.json();
            const classLevelSelect = document.getElementById('classLevel');
            classLevelSelect.innerHTML = '<option value="">Select Class Level</option>';
            classLevels.forEach(level => {
                const option = document.createElement('option');
                option.value = level.level_id;
                option.textContent = level.level_name;
                classLevelSelect.appendChild(option);
            });
            return classLevels;
        } catch (error) {
            console.error("Error fetching class levels:", error);
            showPageMessage(`Error loading class levels: ${error.message}`, 'error');
            return [];
        }
    }

    function addSection(sectionData = {}) {
      sectionCounter++;
      const currentSectionId = sectionData.section_id || `new-${sectionCounter}`; // Use existing ID or generate new
      const sectionsContainer = document.getElementById('sectionsContainer');
      const sectionDiv = document.createElement('div');
      sectionDiv.classList.add('section-card');
      sectionDiv.dataset.sectionId = currentSectionId;
      sectionDiv.innerHTML = `
        <h3>Section ${sectionCounter}</h3>
        <div class="form-group">
          <label for="sectionName${currentSectionId}">Section Name:</label>
          <input type="text" id="sectionName${currentSectionId}" class="section-name" value="${sectionData.section_name || ''}" required>
        </div>
        <div class="form-group">
          <label for="sectionInstructions${currentSectionId}">Instructions:</label>
          <textarea id="sectionInstructions${currentSectionId}" class="section-instructions" rows="3">${sectionData.section_instructions || ''}</textarea>
        </div>
        <div id="questionsContainer${currentSectionId}">
          <!-- Questions for this section will be added here -->
        </div>
        <button type="button" class="btn btn-info add-question-btn" data-section-id="${currentSectionId}">Add Question</button>
        <button type="button" class="btn btn-danger remove-section-btn" data-section-id="${currentSectionId}">Remove Section</button>
        <hr>
      `;
      sectionsContainer.appendChild(sectionDiv);

      // Add event listeners for the new section's buttons
      sectionDiv.querySelector('.add-question-btn').addEventListener('click', (e) => addQuestion(e.target.dataset.sectionId));
      sectionDiv.querySelector('.remove-section-btn').addEventListener('click', (e) => removeSection(e.target.dataset.sectionId));

      // Populate questions if sectionData has them
      if (sectionData.questions) {
          sectionData.questions.forEach(question => addQuestion(currentSectionId, question));
      }
    }

    function removeSection(sectionId) {
        showConfirmation('Are you sure you want to remove this section and all its questions?').then(confirmed => {
            if (confirmed) {
                document.querySelector(`.section-card[data-section-id="${sectionId}"]`).remove();
                showPageMessage('Section removed successfully.', 'info');
            }
        });
    }

    function addQuestion(sectionId, questionData = {}) {
      questionCounter++;
      const currentQuestionId = questionData.question_id || `new-${questionCounter}`; // Use existing ID or generate new
      const questionsContainer = document.getElementById(`questionsContainer${sectionId}`);
      const questionDiv = document.createElement('div');
      questionDiv.classList.add('question-card');
      questionDiv.dataset.questionId = currentQuestionId;
      questionDiv.innerHTML = `
        <h4>Question ${questionCounter}</h4>
        <div class="form-group">
          <label for="questionText${currentQuestionId}">Question Text:</label>
          <textarea id="questionText${currentQuestionId}" class="question-text" rows="3" required>${questionData.question_text || ''}</textarea>
        </div>
        <div class="form-group">
          <label>Options:</label>
          <div class="question-options">
            <label><input type="radio" name="correctAnswer${currentQuestionId}" value="A" ${questionData.correct_answer === 'A' ? 'checked' : ''} required> A: <input type="text" class="option-a" value="${questionData.options?.A || ''}" required></label>
            <label><input type="radio" name="correctAnswer${currentQuestionId}" value="B" ${questionData.correct_answer === 'B' ? 'checked' : ''}> B: <input type="text" class="option-b" value="${questionData.options?.B || ''}" required></label>
            <label><input type="radio" name="correctAnswer${currentQuestionId}" value="C" ${questionData.correct_answer === 'C' ? 'checked' : ''}> C: <input type="text" class="option-c" value="${questionData.options?.C || ''}" required></label>
            <label><input type="radio" name="correctAnswer${currentQuestionId}" value="D" ${questionData.correct_answer === 'D' ? 'checked' : ''}> D: <input type="text" class="option-d" value="${questionData.options?.D || ''}" required></label>
          </div>
        </div>
        <div class="form-group">
          <label for="explanation${currentQuestionId}">Explanation (Optional):</label>
          <textarea id="explanation${currentQuestionId}" class="explanation" rows="2">${questionData.explanation || ''}</textarea>
        </div>
        <button type="button" class="btn btn-danger remove-question-btn" data-question-id="${currentQuestionId}">Remove Question</button>
      `;
      questionsContainer.appendChild(questionDiv);

      // Add event listener for the new question's remove button
      questionDiv.querySelector('.remove-question-btn').addEventListener('click', (e) => removeQuestion(e.target.dataset.questionId));
    }

    function removeQuestion(questionId) {
        showConfirmation('Are you sure you want to remove this question?').then(confirmed => {
            if (confirmed) {
                document.querySelector(`.question-card[data-question-id="${questionId}"]`).remove();
                showPageMessage('Question removed successfully.', 'info');
            }
        });
    }

    document.getElementById('addSectionBtn').addEventListener('click', addSection);

    document.getElementById('examForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const confirmed = await showConfirmation('Are you sure you want to save changes to this exam?');
      if (!confirmed) {
          showPageMessage('Exam update cancelled.', 'info');
          return;
      }

      const examTitle = document.getElementById('examTitle').value;
      const subjectId = document.getElementById('subject').value;
      const classLevelId = document.getElementById('classLevel').value;
      const examType = document.getElementById('examType').value;
      const durationMinutes = parseInt(document.getElementById('duration').value);
      const passMark = parseInt(document.getElementById('passMark').value);
      const maxScore = parseInt(document.getElementById('maxScore').value);
      const term = document.getElementById('term').value;
      const session = document.getElementById('session').value;
      const scheduledTime = document.getElementById('scheduledTime').value;
      const isLocked = document.getElementById('isLocked').checked;

      const sections = [];
      document.querySelectorAll('.section-card').forEach((sectionDiv, index) => {
        const sectionName = sectionDiv.querySelector('.section-name').value;
        const sectionInstructions = sectionDiv.querySelector('.section-instructions').value;
        const sectionDbId = sectionDiv.dataset.sectionId.startsWith('new-') ? null : parseInt(sectionDiv.dataset.sectionId); // Get DB ID or null for new
        const sectionOrder = index + 1; // Re-calculate order based on current position

        const questions = [];
        sectionDiv.querySelectorAll('.question-card').forEach((questionDiv, qIndex) => {
          const questionText = questionDiv.querySelector('.question-text').value;
          const optionA = questionDiv.querySelector('.option-a').value;
          const optionB = questionDiv.querySelector('.option-b').value;
          const optionC = questionDiv.querySelector('.option-c').value;
          const optionD = questionDiv.querySelector('.option-d').value;
          const correctAnswer = questionDiv.querySelector(`input[name="correctAnswer${questionDiv.dataset.questionId}"]:checked`).value;
          const explanation = questionDiv.querySelector('.explanation').value;
          const questionDbId = questionDiv.dataset.questionId.startsWith('new-') ? null : parseInt(questionDiv.dataset.questionId); // Get DB ID or null for new

          questions.push({
            question_id: questionDbId, // Include ID for updates/deletes
            question_text: questionText,
            options: { A: optionA, B: optionB, C: optionC, D: optionD },
            correct_answer: correctAnswer,
            explanation: explanation
          });
        });

        sections.push({
          section_id: sectionDbId, // Include ID for updates/deletes
          section_name: sectionName,
          section_instructions: sectionInstructions,
          section_order: sectionOrder,
          questions: questions
        });
      });

      const examData = {
        title: examTitle,
        subject_id: parseInt(subjectId),
        class_level_id: parseInt(classLevelId),
        exam_type: examType,
        duration_minutes: durationMinutes,
        pass_mark: passMark,
        max_score: maxScore,
        term: term,
        session: session,
        scheduled_time: scheduledTime || null,
        is_locked: isLocked,
        sections: sections
      };

      try {
        const response = await fetch(`/api/exams/${examIdToEdit}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(examData),
          credentials: 'include'
        });

        const result = await response.json();
        if (!response.ok) {
          throw new Error(result.error || 'Failed to update exam.');
        }

        showPageMessage('Exam updated successfully!', 'success');
        // Optionally, redirect or reload data
        // window.location.href = '/dashboard.html'; 
      } catch (error) {
        console.error("Error updating exam:", error);
        showPageMessage(`Failed to update exam: ${error.message}`, 'error');
      }
    });

    // Function to load exam data for editing
    async function loadExamForEdit() {
        document.getElementById('loadingMessage').classList.remove('hidden');
        document.getElementById('examForm').classList.add('hidden');
        document.getElementById('pageMessage').classList.add('hidden');

        const urlParams = new URLSearchParams(window.location.search);
        examIdToEdit = urlParams.get('examId');

        if (!examIdToEdit) {
            showPageMessage("No exam ID provided for editing.", 'error');
            return;
        }

        try {
            const response = await fetch(`/api/exams/${examIdToEdit}`, { credentials: 'include' });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to fetch exam data.');
            }
            const examData = await response.json();
            
            // Populate main exam details
            document.getElementById('examTitle').value = examData.title;
            document.getElementById('subject').value = examData.subject_id;
            document.getElementById('classLevel').value = examData.class_level_id;
            document.getElementById('examType').value = examData.exam_type;
            document.getElementById('duration').value = examData.duration_minutes;
            document.getElementById('passMark').value = examData.pass_mark;
            document.getElementById('maxScore').value = examData.max_score;
            document.getElementById('term').value = examData.term;
            document.getElementById('session').value = examData.session;
            document.getElementById('isLocked').checked = examData.is_locked;

            // Handle scheduled_time (convert from DB format to datetime-local input format)
            if (examData.scheduled_time) {
                const date = new Date(examData.scheduled_time);
                // Format to YYYY-MM-DDTHH:MM
                const formattedDate = date.getFullYear() + '-' + 
                                      String(date.getMonth() + 1).padStart(2, '0') + '-' + 
                                      String(date.getDate()).padStart(2, '0') + 'T' + 
                                      String(date.getHours()).padStart(2, '0') + ':' + 
                                      String(date.getMinutes()).padStart(2, '0');
                document.getElementById('scheduledTime').value = formattedDate;
            } else {
                document.getElementById('scheduledTime').value = '';
            }

            // Clear existing sections before populating
            document.getElementById('sectionsContainer').innerHTML = '';
            sectionCounter = 0;
            questionCounter = 0;

            // Populate sections and questions
            if (examData.sections && examData.sections.length > 0) {
                examData.sections.sort((a, b) => a.section_order - b.section_order); // Ensure order
                examData.sections.forEach(section => {
                    addSection(section); // Pass section data to populate
                });
            }

            document.getElementById('loadingMessage').classList.add('hidden');
            document.getElementById('examForm').classList.remove('hidden');

        } catch (error) {
            console.error("Error loading exam for edit:", error);
            showPageMessage(`Failed to load exam: ${error.message}`, 'error');
        }
    }

    // Initial load
    async function loadInitialData() {
        const user = await loadUserData();
        if (user && (user.is_admin || user.role === 'teacher')) {
            await fetchClassLevels();
            await fetchSubjects(); // Load all subjects initially
            document.getElementById('classLevel').addEventListener('change', (e) => {
                fetchSubjects(e.target.value); // Filter subjects by selected class level
            });
            await loadExamForEdit(); // Load exam data after subjects and class levels are fetched
        } else {
            document.querySelector('main').innerHTML = '<h1>Access Denied</h1><p>You do not have permission to edit exams.</p>';
        }
    }

    window.addEventListener('DOMContentLoaded', loadInitialData);
  </script>
</body>
</html>
