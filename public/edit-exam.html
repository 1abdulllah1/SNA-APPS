<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Exam | CBT System</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* General Styles */
    body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.6; }
    main { max-width: 900px; margin: 30px auto; padding: 20px; background: #fff; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); }
    h1, h2, h3 { color: var(--primary-blue); margin-bottom: 1.5rem; }
    hr { border: none; border-top: 1px solid #e0e0e0; margin: 2rem 0; }
    
    /* Form Specifics */
    .app-form { display: flex; flex-direction: column; gap: 1.5rem; }
    .form-group { margin-bottom: 1rem; }
    .form-group label { display: block; margin-bottom: 0.5rem; font-weight: 600; color: #555; }
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #ccc;
      border-radius: 8px; /* Slightly more rounded */
      font-size: 1rem;
      box-sizing: border-box; /* Include padding in width */
    }
    .form-group input[type="checkbox"] { width: auto; margin-right: 10px; }

    .form-grid-col-3 { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; }

    /* Buttons */
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .primary-btn { background-color: var(--primary-blue); color: white; }
    .primary-btn:hover { background-color: var(--primary-dark); transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .danger-btn { background-color: var(--danger-red); color: white; }
    .danger-btn:hover { background-color: #cc0000; transform: translateY(-1px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .add-question-btn, .add-section-btn { background-color: #28a745; color: white; margin-top: 15px; } /* Green for add buttons */
    .add-question-btn:hover, .add-section-btn:hover { background-color: #218838; }

    /* Section and Question Cards */
    .section-card {
      background: #eef4ff; /* Lighter blue background */
      border: 1px solid #c9d9ff;
      border-radius: 12px; /* Consistent rounding */
      padding: 25px;
      margin-bottom: 30px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
    }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 2px solid #b3caff; }
    .section-header h2 { margin: 0; color: var(--primary-blue); }
    .section-actions { display: flex; gap: 10px; }
    .section-instructions, .exam-instructions { min-height: 80px; resize: vertical; }

    .question-card {
      background: #f8f9ff;
      border: 1px solid #e0e5ff;
      border-radius: 10px; /* Consistent rounding */
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .question-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #d1d9ff; }
    .question-header h3 { margin: 0; color: var(--primary-blue); }
    .delete-question-btn { background-color: var(--danger-red); color: white; padding: 6px 12px; font-size: 0.9em; }

    /* Messages */
    .error-message, .info-message, .success-message {
        padding: 10px 15px;
        border-radius: 8px;
        margin-bottom: 1rem;
        text-align: center;
        font-weight: 500;
    }
    .error-message { background-color: #ffebeb; color: var(--danger-red); border: 1px solid var(--danger-red); }
    .info-message { background-color: #e0f7fa; color: #007bb5; border: 1px solid #00acc1; }
    .success-message { background-color: #e6ffed; color: var(--success-green); border: 1px solid var(--success-green); }
    .hidden { display: none; }

    /* Footer */
    footer { text-align: center; padding: 20px; margin-top: 2rem; color: #777; font-size: 0.9em; }

    /* Navbar Styles (copied for consistency) */
    header { background-color: #1a237e; padding: 1rem 0; box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15); font-family: 'Inter', sans-serif; }
    nav { display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    nav .logo { color: #e8eaf6; font-size: 1.8rem; font-weight: 700; text-decoration: none; transition: color 0.3s ease; }
    nav .logo:hover { color: #ffffff; }
    .nav-links { list-style: none; margin: 0; padding: 0; display: flex; gap: 25px; }
    .nav-links li { position: relative; }
    .nav-links .nav-link {
        color: #c5cae9; text-decoration: none; font-size: 1.05rem; font-weight: 500; padding: 8px 0;
        transition: color 0.3s ease, transform 0.2s ease; position: relative; white-space: nowrap;
    }
    .nav-links .nav-link::after { content: ''; position: absolute; left: 0; bottom: 0; width: 0; height: 2px; background-color: #ffffff; transition: width 0.3s ease; }
    .nav-links .nav-link:hover { color: #ffffff; transform: translateY(-2px); }
    .nav-links .nav-link:hover::after, .nav-links .nav-link.active::after { width: 100%; }
    .logout-btn { background-color: #f44336; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; font-size: 1rem; }
    .logout-btn:hover { background-color: #d32f2f; }
    @media (max-width: 768px) {
        nav { flex-direction: column; align-items: flex-start; }
        .nav-links { flex-direction: column; width: 100%; gap: 5px; margin-top: 15px; }
        .nav-links .nav-link { padding: 10px 15px; width: calc(100% - 30px); border-radius: 6px; }
        .nav-links .nav-link:hover::after, .nav-links .nav-link.active::after { width: 0; }
        .nav-links .nav-link:hover { background-color: rgba(255, 255, 255, 0.1); transform: none; }
    }
    /* Modals */
    .modal {
        display: none; /* Hidden by default */
        position: fixed; /* Stay in place */
        z-index: 1000; /* Sit on top */
        left: 0;
        top: 0;
        width: 100%; /* Full width */
        height: 100%; /* Full height */
        overflow: auto; /* Enable scroll if needed */
        background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
        display: flex; /* Use flexbox for centering */
        align-items: center; /* Center vertically */
        justify-content: center; /* Center horizontally */
    }
    .modal-content {
        background-color: #fefefe;
        margin: auto;
        padding: 0;
        border: 1px solid #888;
        width: 80%; /* Could be responsive */
        max-width: 500px;
        border-radius: 10px; /* Rounded corners */
        box-shadow: 0 8px 30px rgba(0,0,0,0.25);
        overflow: hidden; /* Ensures rounded corners on content */
    }
    .modal-header {
        padding: 15px 20px;
        background-color: var(--primary-blue);
        color: white;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-radius: 10px 10px 0 0;
    }
    .modal-header h2 {
        margin: 0;
        font-size: 1.2rem;
    }
    .modal-body {
        padding: 20px;
        text-align: center;
    }
    .modal-footer {
        padding: 15px 20px;
        background-color: #f1f1f1;
        text-align: right;
        border-top: 1px solid #e0e0e0;
        border-radius: 0 0 10px 10px;
    }
    .close-button {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
    }
    .close-button:hover,
    .close-button:focus {
        color: #ddd;
        text-decoration: none;
        cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="/dashboard.html" class="logo">SNA CBT System</a>
      <ul class="nav-links" id="navLinksContainer">
        </ul>
    </nav>
  </header>

  <main>
    <div class="container">
      <h1>Edit Exam</h1>
      <form id="editExamForm" class="app-form">
        <div id="formMessage" class="hidden"></div> <!-- Unified message display -->
        <div id="loadingMessage" class="info-message">Loading exam data...</div>

        <div class="form-group">
          <label for="examTitle">Exam Title:</label>
          <input type="text" id="examTitle" name="examTitle" required>
        </div>

        <div class="form-grid-col-3">
          <div class="form-group">
            <label for="classLevel">Class Level:</label>
            <select id="classLevel" name="classLevel" required>
              <option value="">Select Class Level</option>
            </select>
          </div>
          <div class="form-group">
            <label for="subject">Subject:</label>
            <select id="subject" name="subject" required disabled>
              <option value="">Select Subject</option>
            </select>
          </div>
          <div class="form-group">
            <label for="duration">Duration (minutes):</label>
            <input type="number" id="duration" name="duration" min="1" value="60" required>
          </div>
        </div>

        <!-- NEW: Term and Session fields -->
        <div class="form-grid-col-3">
          <div class="form-group">
            <label for="term">Term:</label>
            <select id="term" name="term" required>
              <option value="">Select Term</option>
              <option value="FIRST">First Term</option>
              <option value="SECOND">Second Term</option>
              <option value="THIRD">Third Term</option>
            </select>
          </div>
          <div class="form-group">
            <label for="session">Academic Session:</label>
            <!-- Changed session from select to text input with pattern -->
            <input type="text" id="session" name="session" required pattern="\d{4}-\d{4}" placeholder="e.g., 2023-2024">
          </div>
        </div>

        <div class="form-group">
          <label for="passMark">Pass Mark:</label>
          <input type="number" id="passMark" name="passMark" min="0" required>
        </div>

        <div class="form-grid-col-3">
          <div class="form-group">
            <label for="startTime">Start Time:</label>
            <input type="datetime-local" id="startTime" name="startTime" required>
          </div>
          <div class="form-group">
            <label for="endTime">End Time:</label>
            <input type="datetime-local" id="endTime" name="endTime" required>
          </div>
        </div>

        <div class="form-group">
          <label for="examType">Exam Type:</label>
          <select id="examType" name="examType" required>
            <option value="">Select Exam Type</option>
            <option value="CA1">Continuous Assessment 1 (CA1)</option>
            <option value="CA2">Continuous Assessment 2 (CA2)</option>
            <option value="CA3">Continuous Assessment 3 (CA3)</option>
            <option value="CA4">Continuous Assessment 4 (CA4)</option>
            <option value="MID_TERM">Mid Term Test</option>
            <option value="MAIN_EXAM">General Exam</option>
            <!-- Removed 'OTHER' as it violates database constraint -->
          </select>
        </div>

        <div class="form-group">
          <label for="isLocked">Lock Exam (Students cannot take it):</label>
          <input type="checkbox" id="isLocked" name="isLocked">
        </div>

        <hr>
        <h2>Exam Sections & Questions</h2>
        <div id="sectionsContainer">
          <!-- Sections will be dynamically added here -->
        </div>

        <button type="button" class="btn add-section-btn" id="addSectionBtn">Add New Section</button>
        <button type="submit" class="btn primary-btn">Save Exam Changes</button>
      </form>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 SNA CBT System. All rights reserved.</p>
  </footer>

  <!-- Modals HTML (add these to the end of your body tag) -->
<div id="confirmationModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Confirm Action</h2>
            <h2>Confirm Action</h2>
            <span class="close-button" onclick="closeModal('confirmationModal')">&times;</span>
        </div>
        <div class="modal-body">
            <p id="confirmationMessage"></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="confirmAction(false)">Cancel</button>
            <button class="btn btn-danger" onclick="confirmAction(true)">Confirm</button>
        </div>
    </div>
</div>

<div id="alertDialog" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="alertTitle">Alert</h2>
            <span class="close-button" onclick="closeModal('alertDialog')">&times;</span>
        </div>
        <div class="modal-body">
            <p id="alertMessage"></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeModal('alertDialog')">OK</button>
        </div>
    </div>
</div>

  <script>
    let currentUser = null; // To store user data
    let examIdToEdit = null; // Store the exam ID from the URL

    // --- Modal Functions (re-used from dashboard.html for consistency) ---
    let currentConfirmationCallback = null; 

    function showConfirmation(message) {
        return new Promise(resolve => {
            const modal = document.getElementById('confirmationModal');
            modal.querySelector('#confirmationMessage').textContent = message;
            modal.style.display = 'flex'; // Use flex to center
            currentConfirmationCallback = resolve;
        });
    }

    function confirmAction(result) {
        if (currentConfirmationCallback) {
            currentConfirmationCallback(result);
            currentConfirmationCallback = null; 
        }
        closeModal('confirmationModal');
    }

    function showAlert(message, title = "Alert") {
        const modal = document.getElementById('alertDialog');
        modal.querySelector('#alertTitle').textContent = title;
        modal.querySelector('#alertMessage').textContent = message;
        modal.style.display = 'flex'; // Use flex to center
    }

    function closeModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    // --- End Modal Functions ---

    // Utility function to display messages
    function showMessage(message, type = 'info') {
      const msgDiv = document.getElementById('formMessage');
      msgDiv.textContent = message;
      msgDiv.className = `message ${type}-message`; // Reset classes
      msgDiv.classList.remove('hidden');
      setTimeout(() => {
        msgDiv.classList.add('hidden');
      }, 5000); // Hide after 5 seconds
    }

    // Function to load user data and build navigation
    async function loadUserData() {
        try {
            const response = await fetch('/api/users/me', { credentials: 'include' });
            if (!response.ok) {
                window.location.href = '/login.html'; // Redirect to login if not authenticated
                return null;
            }
            currentUser = await response.json();
            createNavigationLinks(currentUser); // Build navigation based on user role
            return currentUser;
        } catch (error) {
            console.error("Error loading user data:", error);
            window.location.href = '/login.html'; // Redirect on error
            return null;
        }
    }

    function createNavigationLinks(user) {
        const navLinksContainer = document.getElementById('navLinksContainer');
        navLinksContainer.innerHTML = ''; // Clear existing links

        const links = [
            { href: "/dashboard.html", text: "Dashboard" },
            { href: "/create-exam.html", text: "Create Exam", roles: ['admin', 'teacher'] },
            { href: "/manage-users.html", text: "Manage Users", roles: ['admin'] },
            { href: "/admin-reports.html", text: "Student Reports", roles: ['admin', 'teacher'] },
        ];

        links.forEach(linkInfo => {
            const shouldDisplay = !linkInfo.roles || linkInfo.roles.some(role => {
                if (role === 'admin') return user.is_admin;
                return user.role === role;
            });

            if (shouldDisplay) {
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.href = linkInfo.href;
                link.textContent = linkInfo.text;
                link.classList.add('nav-link');
                // Add active class if current page
                if (window.location.pathname === linkInfo.href) {
                    link.classList.add('active');
                }
                listItem.appendChild(link);
                navLinksContainer.appendChild(listItem);
            }
        });

        // Add logout button
        const logoutLinkItem = document.createElement('li');
        const logoutBtn = document.createElement('button');
        logoutBtn.textContent = "Logout";
        logoutBtn.className = 'btn logout-btn'; // Use a specific class for styling
        logoutLinkItem.appendChild(logoutBtn);
        navLinksContainer.appendChild(logoutLinkItem);

        logoutBtn.addEventListener('click', handleLogout);
    }

    async function handleLogout() {
        try {
            const response = await fetch('/api/users/logout', { method: 'POST', credentials: 'include' });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                console.warn('Logout API call failed:', errorData.error || 'Server responded with an error.');
            }
        } catch (error) {
            console.error('Network error during logout:', error);
        } finally {
            localStorage.clear(); // Clear any local storage
            sessionStorage.clear(); // Clear any session storage
            window.location.href = '/login.html'; // Redirect to login page
        }
    }

    // Global counter for sections and questions to ensure unique IDs during dynamic addition
    let sectionCounter = 0;
    let questionCounter = 0;

    // Function to add a new section to the form
    function addSection(sectionData = {}) {
      sectionCounter++;
      const sectionId = `section-${sectionCounter}`;
      const sectionHtml = `
        <div class="section-card" id="${sectionId}">
          <div class="section-header">
            <h2>Section ${sectionCounter}</h2>
            <div class="section-actions">
              <button type="button" class="btn danger-btn delete-section-btn" data-section-id="${sectionId}">Delete Section</button>
            </div>
          </div>
          <div class="form-group">
            <label for="sectionName-${sectionId}">Section Name:</label>
            <input type="text" id="sectionName-${sectionId}" name="sectionName" value="${sectionData.section_name || ''}" required>
          </div>
          <div class="form-group">
            <label for="sectionInstructions-${sectionId}">Section Instructions:</label>
            <textarea id="sectionInstructions-${sectionId}" name="sectionInstructions" rows="3">${sectionData.section_instructions || ''}</textarea>
          </div>
          <hr>
          <h3>Questions for Section ${sectionCounter}</h3>
          <div id="questionsContainer-${sectionId}">
            <!-- Questions will be added here -->
          </div>
          <button type="button" class="btn add-question-btn" data-section-id="${sectionId}">Add New Question</button>
        </div>
      `;
      document.getElementById('sectionsContainer').insertAdjacentHTML('beforeend', sectionHtml);

      // Add event listener for "Add New Question" button in this new section
      document.querySelector(`#${sectionId} .add-question-btn`).addEventListener('click', (e) => {
        addQuestion(e.target.dataset.sectionId);
      });

      // Add event listener for "Delete Section" button
      document.querySelector(`#${sectionId} .delete-section-btn`).addEventListener('click', (e) => {
        const idToDelete = e.target.dataset.sectionId;
        showConfirmation(`Are you sure you want to delete Section ${idToDelete.split('-')[1]} and all its questions?`).then(confirmed => {
            if (confirmed) {
                document.getElementById(idToDelete).remove();
                updateCalculatedMarks(); // Recalculate total marks
            }
        });
      });

      // If sectionData has questions, add them
      if (sectionData.questions && sectionData.questions.length > 0) {
          sectionData.questions.forEach(q => addQuestion(sectionId, q));
      }
    }

    // Function to add a new question to a specific section
    function addQuestion(sectionId, questionData = {}) {
      questionCounter++;
      const questionId = `question-${questionCounter}`;
      const questionHtml = `
        <div class="question-card" id="${questionId}">
          <div class="question-header">
            <h3>Question ${questionCounter}</h3>
            <button type="button" class="btn danger-btn delete-question-btn" data-question-id="${questionId}">Delete Question</button>
          </div>
          <div class="form-group">
            <label for="questionText-${questionId}">Question Text:</label>
            <textarea id="questionText-${questionId}" name="questionText" rows="3" required>${questionData.question_text || ''}</textarea>
          </div>
          <div class="form-grid-col-3">
            <div class="form-group">
              <label for="optionA-${questionId}">Option A:</label>
              <input type="text" id="optionA-${questionId}" name="optionA" value="${questionData.option_a || ''}" required>
            </div>
            <div class="form-group">
              <label for="optionB-${questionId}">Option B:</label>
              <input type="text" id="optionB-${questionId}" name="optionB" value="${questionData.option_b || ''}" required>
            </div>
            <div class="form-group">
              <label for="optionC-${questionId}">Option C:</label>
              <input type="text" id="optionC-${questionId}" name="optionC" value="${questionData.option_c || ''}">
            </div>
            <div class="form-group">
              <label for="optionD-${questionId}">Option D:</label>
              <input type="text" id="optionD-${questionId}" name="optionD" value="${questionData.option_d || ''}">
            </div>
            <div class="form-group">
              <label for="correctAnswer-${questionId}">Correct Answer:</label>
              <select id="correctAnswer-${questionId}" name="correctAnswer" required>
                <option value="">Select Correct Option</option>
                <option value="A" ${questionData.correct_answer === 'A' ? 'selected' : ''}>A</option>
                <option value="B" ${questionData.correct_answer === 'B' ? 'selected' : ''}>B</option>
                <option value="C" ${questionData.correct_answer === 'C' ? 'selected' : ''}>C</option>
                <option value="D" ${questionData.correct_answer === 'D' ? 'selected' : ''}>D</option>
              </select>
            </div>
            <div class="form-group">
              <label for="marks-${questionId}">Marks:</label>
              <input type="number" id="marks-${questionId}" name="marks" min="1" value="${questionData.marks || 1}" required>
            </div>
          </div>
          <div class="form-group">
            <label for="explanation-${questionId}">Explanation (Optional):</label>
            <textarea id="explanation-${questionId}" name="explanation" rows="2">${questionData.explanation || ''}</textarea>
          </div>
        </div>
      `;
      document.getElementById(`questionsContainer-${sectionId}`).insertAdjacentHTML('beforeend', questionHtml);

      // Add event listener for "Delete Question" button
      document.querySelector(`#${questionId} .delete-question-btn`).addEventListener('click', (e) => {
        const idToDelete = e.target.dataset.questionId;
        showConfirmation(`Are you sure you want to delete Question ${idToDelete.split('-')[1]}?`).then(confirmed => {
            if (confirmed) {
                document.getElementById(idToDelete).remove();
                updateCalculatedMarks(); // Recalculate total marks
            }
        });
      });

      // Add event listener to marks input for live total marks calculation
      document.getElementById(`marks-${questionId}`).addEventListener('input', updateCalculatedMarks);
      updateCalculatedMarks(); // Initial calculation
    }

    // Function to calculate and display total marks
    function updateCalculatedMarks() {
      let totalMarks = 0;
      document.querySelectorAll('input[name="marks"]').forEach(input => {
        totalMarks += parseInt(input.value) || 0;
      });
      document.getElementById('passMark').max = totalMarks; // Pass mark cannot exceed total marks
      // You might want to display this total somewhere, e.g., in a disabled input or a span
      // For now, it just updates the max for passMark.
      // Example: document.getElementById('totalCalculatedMarks').textContent = totalMarks;
    }

    // Function to load class levels into the dropdown
    async function loadClassLevels() {
      try {
        const response = await fetch('/api/exams/config/class-levels', { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to fetch class levels.');
        const classLevels = await response.json();
        const select = document.getElementById('classLevel');
        select.innerHTML = '<option value="">Select Class Level</option>'; // Reset options
        classLevels.forEach(level => {
          const option = document.createElement('option');
          option.value = level.level_id;
          option.textContent = level.level_name;
          select.appendChild(option);
        });
      } catch (error) {
        console.error("Error loading class levels:", error);
        showMessage(`Error loading class levels: ${error.message}`, 'error');
      }
    }

    // Function to load subjects based on selected class level
    async function loadSubjects(classLevelId, selectedSubjectId = null) {
      const subjectSelect = document.getElementById('subject');
      subjectSelect.innerHTML = '<option value="">Select Subject</option>'; // Reset subjects
      subjectSelect.disabled = true; // Disable until subjects are loaded or no class selected

      if (!classLevelId) return;

      try {
        const response = await fetch(`/api/exams/config/subjects?class_level_id=${classLevelId}`, { credentials: 'include' });
        if (!response.ok) throw new Error('Failed to fetch subjects.');
        const subjects = await response.json();
        subjects.forEach(subject => {
          const option = document.createElement('option');
          option.value = subject.subject_id;
          option.textContent = subject.name;
          if (selectedSubjectId && subject.subject_id == selectedSubjectId) {
              option.selected = true;
          }
          subjectSelect.appendChild(option);
        });
        subjectSelect.disabled = false; // Enable subject select once loaded
      } catch (error) {
        console.error("Error loading subjects:", error);
        showMessage(`Error loading subjects: ${error.message}`, 'error');
      }
    }

    // Function to load exam data for editing
    async function loadExamForEdit() {
        const urlParams = new URLSearchParams(window.location.search);
        examIdToEdit = urlParams.get('examId');

        if (!examIdToEdit) {
            showMessage('No exam ID provided for editing.', 'error');
            document.getElementById('loadingMessage').classList.add('hidden');
            return;
        }

        try {
            const response = await fetch(`/api/exams/${examIdToEdit}`, { credentials: 'include' });
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || 'Failed to fetch exam data for editing.');
            }
            const examData = await response.json();
            
            // Populate form fields
            document.getElementById('examTitle').value = examData.title;
            document.getElementById('classLevel').value = examData.class_level_id;
            // Load subjects after class level is set, then select the correct subject
            await loadSubjects(examData.class_level_id, examData.subject_id);
            document.getElementById('duration').value = examData.duration_minutes;
            document.getElementById('passMark').value = examData.pass_mark;
            document.getElementById('startTime').value = new Date(examData.start_time).toISOString().slice(0, 16);
            document.getElementById('endTime').value = new Date(examData.end_time).toISOString().slice(0, 16);
            document.getElementById('examType').value = examData.exam_type;
            document.getElementById('isLocked').checked = examData.is_locked;
            document.getElementById('term').value = examData.term;
            document.getElementById('session').value = examData.session;
            document.getElementById('examInstructions').value = examData.exam_instructions;


            // Clear existing sections and questions before populating
            document.getElementById('sectionsContainer').innerHTML = '';
            sectionCounter = 0; // Reset counters
            questionCounter = 0;

            // Populate sections and questions
            if (examData.sections && examData.sections.length > 0) {
                examData.sections.forEach(section => addSection(section));
            } else {
                addSection(); // Add a default empty section if none exist
            }
            updateCalculatedMarks(); // Ensure total marks are updated after loading

            document.getElementById('loadingMessage').classList.add('hidden');

        } catch (error) {
            console.error("Error loading exam for edit:", error);
            showMessage(`Error loading exam: ${error.message}`, 'error');
            document.getElementById('loadingMessage').classList.add('hidden');
        }
    }

    // Event listener for class level change
    document.getElementById('classLevel').addEventListener('change', (e) => {
      loadSubjects(e.target.value);
    });

    // Handle form submission for editing
    document.getElementById('editExamForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const form = e.target;
      const formData = new FormData(form);
      const examData = {};

      // Collect top-level exam details
      examData.title = formData.get('examTitle');
      examData.subject_id = parseInt(formData.get('subject'));
      examData.class_level_id = parseInt(formData.get('classLevel'));
      examData.duration_minutes = parseInt(formData.get('duration'));
      examData.pass_mark = parseInt(formData.get('passMark'));
      examData.start_time = formData.get('startTime');
      examData.end_time = formData.get('endTime');
      examData.exam_type = formData.get('examType');
      examData.is_locked = formData.get('isLocked') === 'on'; // Checkbox value
      examData.term = formData.get('term');
      examData.session = formData.get('session');
      examData.exam_instructions = formData.get('examInstructions');

      // Collect sections and questions dynamically
      examData.sections = [];
      let totalMaxScore = 0;

      document.querySelectorAll('.section-card').forEach(sectionCard => {
        const section = {};
        section.section_name = sectionCard.querySelector('input[name="sectionName"]').value;
        section.section_instructions = sectionCard.querySelector('textarea[name="sectionInstructions"]').value;
        section.questions = [];

        sectionCard.querySelectorAll('.question-card').forEach(questionCard => {
          const question = {};
          question.question_text = questionCard.querySelector('textarea[name="questionText"]').value;
          question.option_a = questionCard.querySelector('input[name="optionA"]').value;
          question.option_b = questionCard.querySelector('input[name="optionB"]').value;
          question.option_c = questionCard.querySelector('input[name="optionC"]').value;
          question.option_d = questionCard.querySelector('input[name="optionD"]').value;
          question.correct_answer = questionCard.querySelector('select[name="correctAnswer"]').value;
          question.marks = parseInt(questionCard.querySelector('input[name="marks"]').value);
          question.explanation = questionCard.querySelector('textarea[name="explanation"]').value;
          
          // Basic validation for question fields
          if (!question.question_text || !question.correct_answer || isNaN(question.marks)) {
              showMessage('Please fill in all required question fields (text, correct answer, marks).', 'error');
              return; // Stop submission
          }
          if (question.correct_answer === 'C' && !question.option_c) {
              showMessage('Option C cannot be empty if it is the correct answer.', 'error');
              return;
          }
          if (question.correct_answer === 'D' && !question.option_d) {
              showMessage('Option D cannot be empty if it is the correct answer.', 'error');
              return;
          }

          section.questions.push(question);
          totalMaxScore += question.marks;
        });
        examData.sections.push(section);
      });

      examData.max_score = totalMaxScore; // Set the calculated total max score

      // Basic validation for exam fields
      if (!examData.title || !examData.subject_id || !examData.class_level_id || !examData.duration_minutes || 
          isNaN(examData.pass_mark) || !examData.start_time || !examData.end_time || !examData.exam_type || 
          examData.sections.length === 0) {
          showMessage('Please fill in all required exam details and add at least one section with questions.', 'error');
          return;
      }
      if (examData.pass_mark > examData.max_score) {
          showMessage('Pass mark cannot be greater than total available marks.', 'error');
          return;
      }

      // Show confirmation before submitting
      const confirmed = await showConfirmation('Are you sure you want to save changes to this exam?');
      if (!confirmed) {
          showMessage('Exam update cancelled.', 'info');
          return;
      }

      try {
        const response = await fetch(`/api/exams/${examIdToEdit}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(examData),
          credentials: 'include' // Send cookies for authentication
        });

        const result = await response.json();
        if (!response.ok) {
          throw new Error(result.error || 'Failed to update exam.');
        }

        showMessage('Exam updated successfully!', 'success');
        // Optionally, redirect or reload data
        // window.location.href = '/dashboard.html'; 
      } catch (error) {
        console.error("Error updating exam:", error);
        showMessage(`Failed to update exam: ${error.message}`, 'error');
      }
    });

    // Initial load
    async function loadInitialData() {
        const user = await loadUserData();
        if (user && (user.is_admin || user.role === 'teacher')) {
            await loadClassLevels();
            await loadExamForEdit();
        } else {
            document.querySelector('main').innerHTML = '<h1>Access Denied</h1><p>You do not have permission to create exams.</p>';
        }
    }
  </script>
</body>
</html>
