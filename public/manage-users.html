<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Users | CBT System</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    main { max-width: 1000px; }
    .user-table { width: 100%; border-collapse: collapse; margin-top: 1.5rem; }
    .user-table th, .user-table td { border: 1px solid #ddd; padding: 10px 12px; text-align: left; vertical-align: middle; }
    .user-table th { background-color: var(--primary-blue); color: white; font-weight: 600; }
    .user-table tr:nth-child(even) { background-color: #f8f9fa; }
    .user-actions button { margin-right: 5px; padding: 6px 10px; font-size: 0.85em; }
    .user-profile-pic-thumbnail { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; margin-right: 10px; }
    .user-name-cell { display: flex; align-items: center; }
    #loadingIndicatorUsers { text-align: center; padding: 20px; font-style: italic; color: #666; }
    .hidden { display: none; }
    .error-message {
            color: var(--danger-red);
            background-color: #ffebeb;
            border: 1px solid var(--danger-red);
            padding: 10px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 1rem;
            text-align: center;
        }
  </style>
</head>
<body>
  <header>
    <nav>
        <div class="logo">CBT System</div>
        <ul class="nav-links" id="navLinks">
            <li><a href="#" id="logoutLink" class="nav-link">Logout</a></li>
        </ul>
    </nav>
  </header>

  <main>
    <section class="user-management-section">
      <h1>Manage Users</h1>
      <div id="loadingIndicatorUsers">Loading users...</div>
      <div id="userManagementError" class="error-message hidden"></div>

      <div class="filter-controls">
        <label for="roleFilter">Filter by Role:</label>
        <select id="roleFilter">
          <option value="">All Roles</option>
          <option value="student">Student</option>
          <option value="teacher">Teacher</option>
          <option value="admin">Admin</option>
        </select>

        <label for="searchUsers">Search:</label>
        <input type="text" id="searchUsers" placeholder="Search by name, email, admission no.">
      </div>

      <table class="user-table">
        <thead>
          <tr>
            <th>Picture</th>
            <th>Username</th>
            <th>Full Name</th>
            <th>Email</th>
            <th>Role</th>
            <th>Admission No.</th>
            <th>Class</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="userTableBody">
          </tbody>
      </table>
    </section>
  </main>

  <footer>
    <p>&copy; 2025 CBT System</p>
  </footer>

  <script>
    let allUsersData = []; // To store the full list of users

    async function loadUserDataAndNav() {
        try {
            const response = await fetch('/api/users/me', { credentials: 'include' });
            if (!response.ok) {
                window.location.href = '/login.html';
                return null;
            }
            const user = await response.json();
            document.getElementById('navUsername').textContent = user.username;
            createNavigationLinks(user); // From auth.js
            return user;
        } catch (error) {
            console.error("Error loading user data for navigation:", error);
            window.location.href = '/login.html';
            return null;
        }
    }

    async function loadUsers() {
      document.getElementById('loadingIndicatorUsers').classList.remove('hidden');
      document.getElementById('userManagementError').classList.add('hidden');
      try {
        const response = await fetch('/api/users', { credentials: 'include' });
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        allUsersData = await response.json();
        applyUserFilters(); // Apply filters and display
      } catch (error) {
        console.error('Error fetching users:', error);
        document.getElementById('userManagementError').textContent = 'Failed to load user data: ' + error.message;
        document.getElementById('userManagementError').classList.remove('hidden');
      } finally {
        document.getElementById('loadingIndicatorUsers').classList.add('hidden');
      }
    }

    function applyUserFilters() {
      const roleFilter = document.getElementById('roleFilter').value;
      const searchFilter = document.getElementById('searchUsers').value.toLowerCase();

      const filteredUsers = allUsersData.filter(user => {
        const matchesRole = roleFilter === '' || user.role === roleFilter;
        const matchesSearch = searchFilter === '' ||
                              user.username.toLowerCase().includes(searchFilter) ||
                              user.email.toLowerCase().includes(searchFilter) ||
                              (user.full_name && user.full_name.toLowerCase().includes(searchFilter)) ||
                              (user.admission_number && user.admission_number.toLowerCase().includes(searchFilter));
        return matchesRole && matchesSearch;
      });
      displayUsers(filteredUsers);
    }

    function displayUsers(users) {
      const userTableBody = document.getElementById('userTableBody');
      userTableBody.innerHTML = ''; // Clear existing rows
      if (users.length === 0) {
        userTableBody.innerHTML = '<tr><td colspan="8" style="text-align: center;">No users found matching your criteria.</td></tr>';
        return;
      }

      users.forEach(user => {
        // **CORRECTED**: The src is set directly from the user object.
        // The backend guarantees this URL is valid (e.g., /uploads/... or /images/default_avatar.jpeg)
        const profilePicSrc = user.profile_picture_url; 
        const row = `
          <tr>
            <td><img src="${profilePicSrc}" alt="Profile" class="user-profile-pic-thumbnail"></td>
            </tr>
        `;
        userTableBody.innerHTML += row;
    });
}

    function editUser(userId) {
      window.location.href = `edit-user.html?userId=${userId}`;
    }

    async function deleteUser(userId, element) {
      if (confirm(`Are you sure you want to delete this user (ID: ${userId})? This action cannot be undone and might affect related records if not handled by cascading deletes.`)) {
        try {
            const response = await fetch(`/api/users/${userId}`, { method: 'DELETE', credentials: 'include' });
            const data = await response.json();
            if (response.ok) {
              alert(data.message || 'User deleted successfully.');
              // Re-filter or re-fetch
              allUsersData = allUsersData.filter(u => u.id !== userId);
              applyUserFilters(); // Re-render table with current filters
            } else {
              throw new Error(data.error || 'Failed to delete user.');
            }
        } catch (error) {
            console.error('Delete user error:', error);
            document.getElementById('userManagementError').textContent = error.message;
            document.getElementById('userManagementError').classList.remove('hidden');
        }
      }
    }

    document.getElementById('roleFilter').addEventListener('change', applyUserFilters);
    document.getElementById('searchUsers').addEventListener('input', applyUserFilters);
    
    // Initial load
    async function loadUsersAndNav() {
        await loadUserDataAndNav(); // Load user for navigation and check admin status
        await loadUsers(); // Load all users for management
    }
    window.addEventListener('DOMContentLoaded', loadUsersAndNav);
  </script>
  <script src="/js/auth.js"></script>
</body>
</html>