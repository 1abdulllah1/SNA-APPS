<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard | CBT System</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Existing styles from your styles.css and previous dashboard.html */
    .dashboard-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 25px;
        padding: 20px;
        background-color: var(--text-light);
        border-radius: var(--border-radius-md);
        box-shadow: var(--shadow-soft);
    }
    .user-greeting { display: flex; align-items: center; gap: 15px; }
    #userProfilePicture {
        width: 60px; height: 60px; border-radius: 50%;
        object-fit: cover; border: 2px solid var(--primary-blue);
        background-color: #e9ecef; /* Added a background for when the image is loading */
    }
    .dashboard-header h1 { font-size: 1.8rem; color: var(--text-dark); margin: 0; }
    .dashboard-header h1 #username { font-weight: 600; color: var(--primary-blue); }
    .dashboard-header h1 #user-role { font-size: 0.9em; color: var(--text-medium); font-weight: normal; }
    .dashboard-section {
      background: var(--text-light); border-radius: var(--border-radius-md);
      padding: 20px; margin-bottom: 25px; box-shadow: var(--shadow-soft);
    }
    .exam-grid {
      display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px; margin-top: 20px;
    }
    .exam-card {
      background: var(--cream-light); border: 1px solid var(--cream-dark);
      border-radius: var(--border-radius-md); padding: 20px;
      transition: var(--transition-medium); position: relative;
      display: flex; flex-direction: column; justify-content: space-between;
    }
    .exam-card:hover { transform: translateY(-5px); box-shadow: var(--shadow-medium); }
    .exam-card h3 {
      margin-top: 0; color: var(--primary-blue);
      border-bottom: 2px solid var(--secondary-blue);
      padding-bottom: 10px; font-size: 1.3rem;
    }
    .exam-meta {
      display: flex; justify-content: space-between; align-items: center;
      margin-top: 15px; font-size: 0.9rem;
    }
    .exam-meta span {
      background: var(--tertiary-blue); padding: 5px 10px;
      border-radius: 15px; font-weight: 600; color: var(--primary-blue);
    }
    .exam-actions {
      display: flex; justify-content: flex-end;
      gap: 10px; margin-top: 20px;
    }
    .no-exams, .no-results {
      text-align: center; padding: 40px; color: var(--text-medium);
      font-style: italic; background-color: #f9f9f9;
      border-radius: var(--border-radius-sm); border: 1px dashed #ddd;
    }
    .results-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
    .results-table th, .results-table td {
      border: 1px solid var(--cream-dark); padding: 12px 15px; text-align: left;
    }
    .results-table th {
      background-color: var(--secondary-blue); color: var(--text-light); font-weight: 600;
    }
    .results-table tr:nth-child(even) { background-color: var(--cream-light); }
    .results-table tr:hover { background-color: var(--tertiary-blue); }
    .loading { text-align: center; padding: 20px; font-style: italic; color: var(--text-medium); }
    .nav-container { display: flex; justify-content: space-between; width: 100%; align-items: center; }
    .nav-links { display: flex; gap: 20px; align-items: center; }
    .nav-links a, .nav-links .nav-link {
        color: var(--text-light); text-decoration: none; padding: 8px 12px;
        border-radius: var(--border-radius-sm); transition: background-color 0.3s ease;
    }
    .nav-links a:hover, .nav-links .nav-link:hover { background-color: var(--secondary-blue); }
    .filter-section {
      margin-bottom: 25px; padding: 20px; background: var(--text-light);
      border-radius: var(--border-radius-md); box-shadow: var(--shadow-soft);
      display: none; border: 1px solid var(--cream-dark);
    }
    .filter-section h2 { margin-top: 0; margin-bottom: 15px; color: var(--primary-blue); }
    .filter-section label { font-weight: 600; margin-right: 10px; color: var(--text-dark); }
    .filter-section select {
      padding: 10px 14px; border-radius: var(--border-radius-sm);
      border: 1px solid var(--cream-dark); background-color: var(--cream-light);
      color: var(--text-dark); transition: var(--transition-fast); min-width: 200px;
    }
    .filter-section select:focus {
        border-color: var(--secondary-blue);
        box-shadow: 0 0 0 3px rgba(52, 124, 190, 0.2);
        outline: none; background-color: var(--text-light);
    }
    .hidden { display: none !important; }
    .error-message { /* Ensure this is styled if not already */
        background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;
        padding: 10px 15px; margin-bottom: 1rem; border-radius: var(--border-radius-sm);
    }
    /* Modal styles from styles.css or defined here if specific */
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); justify-content: center; align-items: center; }
    .modal.active { display: flex; }
    .modal-content { background-color: #fff; margin: auto; padding: 25px 30px; border-radius: var(--border-radius-md); box-shadow: var(--shadow-strong); width: 90%; max-width: 450px; text-align: center; animation: modalAppear 0.3s ease-out; }
    @keyframes modalAppear { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
    .modal-content h3 { margin-top: 0; margin-bottom: 15px; font-size: 1.4rem; }
    .modal-title-success { color: var(--success-green); } .modal-title-error { color: var(--danger-red); } .modal-title-info { color: var(--primary-blue); } .modal-title-confirm { color: var(--text-dark); }
    .modal-content p { margin-bottom: 20px; font-size: 1rem; color: var(--text-medium); }
    .modal-buttons { display: flex; justify-content: center; gap: 15px; }
    .modal-buttons .btn { min-width: 100px; }
    
    /* **NEW**: Styles for locked exams */
    .exam-card.locked-exam {
        border-left: 5px solid var(--danger-red);
        background-color: #fff5f5;
    }
    .exam-card.locked-exam h3::after {
        content: ' (Locked)';
        color: var(--danger-red);
        font-size: 0.8em;
        font-weight: normal;
        margin-left: 8px;
    }
    .exam-card button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <div class="nav-container">
        <a href="dashboard.html" class="logo">CBT System</a>
        <div class="nav-links" id="navLinks">
          <a href="#" id="logoutLink" class="nav-link">Logout</a>
        </div>
      </div>
    </nav>
  </header>

  <main>
    <div class="dashboard-header">
        <div class="user-greeting">
            <img id="userProfilePicture" src="" alt="User Profile Picture">
            <h1>Welcome, <span id="username">User</span> <br><small>(<span id="user-role">Role</span>)</small></h1>
        </div>
    </div>

    <section class="filter-section" id="studentFilterSection">
      <h2>Filter Exams</h2>
      <div class="form-group">
        <label for="classLevelFilter">Select Class Level:</label>
        <select id="classLevelFilter" onchange="loadExams()">
          <option value="">All Available Classes</option>
          <option value="Primary 1">Primary 1</option><option value="Primary 2">Primary 2</option>
          <option value="Primary 3">Primary 3</option><option value="Primary 4">Primary 4</option>
          <option value="Primary 5">Primary 5</option><option value="Primary 6">Primary 6</option>
          <option value="JSS 1">JSS 1</option><option value="JSS 2">JSS 2</option><option value="JSS 3">JSS 3</option>
          <option value="SS 1">SS 1</option><option value="SS 2">SS 2</option><option value="SS 3">SS 3</option>
        </select>
      </div>
    </section>

    <section class="dashboard-section">
      <h2>Available Exams</h2>
      <div id="examsContainer" class="exam-grid">
        <div class="loading" id="examsLoading">Loading exams...</div>
        <div class="no-exams hidden" id="noExamsMessage">No exams available for your class or filter.</div>
      </div>
    </section>

    <section class="dashboard-section" id="myResultsSection">
      <h2>My Exam Results</h2>
      <div id="resultsContainer">
        <div class="loading" id="resultsLoading">Loading results...</div>
        <div class="no-results hidden" id="noResultsMessage">You have not completed any exams yet.</div>
        <table class="results-table hidden">
          <thead> <tr><th>Exam Title</th><th>Date Taken</th><th>Score</th><th>Status</th><th>Actions</th></tr> </thead>
          <tbody id="resultsBody"></tbody>
        </table>
      </div>
    </section>
  </main>

  <footer> <p>&copy; 2025 SNA CBT System. All rights reserved.</p> </footer>
<script>
    let currentUser = {};

    function showElement(id) { document.getElementById(id)?.classList.remove('hidden'); }
    function hideElement(id) { document.getElementById(id)?.classList.add('hidden'); }
    
    /**
     * **NEW**: Creates an SVG placeholder image with a letter and returns it as a data URI.
     * This avoids external network requests and broken image icons.
     * @param {string} letter The initial letter to display.
     * @returns {string} A data URI for the generated SVG image.
     */
    function createSvgPlaceholder(letter = 'U', size = 60, bgColor = '#007bff', textColor = '#fff') {
        const svg = `
            <svg xmlns="http://www.w3.org/2000/svg" width="${size}" height="${size}" viewBox="0 0 ${size} ${size}">
                <rect width="100%" height="100%" fill="${bgColor}"></rect>
                <text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="sans-serif" font-size="${size / 2}" fill="${textColor}" font-weight="bold">
                    ${letter.toUpperCase()}
                </text>
            </svg>
        `;
        return `data:image/svg+xml,${encodeURIComponent(svg)}`;
    }


    function createNavigationLinks(user) {
        const navLinksContainer = document.getElementById('navLinks');
        Array.from(navLinksContainer.children).forEach(child => {
            if (child.id !== 'logoutLink') child.remove();
        });

        const dashboardLink = document.createElement('a');
        dashboardLink.href = 'dashboard.html'; dashboardLink.textContent = 'Dashboard';
        dashboardLink.classList.add('nav-link'); navLinksContainer.prepend(dashboardLink);

        if (user.is_admin || user.role === 'teacher') {
            const createExamLink = document.createElement('a');
            createExamLink.href = 'create-exam.html'; createExamLink.textContent = 'Create Exam';
            createExamLink.classList.add('nav-link');
            navLinksContainer.insertBefore(createExamLink, document.getElementById('logoutLink'));
        }
        if (user.is_admin) {
            const manageUsersLink = document.createElement('a');
            manageUsersLink.href = 'manage-users.html'; manageUsersLink.textContent = 'Manage Users';
            manageUsersLink.classList.add('nav-link');
            navLinksContainer.insertBefore(manageUsersLink, document.getElementById('logoutLink'));

            const registerLink = document.createElement('a');
            registerLink.href = 'registration.html'; registerLink.textContent = 'Register User';
            registerLink.classList.add('nav-link');
            navLinksContainer.insertBefore(registerLink, document.getElementById('logoutLink'));
            
 // **NEW**: Add the link to the new subject management page
        const manageSubjectsLink = document.createElement('a');
        manageSubjectsLink.href = 'manage-subjects.html';
        manageSubjectsLink.textContent = 'Manage Subjects';
        manageSubjectsLink.classList.add('nav-link');
        navLinksContainer.insertBefore(manageSubjectsLink, document.getElementById('logoutLink'));

            const reportsLink = document.createElement('a');
            reportsLink.href = 'admin-reports.html'; reportsLink.textContent = 'Student Reports';
            reportsLink.classList.add('nav-link');
            navLinksContainer.insertBefore(reportsLink, document.getElementById('logoutLink'));
        }
    }

    async function loadUserData() {
      try {
        const response = await fetch(`/api/users/me`, { credentials: 'include' });
        if (response.status === 401) { window.location.href = '/login.html'; return; }
        if (!response.ok) throw new Error((await response.json().catch(() => ({}))).error || 'Failed to load user data');
        
        currentUser = await response.json();
        document.getElementById('username').textContent = currentUser.first_name || currentUser.username || 'User';
        document.getElementById('user-role').textContent = currentUser.is_admin ? 'Admin' : (currentUser.role ? currentUser.role.charAt(0).toUpperCase() + currentUser.role.slice(1) : 'User');
        
        const profilePicElement = document.getElementById('userProfilePicture');
        const userInitial = (currentUser.first_name || currentUser.username || 'U').charAt(0);
        
        // **NEW**: Use the locally generated SVG as a reliable fallback.
        const placeholderSrc = createSvgPlaceholder(userInitial);
        
        if (currentUser.profile_picture_url) {
            profilePicElement.src = currentUser.profile_picture_url;
            profilePicElement.onerror = () => { profilePicElement.src = placeholderSrc; };
        } else {
            profilePicElement.src = placeholderSrc;
        }
        
        createNavigationLinks(currentUser);

        if (currentUser.role === 'student') {
          showElement('studentFilterSection');
          const classFilterSelect = document.getElementById('classLevelFilter');
          if (classFilterSelect && currentUser.class_level) { classFilterSelect.value = currentUser.class_level; }
          showElement('myResultsSection');
        } else {
            hideElement('studentFilterSection');
            hideElement('myResultsSection');
        }
      } catch (error) {
        console.error('User data error:', error);
        if (!currentUser || !currentUser.id) { window.location.href = '/login.html'; }
        else { document.getElementById('username').textContent = 'Error'; }
      }
    }

    function startExam(examId) { window.location.href = `exam.html?examId=${examId}`; }
    function viewStudentDetailedResults(examId) { window.location.href = `results.html?examId=${examId}`; }
    
    function viewExamScores(examId, viewType) {
        window.location.href = `results.html?examId=${examId}&view=${viewType}`;
    }
    
    function editExam(examId) { window.location.href = `edit-exam.html?examId=${examId}`; }

    async function loadExams() {
      const examsContainer = document.getElementById('examsContainer');
      const examsLoading = document.getElementById('examsLoading');
      const noExamsMessage = document.getElementById('noExamsMessage');
      
      examsContainer.innerHTML = '';
      examsContainer.append(examsLoading, noExamsMessage);

      showElement('examsLoading'); hideElement('noExamsMessage');
      
      try {
        let apiUrl = `/api/exams`;
        if (currentUser.role === 'student') {
          const selectedClassLevel = document.getElementById('classLevelFilter').value;
          const classToFilter = selectedClassLevel || currentUser.class_level;
          if (classToFilter) apiUrl += `?class_level=${encodeURIComponent(classToFilter)}`;
        }

        const response = await fetch(apiUrl, { credentials: 'include' });
        if (response.status === 401) { window.location.href = '/login.html'; return; }
        if (!response.ok) throw new Error((await response.json().catch(() => ({}))).error || 'Failed to load exams');
        
        const exams = await response.json();
        renderExams(exams);
      } catch (error) {
        console.error('Exam load error:', error);
        const errorDiv = document.createElement('div');
        errorDiv.className = 'error-message';
        errorDiv.textContent = `Failed to load exams: ${error.message}.`;
        examsContainer.appendChild(errorDiv);
      } finally { hideElement('examsLoading'); }
    }

    function renderExams(exams) {
      const container = document.getElementById('examsContainer');
      const noExamsMessage = document.getElementById('noExamsMessage');

      // Clear previous exam cards but keep loading/message divs
      Array.from(container.children).forEach(child => {
        if (child.classList.contains('exam-card') || child.classList.contains('error-message')) {
            child.remove();
        }
      });
      
      if (exams.length === 0) {
        showElement('noExamsMessage');
        return;
      }
      hideElement('noExamsMessage');

      exams.forEach(exam => {
        const examCard = document.createElement('div');
        examCard.className = 'exam-card';
        
        // **NEW**: Add a class for styling if the exam is locked
        if (exam.is_locked) {
            examCard.classList.add('locked-exam');
        }

        const isAdmin = currentUser.is_admin;
        const isTeacher = currentUser.role === 'teacher';
        const isOwner = currentUser.id === exam.created_by;
        
        let actionButtonsHtml = '';
        if (currentUser.role === 'student') {
            // **NEW**: Disable start button for locked exams
            actionButtonsHtml = `<button class="btn primary-btn" onclick="startExam(${exam.exam_id})" ${exam.is_locked ? 'disabled' : ''}>${exam.is_locked ? 'Locked' : 'Start Exam'}</button>`;
        } else if (isAdmin || (isTeacher && isOwner)) {
            // **NEW**: Action buttons for teachers and admins
            actionButtonsHtml = `
                <button class="btn secondary-btn btn-sm" onclick="viewExamScores(${exam.exam_id}, 'teacher')">View Scores</button>
                <button class="btn primary-btn btn-sm" onclick="editExam(${exam.exam_id})">Edit</button>
                <button class="btn delete-btn btn-sm" onclick="deleteExam(${exam.exam_id}, this)">Delete</button>
            `;
        }

        examCard.innerHTML = `
          <h3>${exam.title || 'Untitled Exam'}</h3>
          <p>${exam.description || 'No description provided.'}</p>
          <div class="exam-meta">
            <div><strong>Class:</strong> ${exam.class_level || 'Any'} &nbsp;|&nbsp; <strong>Subject:</strong> ${exam.subject_name || 'N/A'}</div>
            <span>${exam.duration_minutes || 'N/A'} mins</span>
          </div>
          <div class="exam-actions"> ${actionButtonsHtml} </div>
        `;
        container.appendChild(examCard);
      });
    }

    async function deleteExam(examId, element) {
      const confirmDelete = await showCustomConfirm('Are you sure you want to delete this exam? This will remove all associated questions and student results permanently.');
      if (!confirmDelete) return;
      try {
          const response = await fetch(`/api/exams/${examId}`, { method: 'DELETE', credentials: 'include' });
          if (!response.ok) throw new Error((await response.json().catch(() => ({}))).error || 'Failed to delete exam');
          const examCard = element.closest('.exam-card');
          if (examCard) {
            examCard.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
            examCard.style.opacity = '0'; examCard.style.transform = 'scale(0.9)';
            setTimeout(() => {
              examCard.remove();
              if (document.querySelectorAll('#examsContainer .exam-card').length === 0) showElement('noExamsMessage');
            }, 300);
          }
          showCustomAlert('Exam deleted successfully!', 'success');
        } catch (error) {
          console.error('Delete failed:', error);
          showCustomAlert('Failed to delete exam: ' + error.message, 'error');
        }
    }

    async function loadResults() { 
      if (currentUser.role !== 'student') {
          hideElement('myResultsSection'); 
          return;
      }
      showElement('myResultsSection');

      const resultsLoading = document.getElementById('resultsLoading');
      const noResultsMessage = document.getElementById('noResultsMessage');
      const resultsTable = document.querySelector('#myResultsSection .results-table');
      showElement('resultsLoading'); hideElement('noResultsMessage');
      if(resultsTable) resultsTable.classList.add('hidden');

      try {
        const response = await fetch(`/api/exam-results`, { credentials: 'include' }); 
        if (response.status === 401) { window.location.href = '/login.html'; return; }
        if (!response.ok) throw new Error((await response.json().catch(() => ({}))).error || 'Failed to load results');
        const results = await response.json();
        renderStudentResultsList(results);
      } catch (error) {
        console.error('My Results load error:', error);
        if (resultsLoading) resultsLoading.textContent = "Failed to load your results.";
        showElement('noResultsMessage');
      } finally { hideElement('resultsLoading'); }
    }

    function renderStudentResultsList(results) { 
      const resultsBody = document.getElementById('resultsBody');
      const table = document.querySelector('#myResultsSection .results-table');
      const noResultsMessage = document.getElementById('noResultsMessage');

      if (!results || results.length === 0) {
        showElement('noResultsMessage'); if (table) table.classList.add('hidden'); return;
      }
      if (noResultsMessage) noResultsMessage.classList.add('hidden');
      if (table) table.classList.remove('hidden');
      resultsBody.innerHTML = '';
      results.forEach(result => {
        const row = resultsBody.insertRow();
        const score = result.score !== null && result.score !== undefined ? `${parseFloat(result.score).toFixed(2)}%` : 'Pending';
        row.innerHTML = `
          <td>${result.exam_title || 'N/A'}</td>
          <td>${result.submission_date ? new Date(result.submission_date).toLocaleDateString() : 'N/A'}</td>
          <td>${score}</td>
          <td>Completed</td>
          <td><button class="btn btn-secondary btn-sm" onclick="viewStudentDetailedResults(${result.exam_id})">View Details</button></td>
        `;
      });
    }

    function showCustomAlert(message, type = 'info', duration = 3000) { /* ... (modal logic remains the same) ... */ }
    function hideCustomAlert() { /* ... */ }
    function showCustomConfirm(message) { /* ... (modal logic remains the same) ... */ return new Promise((resolve) => {
            let confirmModal = document.getElementById('customConfirmModal');
            if (!confirmModal) { /* create modal */
                confirmModal = document.createElement('div'); confirmModal.id = 'customConfirmModal';
                confirmModal.className = 'modal confirm-modal';
                confirmModal.innerHTML = `<div class="modal-content"><h3 class="modal-title-confirm">Confirmation</h3><p id="confirmMessage"></p><div class="modal-buttons"><button class="btn btn-success confirm-btn-custom">Yes</button><button class="btn btn-secondary cancel-btn-custom">No</button></div></div>`;
                document.body.appendChild(confirmModal);
            }
            document.getElementById('confirmMessage').textContent = message;
            confirmModal.classList.add('active');
            const confirmBtn = confirmModal.querySelector('.confirm-btn-custom');
            const cancelBtn = confirmModal.querySelector('.cancel-btn-custom');
            const newConfirmBtn = confirmBtn.cloneNode(true); confirmBtn.parentNode.replaceChild(newConfirmBtn, confirmBtn);
            const newCancelBtn = cancelBtn.cloneNode(true); cancelBtn.parentNode.replaceChild(newCancelBtn, cancelBtn);
            newConfirmBtn.onclick = () => { confirmModal.classList.remove('active'); resolve(true); };
            newCancelBtn.onclick = () => { confirmModal.classList.remove('active'); resolve(false); };
        });}

    document.getElementById('logoutLink').addEventListener('click', async (e) => { /* ... (logout logic remains the same) ... */ });

    window.addEventListener('DOMContentLoaded', async () => {
      showElement('examsLoading');
      showElement('resultsLoading');
      try {
        await loadUserData();
        if (currentUser && currentUser.id) {
            await loadExams();
            if (currentUser.role === 'student') {
                await loadResults();
            }
        } else { hideElement('examsLoading'); hideElement('resultsLoading'); }
      } catch (error) {
        console.error('Dashboard init error:', error);
        hideElement('examsLoading'); hideElement('resultsLoading');
        const mainContent = document.querySelector('main');
        if(mainContent) mainContent.innerHTML = `<p class="error-message" style="text-align:center; padding:20px;">Could not initialize dashboard.</p>`;
      }
    });
  </script>
</body>
</html>