<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Exam Results | CBT System</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    /* Specific styles for results.html */
    .results-container {
      max-width: 950px; /* Wider for admin table */
      margin: 2rem auto;
      padding: 2rem;
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.1);
    }

    .results-header {
      text-align: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }

    .results-main-title { /* For the overall page title "Exam Results" */
        font-size: 2rem;
        color: var(--primary-blue);
        margin-bottom: 0.5rem;
    }
    .exam-specific-title { /* For the actual exam title */
        font-size: 1.5rem;
        color: var(--text-dark);
        font-weight: normal;
        margin-bottom: 1rem;
    }


    /* Student Score Display (for single student view) */
    .student-score-display {
      font-size: 2.5rem;
      font-weight: bold;
      color: var(--success-green);
      margin-bottom: 0.5rem;
    }
    .results-meta { /* For date, duration in student view */
      font-size: 1rem;
      color: #555;
      margin-bottom: 1.5rem;
    }

    /* Admin/Teacher View: Table for all student results */
    .all-results-table {
        width: 100%;
        margin-top: 1.5rem;
        border-collapse: collapse;
    }
    .all-results-table th, .all-results-table td {
        border: 1px solid #ddd;
        padding: 10px 12px;
        text-align: left;
    }
    .all-results-table th {
        background-color: var(--secondary-blue);
        color: white;
        font-weight: 600;
    }
    .all-results-table tr:nth-child(even) {
        background-color: #f9f9f9;
    }
     .all-results-table tr:hover {
        background-color: var(--tertiary-blue);
    }
    .no-submissions-message {
        text-align: center;
        font-style: italic;
        color: var(--text-medium);
        padding: 20px;
        background-color: #f9f9f9;
        border-radius: var(--border-radius-sm);
        margin-top: 1rem;
    }


    /* Question Review Section (for single student view) */
    .question-review-section {
      background: #f9f9f9;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 1.5rem;
      margin-top: 1rem;
      margin-bottom: 1rem;
    }
    .question-review-text {
      font-size: 1.2rem;
      margin-bottom: 1rem;
      color: #333;
      font-weight: 500;
    }
    .review-options-list { list-style: none; padding: 0; margin: 0; }
    .review-option-item { margin-bottom: 0.7rem; }
    .review-option-label {
      display: block;
      padding: 0.7rem 1rem;
      border: 1px solid #dcdcdc;
      border-radius: 6px;
      font-size: 0.95rem;
      color: #444;
      display: flex;
      align-items: center;
      transition: background-color 0.2s;
    }
    .review-option-label input[type="radio"] {
      margin-right: 0.8rem;
      transform: scale(1.1);
      pointer-events: none; /* Disable interaction */
    }
    .review-option-label.correct {
      background-color: #e6ffe6; border-color: #28a745; font-weight: 500;
    }
    .review-option-label.incorrect {
      background-color: #ffe6e6; border-color: #dc3545; font-weight: 500;
    }
    .review-option-label.user-selected:not(.correct):not(.incorrect) { /* User selected, but neither correct nor incorrect (e.g. if correct answer is not shown) */
        border-color: #007bff;
        box-shadow: 0 0 0 1px rgba(0, 123, 255, 0.4);
    }
    .review-option-label.user-selected.incorrect { /* If user selected the incorrect one */
         /* Already styled by .incorrect, but could add more emphasis */
    }


    .explanation {
      background-color: #e9f5ff; /* Lighter blue */
      border-left: 3px solid var(--info-blue);
      padding: 0.8rem 1rem;
      margin-top: 0.8rem;
      border-radius: 4px;
      font-style: italic;
      font-size: 0.9em;
      color: #333;
    }

    .back-to-dashboard-btn {
      display: block;
      width: fit-content;
      margin: 2.5rem auto 0; /* Increased top margin */
      padding: 0.8rem 1.8rem;
      background-color: var(--primary-blue);
      color: white;
      border: none;
      border-radius: var(--border-radius-md);
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.2s ease;
      text-decoration: none;
    }
    .back-to-dashboard-btn:hover { background-color: var(--secondary-blue); }
    .hidden { display: none !important; }
    .loader {
      border: 5px solid #f3f3f3; border-top: 5px solid var(--primary-blue);
      border-radius: 50%; width: 40px; height: 40px;
      animation: spin 1s linear infinite; margin: 50px auto;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .error-message {
      text-align: center; padding: 1rem; margin: 1.5rem auto;
      border-radius: 8px; font-size: 1.1rem; max-width: 600px;
      background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb;
    }
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="dashboard.html" class="logo">CBT System</a>
      <div class="nav-links">
        <span id="navUsername" style="margin-right: 15px;">Guest</span>
        <a href="#" id="logoutLink">Logout</a>
      </div>
    </nav>
  </header>

  <main>
    <div id="loadingIndicator" class="loader"></div>
    <div id="errorMessage" class="error-message hidden"></div>

    <div id="resultsContent" class="results-container hidden">
      <div class="results-header">
        <h1 class="results-main-title">Exam Results</h1>
        <h2 class="exam-specific-title" id="examTitleDisplay"></h2>
      </div>

      <!-- This section will be populated based on viewMode -->
      <div id="resultsDisplayArea">
        <!-- Student's detailed review OR Admin/Teacher's list of results -->
      </div>

      <a href="dashboard.html" class="back-to-dashboard-btn">Back to Dashboard</a>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 SNA CBT System. All rights reserved.</p>
  </footer>

  <script>
    let currentUser = {};

    function showElement(id) { document.getElementById(id)?.classList.remove('hidden'); }
    function hideElement(id) { document.getElementById(id)?.classList.add('hidden'); }
    function displayError(message) {
      const errorDiv = document.getElementById('errorMessage');
      hideElement('loadingIndicator');
      hideElement('resultsContent');
      if(errorDiv) {
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
      }
    }

    async function loadUserData() {
      try {
        const response = await fetch(`/api/users/me`, { credentials: 'include' });
        if (response.status === 401) { window.location.href = '/login.html'; return null; }
        if (!response.ok) throw new Error((await response.json().catch(() => ({}))).error || 'Failed to load user data');
        currentUser = await response.json();
        document.getElementById('navUsername').textContent = currentUser.username || 'User';
        return currentUser;
      } catch (error) {
        console.error('User data error:', error);
        displayError('Failed to load user data. Please try logging in again.');
        return null;
      }
    }

    async function loadExamResults() {
      hideElement('resultsContent');
      hideElement('errorMessage');
      showElement('loadingIndicator');

      const urlParams = new URLSearchParams(window.location.search);
      const examId = urlParams.get('examId');
      const viewType = urlParams.get('view'); // 'admin', 'teacher', or null for student

      if (!examId) {
        displayError('No exam ID provided. Please go back to the dashboard.');
        return;
      }

      try {
        let apiUrl = `/api/exam-results/${examId}`;
        if (viewType === 'admin' || viewType === 'teacher') {
          apiUrl += `?view=${viewType}`;
        }

        const response = await fetch(apiUrl, { credentials: 'include' });
        if (response.status === 401) { window.location.href = '/login.html'; return; }
        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.error || `Failed to load exam results (Status: ${response.status})`);
        }

        const data = await response.json();
        document.getElementById('examTitleDisplay').textContent = data.exam.title || 'Exam Details';
        
        if (data.viewMode === 'admin' || data.viewMode === 'teacher') {
            renderAdminTeacherResults(data.exam, data.results);
        } else if (data.viewMode === 'student') {
            renderStudentResultReview(data.exam, data.questions);
        } else {
            // Fallback or if viewMode is not correctly set by backend for student
            // This case might occur if student directly navigates without `viewMode` being explicitly 'student'
            // but the backend logic for student view was hit.
            if(data.questions && data.exam.student_score !== undefined) {
                 renderStudentResultReview(data.exam, data.questions);
            } else {
                 displayError("Could not determine the correct view for results.");
            }
        }

        hideElement('loadingIndicator');
        showElement('resultsContent');

      } catch (error) {
        console.error('Load exam results error:', error);
        displayError(`Failed to load exam results: ${error.message}.`);
      }
    }

    function renderAdminTeacherResults(exam, results) {
        const displayArea = document.getElementById('resultsDisplayArea');
        displayArea.innerHTML = ''; // Clear previous content

        if (!results || results.length === 0) {
            displayArea.innerHTML = '<p class="no-submissions-message">No students have taken this exam yet.</p>';
            return;
        }

        const table = document.createElement('table');
        table.className = 'all-results-table';
        table.innerHTML = `
            <thead>
                <tr>
                    <th>#</th>
                    <th>Student Name</th>
                    <th>Admission No.</th>
                    <th>Score</th>
                    <th>Date Submitted</th>
                </tr>
            </thead>
            <tbody>
            </tbody>
        `;
        const tbody = table.querySelector('tbody');
        results.forEach((result, index) => {
            const row = tbody.insertRow();
            row.insertCell().textContent = index + 1;
            row.insertCell().textContent = `${result.first_name || ''} ${result.last_name || ''}`;
            row.insertCell().textContent = result.admission_number || 'N/A';
            row.insertCell().textContent = result.score !== undefined ? `${result.score.toFixed(2)}%` : 'N/A';
            row.insertCell().textContent = result.submission_date ? new Date(result.submission_date).toLocaleString() : 'N/A';
        });
        displayArea.appendChild(table);
    }

    function renderStudentResultReview(exam, questions) {
      const displayArea = document.getElementById('resultsDisplayArea');
      displayArea.innerHTML = ''; // Clear previous content

      const summaryDiv = document.createElement('div');
      summaryDiv.className = 'results-header'; // Re-use some styling
      summaryDiv.innerHTML = `
        <div class="student-score-display">${exam.student_score !== undefined ? parseFloat(exam.student_score).toFixed(2) : 'N/A'}%</div>
        <p class="results-meta">
          Date: ${exam.submission_date ? new Date(exam.submission_date).toLocaleDateString() : 'N/A'} |
          Duration: ${exam.duration_minutes || 'N/A'} mins
        </p>
      `;
      displayArea.appendChild(summaryDiv);

      if (!questions || questions.length === 0) {
        displayArea.innerHTML += '<p class="info-message">No questions available for review.</p>';
        return;
      }

      questions.forEach((question, index) => {
        const questionDiv = document.createElement('div');
        questionDiv.className = 'question-review-section';
        const studentAnswerId = question.student_answer; // student_answer is the option ID ('a', 'b', 'c', 'd')

        questionDiv.innerHTML = `
          <p class="question-review-text">${index + 1}. ${question.question_text}</p>
          <ul class="review-options-list">
            ${question.options.map(option => {
              const isCorrect = option.id === question.correct_answer;
              const isUserSelected = option.id === studentAnswerId;
              
              let optionClass = '';
              if (isUserSelected) optionClass += ' user-selected';
              if (isCorrect) optionClass += ' correct';
              else if (isUserSelected && !isCorrect) optionClass += ' incorrect';

              return `
                <li class="review-option-item">
                  <label class="review-option-label ${optionClass.trim()}">
                    <input type="radio" name="review-question-${question.question_id}" value="${option.id}" 
                           ${isUserSelected ? 'checked' : ''} disabled>
                    ${option.text}
                  </label>
                </li>`;
            }).join('')}
          </ul>
          ${question.explanation ? `<div class="explanation"><strong>Explanation:</strong> ${question.explanation}</div>` : ''}
        `;
        displayArea.appendChild(questionDiv);
      });
    }

    document.getElementById('logoutLink').addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        const response = await fetch(`/api/users/logout`, { method: 'POST', credentials: 'include' });
        if (response.ok) {
          localStorage.clear(); sessionStorage.clear(); window.location.href = '/login.html';
        } else {
          alert('Logout failed: ' + ((await response.json().catch(()=>({}))).error || 'Try again.'));
        }
      } catch (error) { alert('Logout failed due to network error.'); }
    });

    window.addEventListener('DOMContentLoaded', async () => {
      const user = await loadUserData();
      if (user) {
        loadExamResults();
      }
    });
  </script>
</body>
</html>
