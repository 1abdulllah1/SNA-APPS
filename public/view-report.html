<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Progress Report | SNA CBT System</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Link to your main stylesheet -->
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Base styles from styles.css are assumed */
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.6; }
        main { max-width: 1000px; margin: 30px auto; padding: 20px; }


        /* Professional Navbar Styling */
        header {
            background-color: #1a237e; /* Deep blue, primary color */
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            font-family: 'Inter', sans-serif;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        nav .logo {
            color: #e8eaf6; /* Light grey-blue for contrast */
            font-size: 1.8rem;
            font-weight: 700;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        nav .logo:hover {
            color: #ffffff;
        }

        .nav-links {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 25px; /* Spacing between links */
        }

        .nav-links li {
            position: relative;
        }

        .nav-links .nav-link {
            color: #c5cae9; /* Lighter blue for links */
            text-decoration: none;
            font-size: 1.05rem;
            font-weight: 500;
            padding: 8px 0;
            transition: color 0.3s ease, transform 0.2s ease;
            position: relative;
            white-space: nowrap; /* Prevent wrapping for nav items */
        }

        .nav-links .nav-link::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 0;
            height: 2px;
            background-color: #ffffff; /* Underline color */
            transition: width 0.3s ease;
        }

        .nav-links .nav-link:hover {
            color: #ffffff;
            transform: translateY(-2px);
        }

        .nav-links .nav-link:hover::after,
        .nav-links .nav-link.active::after {
            width: 100%;
        }

        /* Responsive Navbar (for smaller screens) */
        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                align-items: flex-start;
            }
            .nav-links {
                flex-direction: column;
                width: 100%;
                gap: 5px;
                margin-top: 15px;
            }
            .nav-links .nav-link {
                padding: 10px 15px;
                width: calc(100% - 30px); /* Adjust for padding */
                border-radius: 6px;
            }
            .nav-links .nav-link:hover::after,
            .nav-links .nav-link.active::after {
                width: 0; /* Hide underline on small screens */
            }
            .nav-links .nav-link:hover {
                 background-color: rgba(255, 255, 255, 0.1);
                 transform: none;
            }
        }


        /* Report Card Container Professional Enhancements */
        .report-card-container {
            font-family: 'Roboto', sans-serif;
            background-color: #ffffff;
            border-radius: 12px; /* Softer corners */
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); /* Deeper shadow */
            padding: 30px 40px; /* Increased padding */
            line-height: 1.6;
            color: #34495e; /* Darker text for readability */
        }

        .report-header {
            border-bottom: 5px solid #283593; /* Darker, richer blue border */
            padding-bottom: 15px;
            margin-bottom: 25px;
            text-align: center;
        }

        .school-logo {
            max-width: 100px; /* Slightly larger logo */
            height: auto;
            border-radius: 8px; /* Slightly rounded logo */
        }

        .school-name {
            font-size: 2.2rem; /* Larger school name */
            color: #1a237e; /* Primary school color */
            margin-bottom: 8px;
        }

        .school-address {
            font-size: 0.95rem;
            color: #546e7a; /* Muted grey for address */
        }

        .report-title {
            font-size: 2.0rem;
            color: #1a237e;
            margin-top: 30px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        .section-title {
            font-size: 1.5rem; /* Larger section titles */
            color: #283593;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
            margin-bottom: 20px;
            margin-top: 2rem;
        }

        .info-item strong {
            color: #283593; /* Consistent blue for labels */
        }
        .info-item p {
            font-size: 1.05rem;
            margin: 7px 0;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        /* Table Styling */
        .scores-table, .summary-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden; /* Ensures rounded corners on tables */
            font-size: 0.9rem;
        }

        .scores-table th {
            background-color: #e8eaf6; /* Light blue header */
            color: #283593;
            padding: 12px 15px;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: left;
        }

        .scores-table td {
            padding: 10px 15px;
            color: #455a64;
            text-align: left;
        }

        .scores-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .summary-table td {
             padding: 12px 15px;
             font-weight: 500;
        }
        .summary-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }


        /* Comments section */
        .comments-section textarea {
            width: 100%;
            border: 1px solid #c5cae9; /* Light blue border */
            border-radius: 6px;
            padding: 12px;
            font-size: 1rem;
            color: #34495e;
            background-color: #fcfdff; /* Slightly off-white background */
            resize: vertical;
        }
        .comments-section textarea:disabled {
            background-color: #eceff1; /* Disabled background */
            cursor: not-allowed;
        }

        /* Next Term Begins input styling */
        .next-term-input {
            width: auto; /* Allow it to size based on content */
            padding: 8px 12px;
            border: 1px solid #c5cae9;
            border-radius: 6px;
            font-size: 1rem;
            color: #34495e;
            background-color: #fcfdff;
        }
        .next-term-input:disabled {
            background-color: #eceff1;
            cursor: not-allowed;
        }


        /* Signature Section */
        .signature-section {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 30px;
            border-top: 1px dashed #90a4ae; /* Muted dashed line */
            padding-top: 30px;
            margin-top: 50px;
        }

        .signature-item {
            flex: 1 1 45%; /* Allow items to grow/shrink, minimum 45% width */
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .signature-line {
            border-bottom: 2px solid #546e7a; /* Darker signature line */
            margin-top: 60px; /* More space for signature */
            font-size: 0.9rem;
            color: #546e7a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding-bottom: 5px; /* Space for the line itself */
            width: 100%; /* Ensure line spans full width of its container */
        }

        .signature-preview {
            max-width: 150px;
            max-height: 80px;
            border: 1px solid #ccc;
            margin-bottom: 10px;
            object-fit: contain;
            background-color: #f9f9f9;
        }

        .signature-upload-area {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            margin-top: 10px;
        }
        .signature-upload-area input[type="file"] {
            width: 100%;
            max-width: 200px;
            border: 1px solid #c5cae9;
            border-radius: 6px;
            padding: 5px;
            font-size: 0.9rem;
        }
        .signature-upload-area input[type="file"]:disabled {
            background-color: #eceff1;
            cursor: not-allowed;
        }

        /* Action bar buttons */
        .actions-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e8eaf6;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .actions-bar button {
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }
        .actions-bar button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .btn-edit { background-color: #ffa000; color: white; } /* Darker yellow */
        .btn-edit:hover { background-color: #ffb300; }
        .btn-save { background-color: #388e3c; color: white; } /* Darker green */
        .btn-save:hover { background-color: #43a047; }
        .btn-print { background-color: #1976d2; color: white; } /* Darker blue */
        .btn-print:hover { background-color: #2196f3; }

        /* General Modal Styling (ensure consistency) */
        .modal {
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex; /* Use flexbox for centering */
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 0;
            border: 1px solid #888;
            width: 80%; /* Could be responsive */
            max-width: 500px;
            border-radius: 10px; /* Rounded corners */
            box-shadow: 0 8px 30px rgba(0,0,0,0.25);
            overflow: hidden; /* Ensures rounded corners on content */
        }
        .modal-header {
            padding: 15px 20px;
            background-color: #1a237e; /* Match header color */
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px 10px 0 0;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 1.2rem;
        }
        .modal-body {
            padding: 20px;
            text-align: center;
        }
        .modal-footer {
            padding: 15px 20px;
            background-color: #f1f1f1;
            text-align: right;
            border-top: 1px solid #e0e0e0;
            border-radius: 0 0 10px 10px;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .close-button:hover,
        .close-button:focus {
            color: #ddd;
            text-decoration: none;
            cursor: pointer;
        }
        .profile-picture-display{
            height: 120px;
            width: 120px; /* Make it square */
            border-radius: 50%; /* Make it circular */
            object-fit: cover;
            margin: 0 auto 20px; /* Center and add margin below */
            display: block; /* Ensures margin auto works */
            border: 3px solid #1a237e; /* Border matching school theme */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .loading-message, .error-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }
        .loading-message { background-color: #e0f7fa; color: #007bb5; border: 1px solid #00acc1; }
        .error-message { background-color: #ffebee; color: #d32f2f; border: 1px solid #d32f2f; }
        .hidden { display: none; }

        /* Media queries for responsiveness */
        @media (max-width: 600px) {
            .report-card-container {
                padding: 20px;
            }
            .school-name {
                font-size: 1.8rem;
            }
            .report-title {
                font-size: 1.5rem;
            }
            .section-title {
                font-size: 1.2rem;
            }
            .info-grid {
                grid-template-columns: 1fr;
            }
            .actions-bar {
                flex-direction: column;
                gap: 10px;
            }
            .actions-bar button {
                width: 100%;
            }
        }

        /* Print-specific styles */
        @media print {
            header, .actions-bar, footer, .modal {
                display: none !important; /* Hide header, action buttons, and footer when printing */
            }
            main {
                margin: 0;
                padding: 0;
                max-width: 100% !important; /* Ensure report takes full width on print */
            }
            .report-card-container {
                box-shadow: none !important; /* Remove shadow for cleaner print */
                border: none !important; /* Remove border for cleaner print */
                padding: 0 !important; /* Remove padding for full content on print */
            }
            body {
                background-color: #fff !important; /* White background for print */
            }
            /* Ensure text colors are dark for readability on print */
            .school-name, .report-title, .section-title, .info-item strong, .scores-table th {
                color: #000 !important;
            }
            .scores-table td, .school-address, .comments-section textarea {
                color: #333 !important;
            }
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <a href="/dashboard.html" class="logo">SNA CBT System</a>
            <ul class="nav-links" id="navLinks">
                <!-- Navigation links will be dynamically inserted here by JS -->
            </ul>
        </nav>
    </header>

    <div class="actions-bar">
        <button class="btn btn-edit" id="editBtn">Edit Report</button>
        <button class="btn btn-save hidden" id="saveBtn">Save Report</button>
        <button class="btn btn-print" onclick="window.print()">Print Report</button>
    </div>

    <main>
        <div class="report-card-container">
            <div id="loadingMessage" class="loading-message">Loading report...</div>
            <div id="errorMessage" class="error-message hidden"></div>
            <div id="reportContent" class="hidden">
                <div class="report-header">
                    <img src="https://res.cloudinary.com/dyphku0jr/image/upload/v1751046319/new_t7avzn.jpg" alt="School Logo" class="school-logo" onerror="this.onerror=null; this.src='https://res.cloudinary.com/dyphku0jr/image/upload/v1751055034/vector-education-logo_779267-2080_i9yfuv.jpg';">
                    <h1 class="school-name">Sealed Nectar Academy</h1>
                    <p class="school-address">15, Nasirudeen street, 10/10 Bus-stop, Ota, Ogun state<br>Email| sealednec@gmail.com Tell| 08065257209</p>
                </div>

                <div class="student-profile-pic-container" style="text-align: center; margin-top: 25px;">
                    <img id="studentProfilePicture" class="profile-picture-display" src="https://res.cloudinary.com/dyphku0jr/image/upload/v1750662670/default_avatar_sjvhgm.jpg" alt="Student Profile Picture" onerror="this.onerror=null; this.src='https://res.cloudinary.com/dyphku0jr/image/upload/v1750662670/default_avatar_sjvhgm.jpg';">
                </div>

                <h2 class="report-title" id="reportTermSession"></h2>

                <div class="student-info">
                    <h3 class="section-title">Student Information</h3>
                    <div class="info-grid">
                        <div class="info-item"><p><strong>Name:</strong> <span id="studentFullName"></span></p></div>
                        <div class="info-item"><p><strong>Admission No:</strong> <span id="studentAdmissionNo"></span></p></div>
                        <div class="info-item"><p><strong>Class:</strong> <span id="studentClass"></span></p></div>
                        <div class="info-item"><p><strong>Date Generated:</strong> <span id="dateGenerated"></span></p></div>
                    </div>
                </div>

                <div class="scores-section">
                    <h3 class="section-title">Subject Scores</h3>
                    <table class="scores-table">
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>CA (40%)</th>
                                <th>Exam (60%)</th>
                                <th>Final Score</th>
                                <th>1st Term</th>
                                <th>2nd Term</th>
                                <th>3rd Term</th>
                                <th>Cumulative Avg.</th>
                                <th>Grade</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="subjectScoresBody">
                            <!-- Subject scores will be populated by JS -->
                        </tbody>
                    </table>
                </div>

                <div class="summary-section">
                    <h3 class="section-title">Overall Summary</h3>
                    <table class="summary-table">
                        <tr>
                            <td>Grand Total Score:</td>
                            <td id="grandTotalScore"></td>
                        </tr>
                        <tr>
                            <td>Overall Percentage:</td>
                            <td id="overallPercentage"></td>
                        </tr>
                        <tr>
                            <td>Class Position:</td>
                            <td id="classPosition"></td>
                        </tr>
                    </table>
                </div>

                <div class="comments-section">
                    <h3 class="section-title">Comments</h3>
                    <div>
                        <p><strong>Teacher's Comment:</strong></p>
                        <textarea id="teacherComment" rows="3" disabled></textarea>
                    </div>
                    <div style="margin-top: 15px;">
                        <p><strong>Principal's Comment:</strong></p>
                        <textarea id="principalComment" rows="3" disabled></textarea>
                    </div>
                </div>

                <div class="info-item" style="margin-top: 25px;">
                    <p><strong>Next Term Begins:</strong> <span id="nextTermBeginsDisplay"></span>
                       <input type="date" id="nextTermBeginsInput" class="next-term-input hidden" disabled>
                    </p>
                </div>

                <div class="signature-section">
                    <div class="signature-item">
                        <img id="teacherSignaturePreview" class="signature-preview" src="" alt="Teacher Signature" style="display: none;">
                        <div class="signature-upload-area">
                            <input type="file" id="teacherSignatureUpload" accept="image/*" disabled>
                            <label for="teacherSignatureUpload" class="signature-label">Upload Teacher's Signature</label>
                        </div>
                        <div class="signature-line">Teacher's Signature</div>
                    </div>
                    <div class="signature-item">
                        <img id="principalSignaturePreview" class="signature-preview" src="" alt="Principal Signature" style="display: none;">
                        <div class="signature-upload-area">
                            <input type="file" id="principalSignatureUpload" accept="image/*" disabled>
                            <label for="principalSignatureUpload" class="signature-label">Upload Principal's Signature</label>
                        </div>
                        <div class="signature-line">Principal's Signature</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 SNA CBT System. All rights reserved.</p>
    </footer>

    <!-- Modals HTML -->
    <div id="confirmationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Confirm Action</h2>
                <span class="close-button" onclick="closeModal('confirmationModal')">&times;</span>
            </div>
            <div class="modal-body">
                <p id="confirmationMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="confirmAction(false)">Cancel</button>
                <button class="btn btn-danger" onclick="confirmAction(true)">Confirm</button>
            </div>
        </div>
    </div>

    <div id="alertDialog" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="alertTitle">Alert</h2>
                <span class="close-button" onclick="closeModal('alertDialog')">&times;</span>
            </div>
            <div class="modal-body">
                <p id="alertMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="closeModal('alertDialog')">OK</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let confirmCallback = null; // Callback for confirmation modal

        // --- Modal Functions ---
        function showModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        function showAlert(title, message) {
            document.getElementById('alertTitle').textContent = title;
            document.getElementById('alertMessage').textContent = message;
            showModal('alertDialog');
        }

        function showConfirmation(message) {
            return new Promise((resolve) => {
                document.getElementById('confirmationMessage').textContent = message;
                showModal('confirmationModal');
                confirmCallback = resolve; // Store resolve function
            });
        }

        function confirmAction(result) {
            closeModal('confirmationModal');
            if (confirmCallback) {
                confirmCallback(result); // Call the stored resolve function
                confirmCallback = null; // Clear the callback
            }
        }

        // Utility function to display messages on the page
        function showPageMessage(message, type = 'info') {
            const msgDiv = document.getElementById('errorMessage'); // Re-using errorMessage div for general page messages
            msgDiv.textContent = message;
            msgDiv.className = `message ${type}-message`; // Apply styling classes
            msgDiv.classList.remove('hidden');
            document.getElementById('loadingMessage').classList.add('hidden'); // Hide loading if message appears
            document.getElementById('reportContent').classList.add('hidden'); // Hide content if message appears
        }

        async function loadUserData() {
            try {
                const response = await fetch('/api/users/me', { credentials: 'include' });
                if (!response.ok) {
                    window.location.href = '/login.html'; // Redirect if not authenticated
                    return null;
                }
                currentUser = await response.json();
                createNavigationLinks(currentUser); // Populate navbar
                return currentUser;
            } catch (error) {
                console.error("Error loading user data:", error);
                window.location.href = '/login.html'; // Redirect on error
                return null;
            }
        }

        function createNavigationLinks(user) {
            const navLinksContainer = document.getElementById('navLinks');
            navLinksContainer.innerHTML = ''; // Clear existing links

            const links = [
                { href: "/dashboard.html", text: "Dashboard" },
                { href: "/create-exam.html", text: "Create Exam", roles: ['admin', 'teacher'] },
                { href: "/manage-users.html", text: "Manage Users", roles: ['admin'] },
                { href: "/admin-reports.html", text: "Student Reports", roles: ['admin', 'teacher'] },
                { href: "/manage-subjects.html", text: "Manage Subjects", roles: ['admin'] },
                { href: "/manage-class-levels.html", text: "Manage Levels", roles: ['admin'] },
                { href: "/manage-classes.html", text: "Manage Classes", roles: ['admin'] }
            ];

            links.forEach(linkInfo => {
                const shouldDisplay = !linkInfo.roles || linkInfo.roles.some(role => {
                    if (role === 'admin') return user.is_admin;
                    return user.role === role;
                });

                if (shouldDisplay) {
                    const listItem = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = linkInfo.href;
                    link.textContent = linkInfo.text;
                    link.classList.add('nav-link');
                    // Add active class if current page
                    if (window.location.pathname === linkInfo.href) {
                        link.classList.add('active');
                    }
                    listItem.appendChild(link);
                    navLinksContainer.appendChild(listItem);
                }
            });

            const logoutLinkItem = document.createElement('li');
            const logoutBtn = document.createElement('button');
            logoutBtn.textContent = "Logout";
            logoutBtn.className = 'btn logout-btn';
            logoutBtn.style.background = '#f44336';
            logoutBtn.style.color = 'white';
            logoutBtn.style.border = 'none';
            logoutBtn.style.padding = '8px 15px';
            logoutBtn.style.borderRadius = '5px';
            logoutBtn.style.cursor = 'pointer';
            logoutLinkItem.appendChild(logoutBtn);
            navLinksContainer.appendChild(logoutLinkItem);

            logoutBtn.addEventListener('click', handleLogout);
        }

        async function handleLogout() {
            try {
                const response = await fetch('/api/users/logout', { method: 'POST', credentials: 'include' });
                if (!response.ok) {
                    const errorData = await response.json().catch(() => ({}));
                    console.warn('Logout API call failed:', errorData.error || 'Server responded with an error.');
                }
            } catch (error) {
                console.error('Network error during logout:', error);
            } finally {
                localStorage.clear();
                sessionStorage.clear();
                window.location.href = '/login.html';
            }
        }

        let isEditing = false;

        function toggleEdit(editMode) {
            isEditing = editMode;
            document.getElementById('editBtn').classList.toggle('hidden', isEditing);
            document.getElementById('saveBtn').classList.toggle('hidden', !isEditing);

            const teacherComment = document.getElementById('teacherComment');
            const principalComment = document.getElementById('principalComment');
            const nextTermBeginsInput = document.getElementById('nextTermBeginsInput');
            const nextTermBeginsDisplay = document.getElementById('nextTermBeginsDisplay');

            const teacherSignatureUpload = document.getElementById('teacherSignatureUpload');
            const principalSignatureUpload = document.getElementById('principalSignatureUpload');

            teacherComment.disabled = !isEditing;
            principalComment.disabled = !isEditing;
            teacherSignatureUpload.disabled = !isEditing;
            principalSignatureUpload.disabled = !isEditing;


            if (isEditing) {
                nextTermBeginsDisplay.classList.add('hidden');
                nextTermBeginsInput.classList.remove('hidden');
                nextTermBeginsInput.disabled = false;
                // Set the input value to the display value if it exists
                if (nextTermBeginsDisplay.textContent && nextTermBeginsDisplay.textContent !== 'N/A') {
                    nextTermBeginsInput.value = new Date(nextTermBeginsDisplay.textContent).toISOString().split('T')[0];
                }
            } else {
                nextTermBeginsDisplay.classList.remove('hidden');
                nextTermBeginsInput.classList.add('hidden');
                nextTermBeginsInput.disabled = true;
                // Update display value from input if changed
                if (nextTermBeginsInput.value) {
                    nextTermBeginsDisplay.textContent = new Date(nextTermBeginsInput.value).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                }
            }
        }

        async function loadReport() {
            document.getElementById('loadingMessage').classList.remove('hidden');
            document.getElementById('reportContent').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');

            const urlParams = new URLSearchParams(window.location.search);
            const studentId = urlParams.get('studentId');
            const term = urlParams.get('term');
            const academicYear = urlParams.get('academicYear');

            if (!studentId || !term || !academicYear) {
                showPageMessage("Missing student ID, term, or academic year in the URL. Please navigate from the student reports page.", 'error');
                return;
            }

            try {
                const response = await fetch(`/api/exam-results/report-card/${studentId}?term=${term}&academicYear=${academicYear}`, { credentials: 'include' });
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Failed to load report data.');
                }

                if (!data.student_info || !data.report_data) {
                    throw new Error("Incomplete report data received from server. Missing student_info or report_data.");
                }

                displayReport(data);
                document.getElementById('loadingMessage').classList.add('hidden');
                document.getElementById('reportContent').classList.remove('hidden');

            } catch (error) {
                console.error("Error loading report:", error);
                showPageMessage(`Failed to load report: ${error.message}`, 'error');
            }
        }

        function displayReport(data) {
            const { student_info, report_data, meta_data } = data;

            // Student Information Section
            document.getElementById('studentProfilePicture').src = student_info.profile_picture_url || 'https://res.cloudinary.com/dyphku0jr/image/upload/v1750662670/default_avatar_sjvhgm.jpg';
            document.getElementById('studentFullName').textContent = student_info.username || 'N/A';
            document.getElementById('studentAdmissionNo').textContent = student_info.admission_number || 'N/A';
            document.getElementById('studentClass').textContent = student_info.class_level_name || 'N/A';
            document.getElementById('dateGenerated').textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });

            // Report Title
            const urlParams = new URLSearchParams(window.location.search);
            const term = urlParams.get('term');
            const academicYear = urlParams.get('academicYear');
            document.getElementById('reportTermSession').textContent = `${term ? term.toUpperCase() + ' TERM' : ''} ACADEMIC REPORT FOR ${academicYear || ''}`;

            // Subject Scores Table
            const subjectScoresBody = document.getElementById('subjectScoresBody');
            subjectScoresBody.innerHTML = '';

            if (report_data.subjects && report_data.subjects.length > 0) {
                report_data.subjects.forEach(subject => {
                    const row = `
                        <tr>
                            <td>${subject.subject_name || 'N/A'}</td>
                            <td>${subject.ca_score !== undefined && subject.ca_score !== null ? parseFloat(subject.ca_score).toFixed(2) : 'N/A'}</td>
                            <td>${subject.exam_score !== undefined && subject.exam_score !== null ? parseFloat(subject.exam_score).toFixed(2) : 'N/A'}</td>
                            <td>${subject.total_score !== undefined && subject.total_score !== null ? parseFloat(subject.total_score).toFixed(2) : 'N/A'}</td>
                            <td>${(subject.cumulative_data && subject.cumulative_data['FIRST'] !== undefined && subject.cumulative_data['FIRST'] !== null) ? parseFloat(subject.cumulative_data['FIRST']).toFixed(2) : 'N/A'}</td>
                            <td>${(subject.cumulative_data && subject.cumulative_data['SECOND'] !== undefined && subject.cumulative_data['SECOND'] !== null) ? parseFloat(subject.cumulative_data['SECOND']).toFixed(2) : 'N/A'}</td>
                            <td>${(subject.cumulative_data && subject.cumulative_data['THIRD'] !== undefined && subject.cumulative_data['THIRD'] !== null) ? parseFloat(subject.cumulative_data['THIRD']).toFixed(2) : 'N/A'}</td>
                            <td>${subject.cumulative_avg !== undefined && subject.cumulative_avg !== null ? parseFloat(subject.cumulative_avg).toFixed(2) : 'N/A'}</td>
                            <td>${subject.grade || 'N/A'}</td>
                            <td>${subject.remark || 'N/A'}</td>
                        </tr>
                    `;
                    subjectScoresBody.innerHTML += row;
                });
            } else {
                subjectScoresBody.innerHTML = `<tr><td colspan="10" style="text-align: center;">No subject scores available for this term.</td></tr>`;
            }

            // Overall Summary
            // Using grand_total_score for the sum of all subject scores
            document.getElementById('grandTotalScore').textContent = report_data.grand_total_score !== undefined && report_data.grand_total_score !== null ? parseFloat(report_data.grand_total_score).toFixed(2) : 'N/A';
            // Correctly using overall_percentage for the average percentage
            document.getElementById('overallPercentage').textContent = report_data.overall_percentage !== undefined && report_data.overall_percentage !== null ? `${parseFloat(report_data.overall_percentage).toFixed(2)}%` : 'N/A';
            document.getElementById('classPosition').textContent = report_data.position !== undefined && report_data.class_size !== undefined && report_data.position !== null && report_data.class_size !== null ? `${report_data.position}${getOrdinalSuffix(report_data.position)} of ${report_data.class_size}` : 'N/A';

            // Comments Section
            document.getElementById('teacherComment').value = meta_data.teacher_comment || '';
            document.getElementById('principalComment').value = meta_data.principal_comment || '';

            // Next Term Begins
            const nextTermBeginsDisplay = document.getElementById('nextTermBeginsDisplay');
            const nextTermBeginsInput = document.getElementById('nextTermBeginsInput');
            if (meta_data.next_term_begins) {
                const date = new Date(meta_data.next_term_begins);
                nextTermBeginsDisplay.textContent = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
                nextTermBeginsInput.value = date.toISOString().split('T')[0];
            } else {
                nextTermBeginsDisplay.textContent = 'N/A';
                nextTermBeginsInput.value = '';
            }

            // Signature Previews
            const teacherSignaturePreview = document.getElementById('teacherSignaturePreview');
            const principalSignaturePreview = document.getElementById('principalSignaturePreview');

            if (meta_data.teacher_signature_url) {
                teacherSignaturePreview.src = meta_data.teacher_signature_url;
                teacherSignaturePreview.style.display = 'block';
            } else {
                teacherSignaturePreview.style.display = 'none';
            }

            if (meta_data.principal_signature_url) {
                principalSignaturePreview.src = meta_data.principal_signature_url;
                principalSignaturePreview.style.display = 'block';
            } else {
                principalSignaturePreview.style.display = 'none';
            }
        }

        function getOrdinalSuffix(i) {
            if (isNaN(i) || i === null) return '';
            const j = i % 10,
                k = i % 100;
            if (j == 1 && k != 11) {
                return "st";
            }
            if (j == 2 && k != 12) {
                return "nd";
            }
            if (j == 3 && k != 13) {
                return "rd";
            }
            return "th";
        }

        async function uploadSignature(file) {
            if (!file) return null;

            const formData = new FormData();
            formData.append('signature', file);

            try {
                const response = await fetch('/api/users/upload-signature', {
                    method: 'POST',
                    body: formData,
                    credentials: 'include'
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to upload signature.');
                }
                return result.url; // Return the Cloudinary URL
            } catch (error) {
                console.error("Error uploading signature:", error);
                showAlert('Upload Error', `Failed to upload signature: ${error.message}`);
                return null;
            }
        }

        async function saveReportData() {
            const confirmed = await showConfirmation('Are you sure you want to save these comments and date?');
            if (!confirmed) {
                showAlert('Save Cancelled', 'Report data save was cancelled.');
                return;
            }

            const urlParams = new URLSearchParams(window.location.search);
            const studentId = urlParams.get('studentId');
            const term = urlParams.get('term');
            const academicYear = urlParams.get('academicYear');

            const teacherComment = document.getElementById('teacherComment').value;
            const principalComment = document.getElementById('principalComment').value;
            const nextTermBegins = document.getElementById('nextTermBeginsInput').value; // Get value from input

            const teacherSignatureFile = document.getElementById('teacherSignatureUpload').files[0];
            const principalSignatureFile = document.getElementById('principalSignatureUpload').files[0];

            let teacherSignatureUrl = document.getElementById('teacherSignaturePreview').src;
            let principalSignatureUrl = document.getElementById('principalSignaturePreview').src;

            // Only upload if a new file is selected
            if (teacherSignatureFile) {
                teacherSignatureUrl = await uploadSignature(teacherSignatureFile);
                if (!teacherSignatureUrl) return; // Stop if upload failed
            }
            if (principalSignatureFile) {
                principalSignatureUrl = await uploadSignature(principalSignatureFile);
                if (!principalSignatureUrl) return; // Stop if upload failed
            }

            try {
                const response = await fetch('/api/exam-results/report-card-meta', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        studentId,
                        term,
                        session: academicYear, // Backend expects 'session'
                        teacher_comment: teacherComment,
                        principal_comment: principalComment,
                        next_term_begins: nextTermBegins || null, // Send null if empty
                        teacher_signature_url: teacherSignatureUrl === 'https://res.cloudinary.com/dyphku0jr/image/upload/v1750662670/default_avatar_sjvhgm.jpg' ? null : teacherSignatureUrl, // Don't save default avatar as signature
                        principal_signature_url: principalSignatureUrl === 'https://res.cloudinary.com/dyphku0jr/image/upload/v1750662670/default_avatar_sjvhgm.jpg' ? null : principalSignatureUrl // Don't save default avatar as signature
                    }),
                    credentials: 'include'
                });

                const result = await response.json();
                if (!response.ok) {
                    throw new Error(result.error || 'Failed to save report data.');
                }

                showAlert('Success', 'Report comments and signature saved successfully!');
                toggleEdit(false); // Exit edit mode after saving
                // Re-load report data to ensure display is updated from backend
                await loadReport();

            } catch (error) {
                console.error("Error saving report data:", error);
                showAlert('Error', `Failed to save report data: ${error.message}`);
            }
        }

        // Event listeners for signature file inputs to show preview
        document.getElementById('teacherSignatureUpload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('teacherSignaturePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('teacherSignaturePreview').style.display = 'none';
                document.getElementById('teacherSignaturePreview').src = '';
            }
        });

        document.getElementById('principalSignatureUpload').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('principalSignaturePreview');
                    preview.src = e.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                document.getElementById('principalSignaturePreview').style.display = 'none';
                document.getElementById('principalSignaturePreview').src = '';
            }
        });


        // --- PAGE INITIALIZATION ---
        window.addEventListener('DOMContentLoaded', async () => {
            await loadUserData();
            if (currentUser) {
                loadReport();
            }
        });

        // Event Listeners for report actions
        document.getElementById('editBtn').addEventListener('click', () => toggleEdit(true));
        document.getElementById('saveBtn').addEventListener('click', saveReportData);

    </script>
</body>
</html>
