<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Progress Report | SNA CBT System</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Link to your main stylesheet -->
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Base styles from styles.css are assumed */
        body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; color: #333; line-height: 1.6; }
        main { max-width: 1000px; margin: 30px auto; padding: 20px; }


        /* Professional Navbar Styling */
        header {
            background-color: #1a237e; /* Deep blue, primary color */
            padding: 1rem 0;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.15);
            font-family: 'Inter', sans-serif;
        }

        nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        nav .logo {
            color: #e8eaf6; /* Light grey-blue for contrast */
            font-size: 1.8rem;
            font-weight: 700;
            text-decoration: none;
            transition: color 0.3s ease;
        }

        nav .logo:hover {
            color: #ffffff;
        }

        .nav-links {
            list-style: none;
            margin: 0;
            padding: 0;
            display: flex;
            gap: 25px; /* Spacing between links */
        }

        .nav-links li {
            position: relative;
        }

        .nav-links .nav-link {
            color: #c5cae9; /* Lighter blue for links */
            text-decoration: none;
            font-size: 1.05rem;
            font-weight: 500;
            padding: 8px 0;
            transition: color 0.3s ease, transform 0.2s ease;
            position: relative;
            white-space: nowrap; /* Prevent wrapping for nav items */
        }

        .nav-links .nav-link::after {
            content: '';
            position: absolute;
            left: 0;
            bottom: 0;
            width: 0;
            height: 2px;
            background-color: #ffffff; /* Underline color */
            transition: width 0.3s ease;
        }

        .nav-links .nav-link:hover {
            color: #ffffff;
            transform: translateY(-2px);
        }

        .nav-links .nav-link:hover::after,
        .nav-links .nav-link.active::after {
            width: 100%;
        }

        /* Responsive Navbar (for smaller screens) */
        @media (max-width: 768px) {
            nav {
                flex-direction: column;
                align-items: flex-start;
            }
            .nav-links {
                flex-direction: column;
                width: 100%;
                gap: 5px;
                margin-top: 15px;
            }
            .nav-links .nav-link {
                padding: 10px 15px;
                width: calc(100% - 30px); /* Adjust for padding */
                border-radius: 6px;
            }
            .nav-links .nav-link:hover::after,
            .nav-links .nav-link.active::after {
                width: 0; /* Hide underline on small screens */
            }
            .nav-links .nav-link:hover {
                 background-color: rgba(255, 255, 255, 0.1);
                 transform: none;
            }
        }


        /* Report Card Container Professional Enhancements */
        .report-card-container {
            font-family: 'Roboto', sans-serif;
            background-color: #ffffff;
            border-radius: 12px; /* Softer corners */
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); /* Deeper shadow */
            padding: 30px 40px; /* Increased padding */
            line-height: 1.6;
            color: #34495e; /* Darker text for readability */
        }

        .report-header {
            border-bottom: 5px solid #283593; /* Darker, richer blue border */
            padding-bottom: 15px;
            margin-bottom: 25px;
            text-align: center;
        }

        .school-logo {
            max-width: 100px; /* Slightly larger logo */
            height: auto;
            border-radius: 8px; /* Slightly rounded logo */
        }

        .school-name {
            font-size: 2.2rem; /* Larger school name */
            color: #1a237e; /* Primary school color */
            margin-bottom: 8px;
        }

        .school-address {
            font-size: 0.95rem;
            color: #546e7a; /* Muted grey for address */
        }

        .report-title {
            font-size: 2.0rem;
            color: #1a237e;
            margin-top: 30px;
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
        }

        .section-title {
            font-size: 1.5rem; /* Larger section titles */
            color: #283593;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 8px;
            margin-bottom: 20px;
            margin-top: 2rem;
        }

        .info-item strong {
            color: #283593; /* Consistent blue for labels */
        }
        .info-item p {
            font-size: 1.05rem;
            margin: 7px 0;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        /* Table Styling */
        .scores-table, .summary-table {
            width: 100%;
            border-collapse: collapse;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            overflow: hidden; /* Ensures rounded corners on tables */
            font-size: 0.9rem;
        }

        .scores-table th {
            background-color: #e8eaf6; /* Light blue header */
            color: #283593;
            padding: 12px 15px;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            text-align: left;
        }

        .scores-table td {
            padding: 10px 15px;
            color: #455a64;
            text-align: left;
        }

        .scores-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .summary-table td {
             padding: 12px 15px;
             font-weight: 500;
        }
        .summary-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }


        /* Comments section */
        .comments-section textarea {
            width: 100%;
            border: 1px solid #c5cae9; /* Light blue border */
            border-radius: 6px;
            padding: 12px;
            font-size: 1rem;
            color: #34495e;
            background-color: #fcfdff; /* Slightly off-white background */
            resize: vertical;
        }
        .comments-section textarea:disabled {
            background-color: #eceff1; /* Disabled background */
            cursor: not-allowed;
        }

        /* Signature Section */
        .signature-section {
            display: flex;
            justify-content: space-around;
            flex-wrap: wrap;
            gap: 30px;
            border-top: 1px dashed #90a4ae; /* Muted dashed line */
            padding-top: 30px;
            margin-top: 50px;
        }

        .signature-item {
            flex: 1 1 45%; /* Allow items to grow/shrink, minimum 45% width */
            text-align: center;
        }

        .signature-line {
            border-bottom: 2px solid #546e7a; /* Darker signature line */
            margin-top: 60px; /* More space for signature */
            font-size: 0.9rem;
            color: #546e7a;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding-bottom: 5px; /* Space for the line itself */
        }

        /* Action bar buttons */
        .actions-bar {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #e8eaf6;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .actions-bar button {
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
        }
        .actions-bar button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0,0,0,0.15);
        }
        .btn-edit { background-color: #ffa000; color: white; } /* Darker yellow */
        .btn-edit:hover { background-color: #ffb300; }
        .btn-save { background-color: #388e3c; color: white; } /* Darker green */
        .btn-save:hover { background-color: #43a047; }
        .btn-print { background-color: #1976d2; color: white; } /* Darker blue */
        .btn-print:hover { background-color: #2196f3; }

        /* General Modal Styling (ensure consistency) */
        .modal {
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            display: flex; /* Use flexbox for centering */
            align-items: center; /* Center vertically */
            justify-content: center; /* Center horizontally */
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 0;
            border: 1px solid #888;
            width: 80%; /* Could be responsive */
            max-width: 500px;
            border-radius: 10px; /* Rounded corners */
            box-shadow: 0 8px 30px rgba(0,0,0,0.25);
            overflow: hidden; /* Ensures rounded corners on content */
        }
        .modal-header {
            padding: 15px 20px;
            background-color: #1a237e; /* Match header color */
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-radius: 10px 10px 0 0;
        }
        .modal-header h2 {
            margin: 0;
            font-size: 1.2rem;
        }
        .modal-body {
            padding: 20px;
            text-align: center;
        }
        .modal-footer {
            padding: 15px 20px;
            background-color: #f1f1f1;
            text-align: right;
            border-top: 1px solid #e0e0e0;
            border-radius: 0 0 10px 10px;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s ease;
        }
        .close-button:hover,
        .close-button:focus {
            color: #ddd;
            text-decoration: none;
            cursor: pointer;
        }
        .profile-picture-display{
            height: 120px;
            width: 120px; /* Make it square */
            border-radius: 50%; /* Make it circular */
            object-fit: cover;
            margin: 0 auto 20px; /* Center and add margin below */
            display: block; /* Ensures margin auto works */
            border: 3px solid #1a237e; /* Border matching school theme */
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        .loading-message, .error-message {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 500;
        }
        .loading-message { background-color: #e0f7fa; color: #007bb5; border: 1px solid #00acc1; }
        .error-message { background-color: #ffebee; color: #d32f2f; border: 1px solid #d32f2f; }
        .hidden { display: none; }

        /* Media queries for responsiveness */
        @media (max-width: 600px) {
            .report-card-container {
                padding: 20px;
            }
            .school-name {
                font-size: 1.8rem;
            }
            .report-title {
                font-size: 1.5rem;
            }
            .section-title {
                font-size: 1.2rem;
            }
            .info-grid {
                grid-template-columns: 1fr;
            }
            .actions-bar {
                flex-direction: column;
                gap: 10px;
            }
            .actions-bar button {
                width: 100%;
            }
        }
    </style>
</head>
<body>
  <header>
    <nav>
        <a href="/dashboard.html" class="logo">SNA CBT System</a>
        <ul class="nav-links" id="navLinks">
            <!-- Navigation links will be dynamically inserted here by JS -->
        </ul>
    </nav>
  </header>

  <div class="actions-bar">
      <button class="btn btn-edit" id="editBtn">Edit Report</button>
      <button class="btn btn-save hidden" id="saveBtn">Save Report</button>
      <button class="btn btn-print" onclick="window.print()">Print Report</button>
  </div>

  <main>
    <div class="report-card-container">
        <div id="loadingMessage" class="loading-message">Loading report...</div>
        <div id="errorMessage" class="error-message hidden"></div>
        <div id="reportContent" class="hidden">
            <div class="report-header">
                <img src="https://res.cloudinary.com/dyphku0jr/image/upload/v1751046319/new_t7avzn.jpg" alt="School Logo" class="school-logo" onerror="this.onerror=null; this.src='https://res.cloudinary.com/dyphku0jr/image/upload/v1751055034/vector-education-logo_779267-2080_i9yfuv.jpg';">
                <h1 class="school-name">Sealed Nectar Academy</h1>
                <p class="school-address">15, Nasirudeen street, 10/10 Bus-stop, Ota, Ogun state<br>Email| sealednec@gmail.com   Tell| 08065257209</p>
            </div>

            <div class="student-profile-pic-container" style="text-align: center; margin-top: 25px;">
                <img id="studentProfilePicture" class="profile-picture-display" src="https://res.cloudinary.com/dyphku0jr/image/upload/v1750662670/default_avatar_sjvhgm.jpg" alt="Student Profile Picture" onerror="this.onerror=null; this.src='https://res.cloudinary.com/dyphku0jr/image/upload/v1750662670/default_avatar_sjvhgm.jpg';">
            </div>

            <h2 class="report-title" id="reportTermSession"></h2>
            
            <div class="student-info">
                <h3 class="section-title">Student Information</h3>
                <div class="info-grid">
                    <div class="info-item"><p><strong>Name:</strong> <span id="studentFullName"></span></p></div>
                    <div class="info-item"><p><strong>Admission No:</strong> <span id="studentAdmissionNo"></span></p></div>
                    <div class="info-item"><p><strong>Class:</strong> <span id="studentClass"></span></p></div>
                    <div class="info-item"><p><strong>Date Generated:</strong> <span id="dateGenerated"></span></p></div>
                </div>
            </div>

            <div class="scores-section">
                <h3 class="section-title">Subject Scores</h3>
                <table class="scores-table">
                    <thead>
                        <tr>
                            <th>Subject</th>
                            <th>CA (40%)</th>
                            <th>Exam (60%)</th>
                            <th>Final Score</th>
                            <th>Grade</th>
                            <th>Remarks</th>
                        </tr>
                    </thead>
                    <tbody id="subjectScoresBody">
                        <!-- Subject scores will be populated by JS -->
                    </tbody>
                </table>
            </div>

            <div class="summary-section">
                <h3 class="section-title">Overall Summary</h3>
                <table class="summary-table">
                    <tr>
                        <td>Grand Total Score:</td>
                        <td id="grandTotalScore"></td>
                    </tr>
                    <tr>
                        <td>Overall Percentage:</td>
                        <td id="overallPercentage"></td>
                    </tr>
                    <tr>
                        <td>Class Position:</td>
                        <td id="classPosition"></td>
                    </tr>
                </table>
            </div>

            <div class="comments-section">
                <h3 class="section-title">Comments</h3>
                <div>
                    <p><strong>Teacher's Comment:</strong></p>
                    <textarea id="teacherComment" rows="3" disabled></textarea>
                </div>
                <div style="margin-top: 15px;">
                    <p><strong>Principal's Comment:</strong></p>
                    <textarea id="principalComment" rows="3" disabled></textarea>
                </div>
            </div>

            <div class="info-item" style="margin-top: 25px;">
                <p><strong>Next Term Begins:</strong> <span id="nextTermBegins"></span></p>
            </div>

            <div class="signature-section">
                <div class="signature-item">
                    <div class="signature-line">Teacher's Signature</div>
                </div>
                <div class="signature-item">
                    <div class="signature-line">Principal's Signature</div>
                </div>
            </div>
        </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 Sealed Nectar Academy. All rights reserved.</p>
  </footer>

<div id="confirmationModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Confirm Action</h2>
            <span class="close-button" onclick="closeModal('confirmationModal')">&times;</span>
        </div>
        <div class="modal-body">
            <p id="confirmationMessage"></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="confirmAction(false)">Cancel</button>
            <button class="btn btn-danger" onclick="confirmAction(true)">Confirm</button>
        </div>
    </div>
</div>

<div id="alertDialog" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="alertTitle">Alert</h2>
            <span class="close-button" onclick="closeModal('alertDialog')">&times;</span>
        </div>
        <div class="modal-body">
            <p id="alertMessage"></p>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="closeModal('alertDialog')">OK</button>
        </div>
    </div>
</div>

<script>
    let currentReportData = null; // Store fetched report data
    let currentUser = null; // Store current user data

    // --- Modal Functions ---
    let currentConfirmationCallback = null; 

    function showConfirmation(message) {
        return new Promise(resolve => {
            const modal = document.getElementById('confirmationModal');
            if(modal) {
                modal.querySelector('#confirmationMessage').textContent = message;
                modal.style.display = 'flex'; 
                currentConfirmationCallback = resolve;
            } else {
                resolve(confirm(message));
            }
        });
    }

    function confirmAction(result) {
        if (currentConfirmationCallback) {
            currentConfirmationCallback(result);
            currentConfirmationCallback = null; 
        }
        closeModal('confirmationModal');
    }

    function showAlert(message, title = "Alert") {
        const modal = document.getElementById('alertDialog');
        if(modal) {
            modal.querySelector('#alertTitle').textContent = title;
            modal.querySelector('#alertMessage').textContent = message;
            modal.style.display = 'flex'; 
        } else {
            alert(`${title}: ${message}`);
        }
    }

    function closeModal(modalId) {
        const modal = document.getElementById(modalId);
        if(modal) modal.style.display = 'none';
    }
    // --- End Modal Functions ---

    async function loadUserData() {
        try {
            const response = await fetch('/api/users/me', { credentials: 'include' });
            if (!response.ok) {
                window.location.href = '/login.html';
                return null;
            }
            currentUser = await response.json();
            createNavigationLinks(currentUser);
            return currentUser;
        } catch (error) {
            console.error("Error loading user data:", error);
            window.location.href = '/login.html';
            return null;
        }
    }

    async function loadReport() {
        document.getElementById('loadingMessage').classList.remove('hidden');
        document.getElementById('errorMessage').classList.add('hidden');
        document.getElementById('reportContent').classList.add('hidden');
        document.getElementById('editBtn').classList.add('hidden');
        document.getElementById('saveBtn').classList.add('hidden');

        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('studentId');
        const term = urlParams.get('term');
        const academicYear = urlParams.get('academicYear');

        if (!studentId || !term || !academicYear) {
            showAlert('Missing student ID, term, or academic year in URL.', 'Missing Parameters');
            document.getElementById('loadingMessage').classList.add('hidden');
            return;
        }

        try {
            const response = await fetch(`/api/exam-results/report-card/${studentId}?term=${term}&academicYear=${academicYear}`, { credentials: 'include' });
            
            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                if (response.status === 401 || response.status === 403) {
                    throw new Error('You are not authorized to view this report.');
                }
                throw new Error(errorData.error || `Failed to fetch report card data. Status: ${response.status}`);
            }

            currentReportData = await response.json();
            displayReport(currentReportData, term, academicYear);

            if (currentUser && (currentUser.is_admin || currentUser.role === 'teacher')) {
                document.getElementById('editBtn').classList.remove('hidden');
            }

        } catch (error) {
            console.error("Load report error:", error);
            document.getElementById('errorMessage').textContent = `Error loading report: ${error.message}`;
            document.getElementById('errorMessage').classList.remove('hidden');
        } finally {
            document.getElementById('loadingMessage').classList.add('hidden');
        }
    }

    /**
     * Populates the report card HTML elements with fetched data.
     * @param {Object} data - The report data object from the backend.
     * @param {string} term - The academic term from URL params.
     * @param {string} academicYear - The academic year from URL params.
     */
    function displayReport(data, term, academicYear) {
        if (!data || !data.student || !data.reportCardData) {
            displayError("Incomplete report data received from server.");
            return;
        }
        document.getElementById('reportContent').classList.remove('hidden');

        document.getElementById('reportTermSession').textContent = `${term || 'N/A'} Term Report (${academicYear || 'N/A'})`;
        document.getElementById('dateGenerated').textContent = new Date().toLocaleDateString();

        // Student Information Section
        document.getElementById('studentFullName').textContent = data.student.username || 'N/A';
        document.getElementById('studentAdmissionNo').textContent = data.student.admission_number || 'N/A';
        document.getElementById('studentClass').textContent = data.student.class_level_name || 'Unknown Class';
        
        const profilePicElement = document.getElementById('studentProfilePicture');
        const defaultAvatar = 'https://res.cloudinary.com/dyphku0jr/image/upload/v1750662670/default_avatar_sjvhgm.jpg';
        profilePicElement.src = data.student.profile_picture_url || defaultAvatar;
        profilePicElement.onerror = () => { this.src = defaultAvatar; };

        // Subject Scores Table
        const subjectScoresBody = document.getElementById('subjectScoresBody');
        subjectScoresBody.innerHTML = '';
        
        const subjectsMap = new Map();
        const currentSessionTermKey = `${academicYear || 'N/A'}-${term || 'N/A'}`;
        const currentTermResults = data.reportCardData.find(group => `${group.session || 'N/A'}-${group.term || 'N/A'}` === currentSessionTermKey);

        if (currentTermResults && currentTermResults.exams) {
            currentTermResults.exams.forEach(examResult => {
                const subjectName = examResult.subjectName || 'Uncategorized';
                if (!subjectsMap.has(subjectName)) {
                    subjectsMap.set(subjectName, {
                        subjectName: subjectName,
                        ca_scaled: 'N/A',
                        exam_scaled: 'N/A',
                        finalScore: 'N/A',
                        grade: 'N/A',
                        remark: 'N/A'
                    });
                }
                const subjectEntry = subjectsMap.get(subjectName);

                // *** FIX: Make examType check case-insensitive and safe for null/undefined values
                const examType = (examResult.examType || '').toUpperCase();
                if (examType.startsWith('CA')) {
                    subjectEntry.ca_scaled = examResult.score !== null ? parseFloat(examResult.score).toFixed(1) : 'N/A';
                } else if (examType === 'MAIN_EXAM') {
                    subjectEntry.exam_scaled = examResult.score !== null ? parseFloat(examResult.score).toFixed(1) : 'N/A';
                }
            });

            // Robust final score calculation
            subjectsMap.forEach(subjectEntry => {
                const caScore = subjectEntry.ca_scaled !== 'N/A' ? parseFloat(subjectEntry.ca_scaled) : 0;
                const examScore = subjectEntry.exam_scaled !== 'N/A' ? parseFloat(subjectEntry.exam_scaled) : 0;

                // Only calculate a final score if at least one of the components exists
                if (subjectEntry.ca_scaled !== 'N/A' || subjectEntry.exam_scaled !== 'N/A') {
                    // Weighted score: CA is 40%, Exam is 60%
                    const finalScore = (caScore * 0.4) + (examScore * 0.6);
                    subjectEntry.finalScore = finalScore.toFixed(1);
                    const { grade, remark } = getGradeAndRemark(finalScore);
                    subjectEntry.grade = grade;
                    subjectEntry.remark = remark;
                }
            });
        }

        if (subjectsMap.size > 0) {
            Array.from(subjectsMap.values()).forEach(subject => {
                const row = `
                    <tr>
                        <td>${subject.subjectName}</td>
                        <td>${subject.ca_scaled}</td>
                        <td>${subject.exam_scaled}</td>
                        <td>${subject.finalScore}</td>
                        <td>${subject.grade}</td>
                        <td>${subject.remark}</td>
                    </tr>
                `;
                subjectScoresBody.innerHTML += row;
            });
        } else {
            subjectScoresBody.innerHTML = `<tr><td colspan="6" style="text-align: center;">No subject results found for this term.</td></tr>`;
        }
        
        // Populate summary from the summary object provided by the backend
        document.getElementById('grandTotalScore').textContent = data.summary?.totalScoreObtained ?? 'N/A';
        document.getElementById('overallPercentage').textContent = data.summary?.overallPercentage ? `${data.summary.overallPercentage}%` : 'N/A';
        document.getElementById('classPosition').textContent = data.summary?.position || 'N/A';

        // Comments Section
        document.getElementById('teacherComment').value = data.metadata?.teacher_comment || '';
        document.getElementById('principalComment').value = data.metadata?.principal_comment || '';
        document.getElementById('nextTermBegins').textContent = data.metadata?.next_term_begins ? new Date(data.metadata.next_term_begins).toLocaleDateString() : 'TBA';
    }
    
    function getGradeAndRemark(score) {
        if (isNaN(score) || score === null) return { grade: 'N/A', remark: 'N/A' };
        const p = Math.round(score);
        if (p >= 90) return { grade: 'A*', remark: 'Distinction' };
        if (p >= 80) return { grade: 'A', remark: 'Excellent' };
        if (p >= 75) return { grade: 'B2', remark: 'Very Good' };
        if (p >= 70) return { grade: 'B3', remark: 'Good' };
        if (p >= 65) return { grade: 'C4', remark: 'Credit' };
        if (p >= 60) return { grade: 'C5', remark: 'Pass' };
        if (p >= 50) return { grade: 'C6', remark: 'Pass' };
        if (p >= 40) return { grade: 'D7', remark: 'Needs Improvement' };
        return { grade: 'F', remark: 'Fail' };
    }

    function toggleEdit(isEditing) {
        document.getElementById('teacherComment').disabled = !isEditing;
        document.getElementById('principalComment').disabled = !isEditing;
        document.getElementById('editBtn').classList.toggle('hidden', isEditing);
        document.getElementById('saveBtn').classList.toggle('hidden', !isEditing);
    }

    async function saveReportData() {
        if (!currentReportData || !currentUser || !(currentUser.is_admin || currentUser.role === 'teacher')) {
            showAlert('You do not have permission to save this report.', 'Permission Denied');
            return;
        }

        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('studentId');
        const term = urlParams.get('term');
        const session = urlParams.get('academicYear');
        const teacherComment = document.getElementById('teacherComment').value;
        const principalComment = document.getElementById('principalComment').value;
        
        try {
            const response = await fetch(`/api/exam-results/report-card-meta`, {
                method: 'PUT', // Changed to PUT as it's an update operation
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    studentId,
                    term,
                    session,
                    teacher_comment: teacherComment,
                    principal_comment: principalComment,
                    // next_term_begins could be added here if it's editable
                }),
                credentials: 'include'
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(errorData.error || 'Failed to save report comments.');
            }
            showAlert('Report comments saved successfully!', 'Success');
            toggleEdit(false);
        } catch (error) {
            showAlert('Error saving report: ' + error.message, 'Save Error');
            console.error('Save report error:', error);
        }
    }

    function displayError(message) {
        document.getElementById('loadingMessage').classList.add('hidden');
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
    }

    function createNavigationLinks(user) {
        const navLinksContainer = document.getElementById('navLinks');
        navLinksContainer.innerHTML = '';

        const links = [
            { href: "/dashboard.html", text: "Dashboard" },
            { href: "/create-exam.html", text: "Create Exam", roles: ['admin', 'teacher'] },
            { href: "/manage-users.html", text: "Manage Users", roles: ['admin'] },
            { href: "/admin-reports.html", text: "Student Reports", roles: ['admin', 'teacher'] },
        ];

        links.forEach(linkInfo => {
            const shouldDisplay = !linkInfo.roles || linkInfo.roles.some(role => {
                if (role === 'admin') return user.is_admin;
                return user.role === role;
            });

            if (shouldDisplay) {
                const listItem = document.createElement('li');
                const link = document.createElement('a');
                link.href = linkInfo.href;
                link.textContent = linkInfo.text;
                link.classList.add('nav-link');
                if (window.location.pathname === linkInfo.href) {
                    link.classList.add('active');
                }
                listItem.appendChild(link);
                navLinksContainer.appendChild(listItem);
            }
        });

        const logoutLinkItem = document.createElement('li');
        const logoutBtn = document.createElement('button');
        logoutBtn.textContent = "Logout";
        logoutBtn.className = 'btn logout-btn';
        logoutBtn.style.background = '#f44336';
        logoutBtn.style.color = 'white';
        logoutBtn.style.border = 'none';
        logoutBtn.style.padding = '8px 15px';
        logoutBtn.style.borderRadius = '5px';
        logoutBtn.style.cursor = 'pointer';
        logoutLinkItem.appendChild(logoutBtn);
        navLinksContainer.appendChild(logoutLinkItem);

        logoutBtn.addEventListener('click', handleLogout);
    }

    async function handleLogout() {
        try {
            await fetch('/api/users/logout', { method: 'POST', credentials: 'include' });
        } catch (error) {
            console.error('Logout error:', error);
        } finally {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = '/login.html';
        }
    }

    window.addEventListener('DOMContentLoaded', async () => {
        await loadUserData();
        if (currentUser) {
            loadReport();
        }
    });

    document.getElementById('editBtn').addEventListener('click', () => toggleEdit(true));
    document.getElementById('saveBtn').addEventListener('click', saveReportData);

</script>
</body>
</html>
