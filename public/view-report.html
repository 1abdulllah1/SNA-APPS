<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Progress Report</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #e9ecef;
            font-family: 'Roboto', sans-serif;
            margin: 0;
            -webkit-print-color-adjust: exact;
        }
        .report-card-container {
            width: 210mm;
            min-height: 297mm;
            margin: 1.5rem auto;
            padding: 12mm;
            background: #fff;
            box-shadow: 0 0 25px rgba(0,0,0,0.15);
            color: #333;
        }
        .report-header {
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 4px solid #0d47a1;
        }
        .school-logo { max-width: 90px; margin-bottom: 10px; }
        .school-name { font-size: 26px; font-weight: 700; color: #0d47a1; margin: 0; }
        .school-address { font-size: 13px; margin: 5px 0; }
        .report-title { font-size: 20px; font-weight: 700; background-color: #0d47a1; color: white; padding: 5px; margin: 15px 0 10px 0; border-radius: 4px;}

        .student-info-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 1rem; margin-top: 15px; font-size: 13px;}
        .student-details { display: grid; grid-template-columns: 100px 1fr; gap: 4px 10px; align-items: center;}
        .student-details strong { text-align: left; font-weight: 500;}
        .student-profile-pic { width: 110px; height: 130px; object-fit: cover; border: 4px solid #dee2e6; border-radius: 8px; justify-self: center; }

        .section-title { font-size: 16px; font-weight: 700; color: #0d47a1; margin: 20px 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #e0e0e0; }
        
        table { width: 100%; border-collapse: collapse; font-size: 12px; }
        th, td { border: 1px solid #ccc; padding: 7px; text-align: center; }
        th { background-color: #f2f2f2; font-weight: 700; }
        td:first-child { text-align: left; font-weight: 500; }
        
        .summary-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-top: 20px;}
        .summary-box, .comments-box { border: 1px solid #ccc; border-radius: 5px; padding: 10px; font-size: 13px;}
        .summary-box h4 { margin: 0 0 10px 0; font-size: 14px; color: #0d47a1; border-bottom: 1px solid #eee; padding-bottom: 5px; }
        .summary-item { display: flex; justify-content: space-between; margin-bottom: 5px; }
        
        .comments-section p { margin: 5px 0; }
        .comments-section [contenteditable="true"] { background-color: #fffbe6; outline: 1px dashed #fd7e14; padding: 5px; border-radius: 4px; min-height: 40px;}

        .admin-controls { text-align: center; padding: 1rem; background-color: #f8f9fa; border-radius: 8px; margin-top: 2rem; }
        .hidden { display: none; }
        @media print {
            body { background-color: #fff; }
            .report-card-container { margin: 0; box-shadow: none; }
            .admin-controls { display: none; }
            .comments-section [contenteditable="true"] { background: transparent; outline: none; padding: 0; }
        }
    </style>
</head>
<body>
    <div id="loadingMessage" style="text-align: center; padding: 4rem; font-size: 1.2rem;">Loading Report Card...</div>
    <div id="errorMessage" class="hidden" style="background: #fff2f2; color: #d8000c; padding: 1rem; margin: 1rem auto; border: 1px solid #ffbaba; border-radius: 8px; max-width: 800px;"></div>

    <div class="report-card-container hidden" id="reportCardContent">
        <header class="report-header">
            <h1 class="school-name">SEALED NECTAR ACADEMY</h1>
            <p class="school-address">15, Nasirudeen Street, Off CDA Road, Off Ikola Road, Ota, Ogun State.</p>
            <h2 class="report-title">STUDENT'S PROGRESS REPORT</h2>
        </header>

        <section class="student-info-grid">
            <div class="student-details">
                <strong>Student Name:</strong> <span id="studentName"></span>
                <strong>Admission No:</strong> <span id="admissionNumber"></span>
                <strong>Class:</strong> <span id="studentClass"></span>
                <strong>Session:</strong> <span id="reportSession"></span>
                <strong>Term:</strong> <span id="reportTerm"></span>
                <strong>Date of Birth:</strong> <span id="studentDOB"></span>
            </div>
            <img id="studentProfilePic" src="" alt="Student Picture" class="student-profile-pic">
        </section>

        <div class="section-title">ACADEMIC PERFORMANCE (COGNITIVE DOMAIN)</div>
        <table class="cognitive-ratings">
            <thead>
                <tr>
                    <th rowspan="2">SUBJECTS</th>
                    <th rowspan="2">C.A (40)</th>
                    <th rowspan="2">EXAM (60)</th>
                    <th rowspan="2">TOTAL (100)</th>
                    <th colspan="3">TERM'S SUMMARY</th>
                    <th rowspan="2">CUM. AVG</th>
                    <th rowspan="2">GRADE</th>
                    <th rowspan="2">REMARK</th>
                </tr>
                <tr>
                    <th>1ST TERM</th>
                    <th>2ND TERM</th>
                    <th>3RD TERM</th>
                </tr>
            </thead>
            <tbody id="cognitiveRatingsBody"></tbody>
            <tfoot>
                <tr style="font-weight: 700; background-color: #f2f2f2;">
                    <td colspan="3">GRAND TOTAL:</td>
                    <td id="grandTotalScore"></td>
                    <td colspan="6"></td>
                </tr>
            </tfoot>
        </table>
        
        <div class="summary-grid">
             <div class="summary-box">
                <h4>PERFORMANCE SUMMARY</h4>
                <div class="summary-item"><strong>Total Score Obtained:</strong> <span id="totalScoreObtained"></span></div>
                <div class="summary-item"><strong>Total Score Obtainable:</strong> <span id="totalPossibleMarks"></span></div>
                <div class="summary-item"><strong>Overall Percentage:</strong> <span id="overallPercentage" style="font-weight:bold;"></span></div>
                <div class="summary-item"><strong>Position in Class:</strong> <span id="classPosition" style="font-weight:bold;"></span></div>
             </div>
             <div class="summary-box">
                <h4>GRADING KEY</h4>
                <div class="summary-item"><span>A* (90-100) - Distinction</span></div>
                <div class="summary-item"><span>A (80-89) - Excellent</span></div>
                <div class="summary-item"><span>B2 (75-79) - Very Good</span></div>
                <div class="summary-item"><span>B3 (70-74) - Good</span></div>
                <div class="summary-item"><span>C (60-69) - Credit</span></div>
                <div class="summary-item"><span>D (50-59) - Pass</span></div>
                <div class="summary-item"><span>F (0-49) - Fail</span></div>
             </div>
        </div>

        <div class="comments-section" style="margin-top: 15px;">
            <div class="section-title">COMMENTS & OTHER DETAILS</div>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; font-size: 13px;">
                <div><strong>Teacher's Comment:</strong><p id="teacherComment"></p></div>
                <div><strong>Principal's Comment:</strong><p id="principalComment"></p></div>
                <div><strong>Next Term Begins:</strong><p id="nextTermBegins"></p></div>
            </div>
        </div>

        <div class="admin-controls">
            <button id="editBtn" class="btn primary-btn">Enable Editing</button>
            <button id="saveBtn" class="btn success-btn hidden">Save Changes</button>
            <button onclick="window.print()" class="btn secondary-btn">Print Report</button>
        </div>
    </div>

<script>
    let reportData = {};
    const params = new URLSearchParams(window.location.search);
    const studentId = params.get('studentId');
    const term = params.get('term');
    const session = params.get('session');

    function toggleEdit(isEditing) {
        ['teacherComment', 'principalComment', 'nextTermBegins'].forEach(id => {
            const el = document.getElementById(id);
            el.contentEditable = isEditing;
            el.style.backgroundColor = isEditing ? '#fffbe6' : 'transparent';
            el.style.outline = isEditing ? '1px dashed #fd7e14' : 'none';
        });
        document.getElementById('editBtn').classList.toggle('hidden', isEditing);
        document.getElementById('saveBtn').classList.toggle('hidden', !isEditing);
    }

    async function saveReportData() {
        const cumulativeDataToSave = reportData.subjects.map(s => ({ subjectName: s.subjectName, finalScore: parseFloat(s.finalScore) }));
        const payload = {
            studentId, term: reportData.term, session: reportData.session,
            teacherComment: document.getElementById('teacherComment').textContent,
            principalComment: document.getElementById('principalComment').textContent,
            nextTermBegins: document.getElementById('nextTermBegins').textContent,
            classLevel: reportData.student.class_level,
            cumulativeData: JSON.stringify(cumulativeDataToSave)
        };

        try {
            const response = await fetch('/api/exam-results/report/meta', {
                method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
            });
            if (!response.ok) throw new Error('Failed to save data.');
            alert('Report data saved successfully!');
            toggleEdit(false);
        } catch (error) { alert(error.message); }
    }

    async function loadReport() {
        if (!studentId || !term || !session) {
            displayError('Student ID, Term, and Session are required to generate a report.');
            return;
        }

        try {
            const response = await fetch(`/api/exam-results/report/compile?studentId=${studentId}&term=${term}&session=${session}`);
            if (!response.ok) {
                const err = await response.json();
                throw new Error(err.error || "Failed to compile report data.");
            }
            reportData = await response.json();
            renderReport(reportData);

            document.getElementById('loadingMessage').classList.add('hidden');
            document.getElementById('reportCardContent').classList.remove('hidden');
        } catch (error) {
            displayError("Error: " + error.message);
        }
    }

    function renderReport(data) {
        // Populate student details
        document.getElementById('studentName').textContent = `${data.student.first_name} ${data.student.last_name}`;
        document.getElementById('admissionNumber').textContent = data.student.admission_number || 'N/A';
        document.getElementById('studentClass').textContent = data.student.class_level || 'N/A';
        document.getElementById('reportSession').textContent = data.session;
        document.getElementById('reportTerm').textContent = data.term;
        document.getElementById('studentDOB').textContent = data.student.dob ? new Date(data.student.dob).toLocaleDateString() : 'N/A';

        const profilePic = document.getElementById('studentProfilePic');
        profilePic.src = data.student.profile_picture_url || 'placeholder.png'; // Use a placeholder image

        // Populate the cognitive ratings table
        const tbody = document.getElementById('cognitiveRatingsBody');
        tbody.innerHTML = ''; 
        if(data.subjects && data.subjects.length > 0) {
            data.subjects.forEach(s => {
                tbody.innerHTML += `
                    <tr>
                        <td>${s.subjectName}</td>
                        <td>${s.ca_scaled}</td>
                        <td>${s.exam_scaled}</td>
                        <td><b>${s.finalScore}</b></td>
                        <td>${s.firstTerm}</td>
                        <td>${s.secondTerm}</td>
                        <td>${s.thirdTerm}</td>
                        <td>${s.cumulativeAvg}</td>
                        <td>${s.grade}</td>
                        <td>${s.remark}</td>
                    </tr>
                `;
            });
        } else {
             tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;">No subject results found for this student.</td></tr>`;
        }
        
        // Populate summary
        document.getElementById('grandTotalScore').textContent = data.summary.totalScoreObtained;
        document.getElementById('totalScoreObtained').textContent = data.summary.totalScoreObtained;
        document.getElementById('totalPossibleMarks').textContent = data.summary.totalPossibleMarks;
        document.getElementById('overallPercentage').textContent = `${data.summary.overallPercentage}%`;
        document.getElementById('classPosition').textContent = data.summary.position;

        // Populate editable meta fields
        document.getElementById('teacherComment').textContent = data.meta?.teacher_comment || '';
        document.getElementById('principalComment').textContent = data.meta?.principal_comment || '';
        document.getElementById('nextTermBegins').textContent = data.meta?.next_term_begins || 'TBA';
    }

    function displayError(message) {
        document.getElementById('loadingMessage').classList.add('hidden');
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
    }

    window.addEventListener('DOMContentLoaded', loadReport);
    document.getElementById('editBtn').addEventListener('click', () => toggleEdit(true));
    document.getElementById('saveBtn').addEventListener('click', saveReportData);
</script>
</body>
</html>