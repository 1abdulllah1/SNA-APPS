<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Student Progress Report</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            background-color: #e9ecef;
            font-family: 'Roboto', sans-serif;
            margin: 0;
            -webkit-print-color-adjust: exact;
        }
        .report-card-container {
            width: 210mm;
            min-height: 297mm;
            margin: 1.5rem auto;
            padding: 12mm;
            background: #fff;
            box-shadow: 0 0 25px rgba(0,0,0,0.15);
            color: #333;
        }
        .report-header {
            text-align: center;
            padding-bottom: 10px;
            border-bottom: 4px solid #0d47a1;
        }
        .school-logo { max-width: 90px; margin-bottom: 10px; }
        .school-name { font-size: 26px; font-weight: 700; color: #0d47a1; margin-bottom: 5px; }
        .school-address { font-size: 14px; color: #555; }
        .report-title { font-size: 24px; font-weight: 700; color: #333; margin-top: 20px; text-align: center;}
        .student-info, .summary-section, .comments-section, .signature-section {
            margin-top: 25px;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px 20px;
        }
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 10px;
        }
        .info-item p { margin: 5px 0; font-size: 15px; }
        .info-item strong { color: #0d47a1; }

        .section-title {
            font-size: 18px;
            font-weight: 700;
            color: #0d47a1;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 2px solid #e0e0e0;
        }
        .scores-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .scores-table th, .scores-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
            font-size: 14px;
        }
        .scores-table th {
            background-color: #f0f0f0;
            font-weight: 600;
            color: #333;
        }
        .summary-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .summary-table td {
            border: 1px solid #e0e0e0;
            padding: 8px 10px;
            font-size: 15px;
        }
        .summary-table td:first-child {
            font-weight: 500;
            color: #555;
        }
        .comments-section textarea {
            width: 100%;
            min-height: 80px;
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px;
            font-family: 'Roboto', sans-serif;
            font-size: 15px;
            resize: vertical;
        }
        .signature-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 40px;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px dashed #ccc;
        }
        .signature-item { text-align: center; }
        .signature-line {
            border-bottom: 1px solid #333;
            margin-top: 50px;
            padding-bottom: 5px;
            font-size: 14px;
            color: #555;
        }
        .actions-bar {
            text-align: center;
            margin: 20px auto;
            max-width: 210mm;
        }
        .actions-bar button {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1em;
        }
        .btn-edit { background-color: #ffc107; color: white; }
        .btn-save { background-color: #28a745; color: white; }
        .btn-print { background-color: #007bff; color: white; }
        .hidden { display: none; }

        @media print {
            .actions-bar, header, footer { display: none; }
            body { background-color: #fff; }
            .report-card-container {
                box-shadow: none;
                margin: 0;
                width: 100%;
                min-height: auto;
                padding: 0; /* Adjust padding for print if necessary */
            }
        }
        .loading-message, .error-message {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }
        .error-message {
            color: var(--danger-red);
            background-color: #ffebeb;
            border: 1px solid var(--danger-red);
            padding: 10px;
            border-radius: var(--border-radius-sm);
            margin-bottom: 1rem;
        }
        .profile-picture-display {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #0d47a1;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .student-profile-pic-container {
            text-align: center;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <header>
        <nav>
            <div class="logo">CBT System</div>
            <ul class="nav-links" id="navLinks">
                <li><a href="dashboard.html" class="nav-link">Dashboard</a></li>
                <li><a href="#" id="logoutLink" class="nav-link">Logout</a></li>
            </ul>
        </nav>
    </header>

    <div class="actions-bar">
        <button class="btn btn-edit" id="editBtn">Edit Report</button>
        <button class="btn btn-save hidden" id="saveBtn">Save Report</button>
        <button class="btn btn-print" onclick="window.print()">Print Report</button>
    </div>

    <main>
        <div class="report-card-container">
            <div id="loadingMessage" class="loading-message">Loading report...</div>
            <div id="errorMessage" class="error-message hidden"></div>
            <div id="reportContent" class="hidden">
                <div class="report-header">
                    <img src="https://via.placeholder.com/90x90.png?text=School+Logo" alt="School Logo" class="school-logo">
                    <h1 class="school-name">Sealed Nectar Academy</h1>
                    <p class="school-address">123 School Road, Knowledge City, State, Country</p>
                </div>

                <div class="student-profile-pic-container">
                    <img id="studentProfilePicture" class="profile-picture-display" src="https://res.cloudinary.com/your-cloud-name/image/upload/v1/profile_pictures/default-avatar.png" alt="Student Profile Picture">
                </div>

                <h2 class="report-title">Student Progress Report</h2>
                <h3 class="report-title" id="reportTerm"></h3>
                
                <div class="student-info">
                    <h3 class="section-title">Student Information</h3>
                    <div class="info-grid">
                        <div class="info-item"><p><strong>Name:</strong> <span id="studentFullName"></span></p></div>
                        <div class="info-item"><p><strong>Admission No:</strong> <span id="studentAdmissionNo"></span></p></div>
                        <div class="info-item"><p><strong>Class:</strong> <span id="studentClass"></span></p></div>
                        <div class="info-item"><p><strong>Academic Year:</strong> <span id="academicYear"></span></p></div>
                        <div class="info-item"><p><strong>Date Generated:</strong> <span id="dateGenerated"></span></p></div>
                    </div>
                </div>

                <div class="scores-section">
                    <h3 class="section-title">Subject Scores</h3>
                    <table class="scores-table">
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>Total Score</th>
                                <th>Score Obtained</th>
                                <th>Grade</th>
                                <th>Remarks</th>
                            </tr>
                        </thead>
                        <tbody id="subjectScoresBody">
                            </tbody>
                    </table>
                </div>

                <div class="summary-section">
                    <h3 class="section-title">Overall Summary</h3>
                    <table class="summary-table">
                        <tr>
                            <td>Grand Total Score:</td>
                            <td id="grandTotalScore"></td>
                        </tr>
                        <tr>
                            <td>Total Score Obtained:</td>
                            <td id="totalScoreObtained"></td>
                        </tr>
                        <tr>
                            <td>Total Possible Marks:</td>
                            <td id="totalPossibleMarks"></td>
                        </tr>
                        <tr>
                            <td>Overall Percentage:</td>
                            <td id="overallPercentage"></td>
                        </tr>
                        <tr>
                            <td>Class Position:</td>
                            <td id="classPosition"></td>
                        </tr>
                    </table>
                </div>

                <div class="comments-section">
                    <h3 class="section-title">Comments</h3>
                    <div>
                        <p><strong>Teacher's Comment:</strong></p>
                        <textarea id="teacherComment" rows="3" disabled></textarea>
                    </div>
                    <div style="margin-top: 15px;">
                        <p><strong>Principal's Comment:</strong></p>
                        <textarea id="principalComment" rows="3" disabled></textarea>
                    </div>
                </div>

                <div class="info-item" style="margin-top: 25px;">
                    <p><strong>Next Term Begins:</strong> <span id="nextTermBegins"></span></p>
                </div>

                <div class="signature-section">
                    <div class="signature-item">
                        <div class="signature-line">Teacher's Signature</div>
                    </div>
                    <div class="signature-item">
                        <div class="signature-line">Principal's Signature</div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <footer>
        <p>&copy; 2025 Sealed Nectar Academy. All rights reserved.</p>
    </footer>

<script>
    let currentReportData = null; // Store fetched report data
    let currentUser = null; // Store current user data

    async function loadUserData() {
        try {
            const response = await fetch('/api/users/me', { credentials: 'include' });
            if (!response.ok) {
                window.location.href = '/login.html';
                return null;
            }
            currentUser = await response.json();
            document.getElementById('navUsername').textContent = currentUser.username;
            createNavigationLinks(currentUser); // If you have this function for dynamic nav
            return currentUser;
        } catch (error) {
            console.error("Error loading user data for navigation:", error);
            window.location.href = '/login.html';
            return null;
        }
    }

    async function loadReport() {
        document.getElementById('loadingMessage').classList.remove('hidden');
        document.getElementById('errorMessage').classList.add('hidden');
        document.getElementById('reportContent').classList.add('hidden');
        document.getElementById('editBtn').classList.add('hidden'); // Hide edit button by default

        const urlParams = new URLSearchParams(window.location.search);
        const studentId = urlParams.get('studentId');
        const term = urlParams.get('term');
        const academicYear = urlParams.get('academicYear');

        if (!studentId || !term || !academicYear) {
            displayError('Missing student ID, term, or academic year parameters.');
            return;
        }

        try {
            const response = await fetch(`/api/report-cards/${studentId}?term=${term}&academicYear=${academicYear}`, { credentials: 'include' });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to fetch report card data.');
            }
            currentReportData = await response.json();
            displayReport(currentReportData);

            if (currentUser && (currentUser.is_admin || currentUser.role === 'teacher')) {
                document.getElementById('editBtn').classList.remove('hidden'); // Show edit button for admins/teachers
            }

        } catch (error) {
            displayError(`Error loading report: ${error.message}`);
            console.error("Load report error:", error);
        } finally {
            document.getElementById('loadingMessage').classList.add('hidden');
        }
    }

    function displayReport(data) {
        document.getElementById('reportContent').classList.remove('hidden');
        document.getElementById('studentFullName').textContent = data.student.full_name;
        document.getElementById('studentAdmissionNo').textContent = data.student.admission_number || 'N/A';
        document.getElementById('studentClass').textContent = data.student.class_id || 'N/A';
        document.getElementById('academicYear').textContent = data.academicYear;
        document.getElementById('reportTerm').textContent = `${data.term} Term Report`;
        document.getElementById('dateGenerated').textContent = new Date(data.dateGenerated).toLocaleDateString();

        // Display student profile picture
        const profilePicElement = document.getElementById('studentProfilePicture');
        if (data.student.profile_picture_url) {
            profilePicElement.src = data.student.profile_picture_url;
        } else {
            profilePicElement.src = 'https://res.cloudinary.com/your-cloud-name/image/upload/v1/profile_pictures/default-avatar.png'; // Default avatar
        }


        const subjectScoresBody = document.getElementById('subjectScoresBody');
        subjectScoresBody.innerHTML = '';
        if (data.subjects && data.subjects.length > 0) {
            data.subjects.forEach(subject => {
                const row = `
                    <tr>
                        <td>${subject.subject_name}</td>
                        <td>${subject.total_score}</td>
                        <td>${subject.score_obtained}</td>
                        <td>${subject.grade || 'N/A'}</td>
                        <td>${subject.remarks || 'N/A'}</td>
                    </tr>
                `;
                subjectScoresBody.innerHTML += row;
            });
        } else {
            subjectScoresBody.innerHTML = `<tr><td colspan="5" style="text-align: center;">No subject results found for this student.</td></tr>`;
        }
        
        // Populate summary
        document.getElementById('grandTotalScore').textContent = data.summary.totalScoreObtained;
        document.getElementById('totalScoreObtained').textContent = data.summary.totalScoreObtained;
        document.getElementById('totalPossibleMarks').textContent = data.summary.totalPossibleMarks;
        document.getElementById('overallPercentage').textContent = `${data.summary.overallPercentage}%`;
        document.getElementById('classPosition').textContent = data.summary.position;

        // Populate editable meta fields
        document.getElementById('teacherComment').value = data.meta?.teacher_comment || ''; // Use .value for textarea
        document.getElementById('principalComment').value = data.meta?.principal_comment || ''; // Use .value for textarea
        document.getElementById('nextTermBegins').textContent = data.meta?.next_term_begins || 'TBA';
    }

    function toggleEdit(isEditing) {
        document.getElementById('teacherComment').disabled = !isEditing;
        document.getElementById('principalComment').disabled = !isEditing;
        document.getElementById('editBtn').classList.toggle('hidden', isEditing);
        document.getElementById('saveBtn').classList.toggle('hidden', !isEditing);
    }

    async function saveReportData() {
        if (!currentReportData || !currentUser || !(currentUser.is_admin || currentUser.role === 'teacher')) {
            alert('You do not have permission to save this report.');
            return;
        }

        const studentId = currentReportData.student.id;
        const term = currentReportData.term;
        const academicYear = currentReportData.academicYear;
        const teacherComment = document.getElementById('teacherComment').value;
        const principalComment = document.getElementById('principalComment').value;

        try {
            const response = await fetch(`/api/report-cards/${studentId}/meta`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    term,
                    academicYear,
                    teacher_comment: teacherComment,
                    principal_comment: principalComment
                }),
                credentials: 'include'
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.error || 'Failed to save report comments.');
            }
            alert('Report comments saved successfully!');
            toggleEdit(false); // Switch back to view mode
            // Optionally, re-load the report to ensure data consistency
            await loadReport();

        } catch (error) {
            alert('Error saving report: ' + error.message);
            console.error('Save report error:', error);
        }
    }

    function displayError(message) {
        document.getElementById('loadingMessage').classList.add('hidden');
        const errorDiv = document.getElementById('errorMessage');
        errorDiv.textContent = message;
        errorDiv.classList.remove('hidden');
    }

    window.addEventListener('DOMContentLoaded', async () => {
        await loadUserData(); // Load user data for navigation and permissions
        if (currentUser) { // Only attempt to load report if user data is successfully loaded
            loadReport();
        }
    });

    document.getElementById('editBtn').addEventListener('click', () => toggleEdit(true));
    document.getElementById('saveBtn').addEventListener('click', saveReportData);

    // This function is assumed to be in auth.js or common.js
    function createNavigationLinks(user) {
        const navLinksContainer = document.getElementById('navLinks');
        // Clear existing links except logout
        navLinksContainer.innerHTML = '<li><a href="#" id="logoutLink" class="nav-link">Logout</a></li>'; 

        const dashboardLink = document.createElement('a');
        dashboardLink.href = 'dashboard.html'; dashboardLink.textContent = 'Dashboard';
        dashboardLink.classList.add('nav-link'); navLinksContainer.prepend(dashboardLink);

        if (user.is_admin || user.role === 'teacher') {
            const createExamLink = document.createElement('a');
            createExamLink.href = 'create-exam.html'; createExamLink.textContent = 'Create Exam';
            createExamLink.classList.add('nav-link');
            navLinksContainer.insertBefore(createExamLink, document.getElementById('logoutLink'));
        }
        if (user.is_admin) {
            const manageUsersLink = document.createElement('a');
            manageUsersLink.href = 'manage-users.html'; manageUsersLink.textContent = 'Manage Users';
            manageUsersLink.classList.add('nav-link');
            navLinksContainer.insertBefore(manageUsersLink, document.getElementById('logoutLink'));

            const registerLink = document.createElement('a');
            registerLink.href = 'registration.html'; registerLink.textContent = 'Register User';
            registerLink.classList.add('nav-link');
            navLinksContainer.insertBefore(registerLink, document.getElementById('logoutLink'));
            
            const reportsLink = document.createElement('a');
            reportsLink.href = 'admin-reports.html'; reportsLink.textContent = 'Student Reports';
            reportsLink.classList.add('nav-link');
            navLinksContainer.insertBefore(reportsLink, document.getElementById('logoutLink'));
        }
    }
</script>
</body>
</html>