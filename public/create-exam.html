<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Create Exam | CBT System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f4f7f6; }
    .btn { padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s ease; }
    .btn-primary { background-color: #1a237e; color: white; }
    .btn-secondary { background-color: #6c757d; color: white; }
    .btn-danger { background-color: #dc3545; color: white; }
    .btn-info { background-color: #17a2b8; color: white; }
    .section-card, .question-card { background: #fdfdff; border: 1px solid #e0e0e0; border-radius: 10px; padding: 1.5rem; margin-bottom: 1.5rem; }
    .message { padding: 10px 15px; border-radius: 8px; margin-bottom: 1rem; text-align: center; }
    .success-message { background-color: #d4edda; color: #155724; }
    .error-message { background-color: #f8d7da; color: #721c24; }
    .hidden { display: none; }
  </style>
</head>
<body>
  <header class="bg-white shadow-sm sticky top-0 z-50">
    <nav class="container mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">
            <div class="flex-shrink-0">
                <a href="/dashboard.html" class="text-2xl font-bold text-indigo-600">SNA CBT System</a>
            </div>
            <div class="hidden md:block">
                <ul class="ml-10 flex items-center space-x-4" id="navLinks"></ul>
            </div>
            <div class="md:hidden">
                <button id="mobile-menu-button" class="p-2 rounded-md text-gray-400 hover:text-gray-500 focus:outline-none">
                    <i data-feather="menu"></i>
                </button>
            </div>
        </div>
    </nav>
    <div class="md:hidden hidden" id="mobile-menu">
        <ul class="px-2 pt-2 pb-3 space-y-1 sm:px-3" id="mobileNavLinks"></ul>
    </div>
  </header>

  <main class="max-w-4xl mx-auto p-4 md:p-8">
    <div id="pageMessage" class="message hidden"></div>
    <h1 class="text-3xl font-bold text-gray-900 mb-6">Create New Exam</h1>
    <form id="examForm" class="space-y-6 bg-white p-8 rounded-lg shadow-md">
      
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="examTitle" class="block text-sm font-medium text-gray-700">Exam Title:</label>
          <input type="text" id="examTitle" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
        </div>
        <div>
          <label for="examType" class="block text-sm font-medium text-gray-700">Exam Type:</label>
          <select id="examType" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
            <option value="">Select Type</option>
            <option value="MAIN_EXAM">Main Exam</option>
            <option value="CA1">CA 1</option><option value="CA2">CA 2</option><option value="CA3">CA 3</option><option value="CA4">CA 4</option>
            <option value="MID_TERM">Mid Term</option><option value="OTHER">Other</option>
          </select>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="classLevel" class="block text-sm font-medium text-gray-700">Class Level:</label>
          <select id="classLevel" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select>
        </div>
        <div>
          <label for="subject" class="block text-sm font-medium text-gray-700">Subject:</label>
          <select id="subject" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required></select>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div>
          <label for="duration" class="block text-sm font-medium text-gray-700">Duration (minutes):</label>
          <input type="number" id="duration" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
        </div>
        <div>
          <label for="passMark" class="block text-sm font-medium text-gray-700">Pass Mark (%):</label>
          <input type="number" id="passMark" min="0" max="100" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
        </div>
        <div>
          <label for="maxScore" class="block text-sm font-medium text-gray-700">Max Score:</label>
          <input type="number" id="maxScore" min="1" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="term" class="block text-sm font-medium text-gray-700">Term:</label>
          <select id="term" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
            <option value="">Select Term</option>
            <option value="FIRST">First Term</option><option value="SECOND">Second Term</option><option value="THIRD">Third Term</option>
          </select>
        </div>
        <div>
          <label for="session" class="block text-sm font-medium text-gray-700">Academic Session (YYYY-YYYY):</label>
          <input type="text" id="session" pattern="\d{4}-\d{4}" placeholder="e.g., 2023-2024" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm" required>
        </div>
      </div>

      <!-- FIXED: Replaced scheduledTime with startTime and endTime -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
            <label for="startTime" class="block text-sm font-medium text-gray-700">Start Time (Optional):</label>
            <input type="datetime-local" id="startTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
        </div>
        <div>
            <label for="endTime" class="block text-sm font-medium text-gray-700">End Time (Optional):</label>
            <input type="datetime-local" id="endTime" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
        </div>
      </div>

      <div class="flex items-center">
        <input type="checkbox" id="isLocked" class="rounded text-indigo-600">
        <label for="isLocked" class="ml-2 block text-sm text-gray-900">Lock Exam</label>
      </div>

      <hr>

      <h2 class="text-2xl font-bold text-gray-900">Exam Sections & Questions</h2>
      <div id="sectionsContainer" class="space-y-6"></div>
      <button type="button" id="addSectionBtn" class="btn btn-secondary"><i data-feather="plus" class="w-4 h-4 mr-2"></i>Add Section</button>

      <div class="flex justify-end pt-4">
        <button type="submit" class="btn btn-primary"><i data-feather="save" class="w-4 h-4 mr-2"></i>Create Exam</button>
      </div>
    </form>
  </main>

  <script src="https://unpkg.com/feather-icons"></script>
  <script>
    feather.replace();
    let currentUser = null;
    let sectionCounter = 0;
    let questionCounter = 0;

    function showPageMessage(message, type = 'info') {
        const messageDiv = document.getElementById('pageMessage');
        messageDiv.textContent = message;
        messageDiv.className = `message ${type}-message`;
        messageDiv.classList.remove('hidden');
        setTimeout(() => messageDiv.classList.add('hidden'), 5000);
    }

    async function fetchApi(url, options = {}) {
        try {
            const response = await fetch(url, { credentials: 'include', ...options });
            const data = await response.json();
            if (!response.ok) throw new Error(data.error || 'API request failed.');
            return data;
        } catch (error) {
            console.error(`Error fetching ${url}:`, error);
            showPageMessage(error.message, 'error');
            return null;
        }
    }
    
    // --- Data Collection ---
    function collectExamData() {
      // FIXED: Collect start_time and end_time instead of scheduled_time
      const startTimeVal = document.getElementById('startTime').value;
      const endTimeVal = document.getElementById('endTime').value;

      const sections = Array.from(document.querySelectorAll('.section-card')).map(sectionCard => {
        const questions = Array.from(sectionCard.querySelectorAll('.question-card')).map(questionCard => ({
          question_text: questionCard.querySelector('[id^="questionText-"]').value,
          options: {
            A: questionCard.querySelector('[id^="optionA-"]').value,
            B: questionCard.querySelector('[id^="optionB-"]').value,
            C: questionCard.querySelector('[id^="optionC-"]').value,
            D: questionCard.querySelector('[id^="optionD-"]').value,
          },
          correct_answer: questionCard.querySelector('[id^="correctAnswer-"]').value,
          explanation: questionCard.querySelector('[id^="explanation-"]').value,
        }));
        return {
          section_name: sectionCard.querySelector('input[type="text"]').value,
          section_instructions: sectionCard.querySelector('textarea').value,
          section_order: parseInt(sectionCard.dataset.sectionOrder),
          questions: questions
        };
      });

      return {
        title: document.getElementById('examTitle').value,
        subject_id: parseInt(document.getElementById('subject').value),
        class_level_id: parseInt(document.getElementById('classLevel').value),
        exam_type: document.getElementById('examType').value,
        duration_minutes: parseInt(document.getElementById('duration').value),
        pass_mark: parseInt(document.getElementById('passMark').value),
        max_score: parseInt(document.getElementById('maxScore').value),
        term: document.getElementById('term').value,
        session: document.getElementById('session').value.replace('-', '/'),
        start_time: startTimeVal ? new Date(startTimeVal).toISOString() : null,
        end_time: endTimeVal ? new Date(endTimeVal).toISOString() : null,
        is_locked: document.getElementById('isLocked').checked,
        sections: sections
      };
    }

    // --- Dynamic Form Element Functions ---
    function addSection(sectionData = null) {
      sectionCounter++;
      const sectionId = `section-${sectionCounter}`;
      const sectionsContainer = document.getElementById('sectionsContainer');
      const sectionCard = document.createElement('div');
      sectionCard.className = 'section-card';
      sectionCard.id = sectionId;
      sectionCard.dataset.sectionOrder = sectionCounter;
      sectionCard.innerHTML = `
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-xl font-semibold">Section ${sectionCounter}</h3>
            <button type="button" class="btn btn-danger btn-sm remove-section-btn" data-section-id="${sectionId}"><i data-feather="x-circle" class="w-4 h-4"></i></button>
        </div>
        <div class="form-group"><label for="sectionName-${sectionId}">Section Name:</label><input type="text" id="sectionName-${sectionId}" class="mt-1 block w-full rounded-md border-gray-300" value="${sectionData ? sectionData.section_name : ''}" required></div>
        <div class="form-group"><label for="sectionInstructions-${sectionId}">Instructions:</label><textarea id="sectionInstructions-${sectionId}" rows="2" class="mt-1 block w-full rounded-md border-gray-300">${sectionData ? sectionData.section_instructions : ''}</textarea></div>
        <hr class="my-4"><h4 class="text-lg font-semibold mb-3">Questions</h4>
        <div id="questionsContainer-${sectionId}" class="space-y-4"></div>
        <button type="button" class="btn btn-info add-question-btn mt-4" data-section-id="${sectionId}"><i data-feather="plus" class="w-4 h-4 mr-2"></i>Add Question</button>`;
      sectionsContainer.appendChild(sectionCard);
      sectionCard.querySelector('.remove-section-btn').addEventListener('click', (e) => removeSection(e.currentTarget.dataset.sectionId));
      sectionCard.querySelector('.add-question-btn').addEventListener('click', (e) => addQuestion(e.currentTarget.dataset.sectionId));
      if (sectionData && sectionData.questions) {
        sectionData.questions.forEach(q => addQuestion(sectionId, q));
      } else {
        addQuestion(sectionId);
      }
      feather.replace();
    }
    function addQuestion(sectionId, questionData = null) {
      questionCounter++;
      const qUniqueId = `q-${sectionId}-${questionCounter}`;
      const questionsContainer = document.getElementById(`questionsContainer-${sectionId}`);
      const questionCard = document.createElement('div');
      questionCard.className = 'question-card p-4';
      questionCard.id = qUniqueId;
      questionCard.innerHTML = `
        <div class="flex justify-between items-center mb-3"><h5 class="font-medium">Question</h5><button type="button" class="btn btn-danger btn-sm remove-question-btn" data-question-id="${qUniqueId}"><i data-feather="x" class="w-4 h-4"></i></button></div>
        <div class="form-group"><label for="questionText-${qUniqueId}">Question Text:</label><textarea id="questionText-${qUniqueId}" rows="2" class="mt-1 block w-full rounded-md border-gray-300" required>${questionData ? questionData.question_text : ''}</textarea></div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="form-group"><label for="optionA-${qUniqueId}">Option A:</label><input type="text" id="optionA-${qUniqueId}" class="mt-1 block w-full rounded-md border-gray-300" value="${questionData?.options?.A || ''}" required></div>
            <div class="form-group"><label for="optionB-${qUniqueId}">Option B:</label><input type="text" id="optionB-${qUniqueId}" class="mt-1 block w-full rounded-md border-gray-300" value="${questionData?.options?.B || ''}" required></div>
            <div class="form-group"><label for="optionC-${qUniqueId}">Option C:</label><input type="text" id="optionC-${qUniqueId}" class="mt-1 block w-full rounded-md border-gray-300" value="${questionData?.options?.C || ''}" required></div>
            <div class="form-group"><label for="optionD-${qUniqueId}">Option D:</label><input type="text" id="optionD-${qUniqueId}" class="mt-1 block w-full rounded-md border-gray-300" value="${questionData?.options?.D || ''}" required></div>
        </div>
        <div class="form-group"><label for="correctAnswer-${qUniqueId}">Correct Answer:</label><select id="correctAnswer-${qUniqueId}" class="mt-1 block w-full rounded-md border-gray-300" required><option value="">Select</option><option value="A">A</option><option value="B">B</option><option value="C">C</option><option value="D">D</option></select></div>
        <div class="form-group"><label for="explanation-${qUniqueId}">Explanation (Optional):</label><textarea id="explanation-${qUniqueId}" rows="2" class="mt-1 block w-full rounded-md border-gray-300">${questionData ? questionData.explanation : ''}</textarea></div>`;
      questionsContainer.appendChild(questionCard);
      if (questionData?.correct_answer) questionCard.querySelector(`#correctAnswer-${qUniqueId}`).value = questionData.correct_answer;
      questionCard.querySelector('.remove-question-btn').addEventListener('click', (e) => removeQuestion(e.currentTarget.dataset.questionId));
      feather.replace();
    }
    function removeSection(sectionId) { document.getElementById(sectionId).remove(); }
    function removeQuestion(questionId) { document.getElementById(questionId).remove(); }

    // --- Initialization and Event Handlers ---
    async function initPage() {
        currentUser = await fetchApi('/api/users/me');
        if (!currentUser || (!currentUser.is_admin && currentUser.role !== 'teacher')) {
            document.querySelector('main').innerHTML = '<h1 class="text-center text-red-600">Access Denied</h1>';
            return;
        }
        // Populate nav links etc. (assuming function exists)

        const classLevels = await fetchApi('/api/exams/config/class-levels');
        const classLevelSelect = document.getElementById('classLevel');
        classLevelSelect.innerHTML = '<option value="">Select Class Level</option>';
        classLevels.forEach(level => classLevelSelect.innerHTML += `<option value="${level.level_id}">${level.level_name}</option>`);

        const subjectSelect = document.getElementById('subject');
        const fetchSubjects = async (classLevelId) => {
            const subjects = await fetchApi(`/api/exams/config/subjects?class_level_id=${classLevelId}`);
            subjectSelect.innerHTML = '<option value="">Select Subject</option>';
            if (subjects) subjects.forEach(subject => subjectSelect.innerHTML += `<option value="${subject.subject_id}">${subject.name}</option>`);
        };
        classLevelSelect.addEventListener('change', () => fetchSubjects(classLevelSelect.value));
        fetchSubjects(''); // Load all initially

        addSection(); // Start with one section
    }

    document.getElementById('addSectionBtn').addEventListener('click', () => addSection());
    document.getElementById('examForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitButton = e.submitter;
      submitButton.disabled = true;
      submitButton.innerHTML = 'Creating...';
      try {
        const examData = collectExamData();
        // Add validation here if needed
        const result = await fetchApi('/api/exams', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(examData),
        });
        if (result) {
          showPageMessage('Exam created successfully!', 'success');
          document.getElementById('examForm').reset();
          document.getElementById('sectionsContainer').innerHTML = '';
          addSection();
        }
      } catch (error) {
        // fetchApi already shows message
      } finally {
        submitButton.disabled = false;
        submitButton.innerHTML = '<i data-feather="save" class="w-4 h-4 mr-2"></i>Create Exam';
        feather.replace();
      }
    });

    window.addEventListener('DOMContentLoaded', initPage);
  </script>
</body>
</html>
